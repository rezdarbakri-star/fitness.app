<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#1a1a1a">
  <meta name="description" content="FitByYou ‚Äî Din personliga tr√§ningsapp">
  <title>FitByYou</title>
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="icon-192.png">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body, #root { 
      width: 100%; min-height: 100vh; 
      background: #1a1a1a; color: #f0f0f0;
      font-family: -apple-system, 'Helvetica Neue', Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -webkit-tap-highlight-color: transparent;
      overscroll-behavior: none;
    }
    body { max-width: 430px; margin: 0 auto; }
    /* Prevent pull-to-refresh on mobile */
    body { overflow-y: scroll; }
    input, button, select, textarea { font-family: inherit; }
  </style>
</head>
<body>
  <div id="root"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.9/babel.min.js"></script>
  <script type="text/babel">
const { useState, useCallback, useRef, useEffect } = React;

const T = {
  bg:"#1a1a1a",s1:"rgba(255,255,255,0.04)",s2:"rgba(255,255,255,0.06)",
  brd:"rgba(255,255,255,0.08)",brdH:"rgba(255,255,255,0.25)",
  acc:"#39ff14",accD:"rgba(57,255,20,0.06)",accB:"rgba(57,255,20,0.10)",
  t:"#f0f0f0",dim:"rgba(255,255,255,0.6)",mut:"rgba(255,255,255,0.35)",
  grn:"#22c55e",yel:"#f59e0b",red:"#ef4444",blu:"#3b82f6",
  pur:"#a78bfa",cyn:"#06b6d4",pnk:"#ec4899",org:"#fb923c",
  f:"'Inter','Helvetica Neue','Arial',sans-serif",mono:"'Inter','Helvetica Neue',sans-serif",r:14,
};
const MC={Brost:T.red,Rygg:T.blu,Axlar:T.yel,Ben:T.grn,Biceps:T.pur,Triceps:T.pnk,Mage:T.cyn};

const EX_DB = [
  {name:"Bankpress",muscle:"Brost"},{name:"Hantelpress lutande",muscle:"Brost"},
  {name:"Cable Fly",muscle:"Brost"},{name:"Dips",muscle:"Brost"},
  {name:"Maskin Brostpress",muscle:"Brost"},{name:"Marklyft",muscle:"Rygg"},
  {name:"Skivstangsrodd",muscle:"Rygg"},{name:"Latsdrag",muscle:"Rygg"},
  {name:"Sittande kabelrodd",muscle:"Rygg"},{name:"Chins",muscle:"Rygg"},
  {name:"Face Pull",muscle:"Axlar"},{name:"Militarpress",muscle:"Axlar"},
  {name:"Sidolyft",muscle:"Axlar"},{name:"Rear Delt Fly",muscle:"Axlar"},
  {name:"Knaboej",muscle:"Ben"},{name:"Benpress",muscle:"Ben"},
  {name:"Rumansk marklyft",muscle:"Ben"},{name:"Bencurl",muscle:"Ben"},
  {name:"Benextension",muscle:"Ben"},{name:"Utfall",muscle:"Ben"},
  {name:"Vadpress",muscle:"Ben"},{name:"Hip Thrust",muscle:"Ben"},
  {name:"Skivstangscurl",muscle:"Biceps"},{name:"Hammarcurl",muscle:"Biceps"},
  {name:"Koncentrationscurl",muscle:"Biceps"},{name:"Kabelcurl",muscle:"Biceps"},
  {name:"Tricep Pushdown",muscle:"Triceps"},{name:"Skullcrusher",muscle:"Triceps"},
  {name:"Overhead Tricep Extension",muscle:"Triceps"},{name:"Dips smal",muscle:"Triceps"},
  {name:"Cable Crunch",muscle:"Mage"},{name:"Hanging Leg Raise",muscle:"Mage"},
  {name:"Russian Twist",muscle:"Mage"},{name:"Planka",muscle:"Mage"},
  {name:"Ab Wheel Rollout",muscle:"Mage"},{name:"Woodchop",muscle:"Mage"},
];
const MUSCLES=["Alla","Brost","Rygg","Axlar","Ben","Biceps","Triceps","Mage"];

// Exercise images ‚Äî filename map. In production: hosted CDN URLs
// In sandbox: external images blocked, falls back to gradient+emoji
const EX_IMG = {
  "Hip Thrust":"./img/female_barbell_hip_thrusts.png",
  "Knaboej":"./img/female_barbell_squats.png",
  "Benpress":"./img/female_barbell_leg_press.png",
  "Latsdrag":"./img/female_wide_grip_lat_pulldowns_back.png",
  "Maskin Brostpress":"./img/female_machine_chest_press.png",
  "Sidolyft":"./img/female_dumbbell_side_raises.png",
};
// Crop positions per exercise for consistent thumbnails
const EX_CROP = {
  "Hip Thrust":"center 55%",
  "Knaboej":"center 25%",
  "Benpress":"center 30%",
  "Latsdrag":"center 20%",
  "Maskin Brostpress":"center 25%",
  "Sidolyft":"center 20%",
};

// Exercise metadata: descriptions + tips for popup. Images added later per gender.
const EX_DATA = {
  "Hip Thrust":{desc:"Rygg mot b√§nk, st√•ng √∂ver h√∂ften. Pressa h√∂ften upp√•t tills kroppen bildar en rak linje fr√•n axlar till kn√§n.",tip:"Kl√§m ihop rumpan h√•rt i toppen ‚Äî h√•ll 1 sek. Hakan mot br√∂stet. Driv genom h√§larna.",img:"./img/female_barbell_hip_thrusts.png",crop:"center 60%"},
  "Knaboej":{desc:"St√•ng p√• √∂vre ryggen, f√∂tter axelbrett. S√§nk h√∂ften tills l√•ren √§r parallella med golvet.",tip:"Kn√§na f√∂ljer t√•rnas riktning. Br√∂st upp, blick fram√•t. Driv upp genom h√§larna.",img:"./img/female_barbell_squats.png",crop:"center 30%"},
  "Utfall":{desc:"St√• uppr√§tt med hantlar i h√§nderna. Ta ett l√•ngt steg fram√•t och s√§nk bakre kn√§t mot golvet.",tip:"Framkn√§ bakom t√•rna. Driv upp med fr√§mre h√§len. H√•ll √∂verkroppen rak.",img:"./img/female_lunges.png",crop:"center 20%"},
  "Benpress":{desc:"F√∂tter axelbrett i maskinen. Pressa upp vikten tills benen √§r n√§stan raka.",tip:"L√•s inte kn√§na i toppen. S√§nk kontrollerat tills 90¬∞ i kn√§na."},
  "Bencurl":{desc:"Sittande i maskin, curl benen bak√•t mot rumpan.",tip:"Kontrollerad r√∂relse hela v√§gen. Kl√§m hamstrings i botten."},
  "Benextension":{desc:"Sittande, str√§ck ut benen i maskinen tills raka.",tip:"Pausa 1 sek i toppen. S√§nk l√•ngsamt tillbaka."},
  "Vadpress":{desc:"T√•spetsar p√• benpressen, pressa med vaderna.",tip:"Full r√∂relseomf√•ng ‚Äî hela v√§gen ner och upp."},
  "Rumansk marklyft":{desc:"St√•ende, f√§ll fram√•t i h√∂ften med st√•ng till smalben.",tip:"Rak rygg hela tiden. K√§nn stretch i hamstrings. Mjuka kn√§n."},
  "Latsdrag":{desc:"Sittande vid latsdragmaskin. Grip st√•ngen brett och drag ner mot √∂vre br√∂stet.",tip:"Drag med armb√•garna, inte h√§nderna. L√§tt bak√•tlut. Kl√§m skulderbladen.",img:"./img/female_wide_grip_lat_pulldowns_back.png",crop:"center 20%"},
  "Maskin Brostpress":{desc:"Sitt i maskinen med rygg mot st√∂det. Pressa handtagen fram√•t.",tip:"H√•ll axlarna nere och ihoppressade. Andas ut vid press.",img:"./img/female_machine_chest_press.png",crop:"center 30%"},
  "Sittande kabelrodd":{desc:"Sitt med rakt grepp, drag handtaget mot magen.",tip:"H√•ll ryggen rak. Press ihop skulderbladen i slutet."},
  "Sidolyft":{desc:"St√•ende med hantlar vid sidorna. Lyft √•t sidorna till axelh√∂jd.",tip:"T√§nk: h√§ll ut vattnet ur glasen. L√§tt vikt, kontrollerad r√∂relse.",img:"./img/female_dumbbell_side_raises.png",crop:"center 25%"},
  "Tricep Pushdown":{desc:"St√•ende vid kabel, pressa handtaget ned√•t.",tip:"Armb√•gar t√§tt mot kroppen. Str√§ck ut helt i botten."},
  "Kabelcurl":{desc:"St√•ende vid kabel, curl repet upp√•t.",tip:"Konstant motst√•nd hela v√§gen. Kl√§m i toppen."},
  "Cable Fly":{desc:"St√• mellan kablar, f√∂r h√§nderna samman framf√∂r br√∂stet.",tip:"L√§tt b√∂j i armb√•garna. K√§nn stretch i br√∂stet."},
  "Cable Crunch":{desc:"Kn√§a vid kabel, crunch ned√•t med repet bakom huvudet.",tip:"Rund ryggen fram√•t, b√∂j inte i h√∂ften."},
  "Hanging Leg Raise":{desc:"H√§ng i st√•ng, lyft raka ben till 90¬∞.",tip:"B√∂rja med b√∂jda kn√§n om det √§r tungt. Ingen sving."},
  "Bankpress":{desc:"Liggande p√• b√§nk, pressa st√•ng upp√•t fr√•n br√∂stet.",tip:"Armb√•gar 45¬∞. F√∂tter i golvet. Kontrollerad r√∂relse."},
  "Hantelpress lutande":{desc:"Lutande b√§nk, pressa hantlar upp√•t.",tip:"S√§nk till 90¬∞ i armb√•garna. Press ihop i toppen."},
  "Dips":{desc:"Handtag, s√§nk kroppen tills armb√•garna √§r 90¬∞.",tip:"Luta fram√•t f√∂r br√∂stfokus. Rakt = triceps."},
  "Marklyft":{desc:"B√∂j dig ner, grip st√•ngen, driv upp med benen.",tip:"Rak rygg. St√•ngen t√§tt mot kroppen hela v√§gen."},
  "Skivstangsrodd":{desc:"Fram√•tlutad, drag st√•ng mot magen.",tip:"Kl√§m skulderbladen i toppen. Stabil core."},
  "Chins":{desc:"Underhandsgrepp, drag dig upp tills hakan passerar st√•ngen.",tip:"Full r√∂relse ner. Kontrollerat."},
  "Face Pull":{desc:"Kabel i ansiktsh√∂jd, drag mot ansiktet med rep.",tip:"Armb√•gar h√∂gt. Extern rotation i slutet."},
  "Militarpress":{desc:"St√•ende, pressa st√•ng rakt upp√•t fr√•n axlarna.",tip:"Sp√§nn core. St√•ngen n√§ra ansiktet p√• v√§g upp."},
  "Rear Delt Fly":{desc:"Fram√•tlutad, lyft hantlar √•t sidorna.",tip:"Pinky upp. L√§tt i vikten. K√§nn bakre axeln."},
  "Skivstangscurl":{desc:"St√•ende, curl st√•ng fr√•n l√•r till axlar.",tip:"Armb√•gar stilla. Ingen sving med kroppen."},
  "Hammarcurl":{desc:"Hantlar med neutralt grepp, curl upp√•t.",tip:"Tummarna pekar upp. Kontrollerad r√∂relse."},
  "Koncentrationscurl":{desc:"Sittande, armb√•ge mot insida l√•r, curl.",tip:"Isolera biceps helt. L√•ngsam negativ."},
  "Skullcrusher":{desc:"Liggande p√• b√§nk, s√§nk st√•ng mot pannan.",tip:"Bara underarmarna r√∂r sig. Armb√•gar pekar rakt upp."},
  "Overhead Tricep Extension":{desc:"St√•ende, s√§nk hantel bakom huvudet.",tip:"Armb√•gar pekar fram√•t. Full stretch i botten."},
  "Dips smal":{desc:"Smalt grepp, s√§nk kroppen med armb√•gar bak√•t.",tip:"Rak kropp = mer triceps. Hela v√§gen ner."},
  "Russian Twist":{desc:"Sittande, rotera √∂verkroppen sida till sida.",tip:"Luta bak√•t 45¬∞. Lyft f√∂tterna f√∂r sv√•rare."},
  "Planka":{desc:"Armb√•gar och t√•r i golvet, rak linje.",tip:"Sp√§nn rumpan och magen. Blick i golvet."},
  "Ab Wheel Rollout":{desc:"Kn√§a, rulla hjulet fram√•t, dra tillbaka.",tip:"Sp√§nn core hela tiden. G√• inte f√∂r l√•ngt i b√∂rjan."},
  "Woodchop":{desc:"Kabel, drag diagonalt fr√•n h√∂g till l√•g.",tip:"Rotera i h√∂ften, inte ryggen."},
};

const INIT_TPLS = [
  {id:"s1",name:"PPL Standard",split:"3D",cat:"Standardmallar",used:0,days:[
    {name:"Push",ex:[{n:"Bankpress",s:3,r:"10-12",m:"Brost"},{n:"Maskin Brostpress",s:3,r:"12-15",m:"Brost"},{n:"Militarpress",s:3,r:"10-12",m:"Axlar"},{n:"Sidolyft",s:3,r:"15",m:"Axlar"},{n:"Tricep Pushdown",s:3,r:"12-15",m:"Triceps"}]},
    {name:"Pull",ex:[{n:"Latsdrag",s:3,r:"10-12",m:"Rygg"},{n:"Sittande kabelrodd",s:3,r:"12",m:"Rygg"},{n:"Face Pull",s:3,r:"15",m:"Axlar"},{n:"Skivstangscurl",s:3,r:"12",m:"Biceps"},{n:"Hammarcurl",s:2,r:"12",m:"Biceps"}]},
    {name:"Ben",ex:[{n:"Knaboej",s:3,r:"10-12",m:"Ben"},{n:"Rumansk marklyft",s:3,r:"10-12",m:"Ben"},{n:"Benpress",s:3,r:"12-15",m:"Ben"},{n:"Bencurl",s:3,r:"12",m:"Ben"},{n:"Vadpress",s:3,r:"15-20",m:"Ben"}]}
  ]},
  {id:"s2",name:"PPL Bygg",split:"3D",cat:"Standardmallar",used:0,days:[
    {name:"Push",ex:[{n:"Bankpress",s:4,r:"6-8",m:"Brost"},{n:"Hantelpress lutande",s:3,r:"10-12",m:"Brost"},{n:"Militarpress",s:3,r:"8-10",m:"Axlar"},{n:"Sidolyft",s:3,r:"15",m:"Axlar"},{n:"Tricep Pushdown",s:3,r:"12-15",m:"Triceps"}]},
    {name:"Pull",ex:[{n:"Marklyft",s:4,r:"5-6",m:"Rygg"},{n:"Skivstangsrodd",s:4,r:"8-10",m:"Rygg"},{n:"Latsdrag",s:3,r:"10-12",m:"Rygg"},{n:"Face Pull",s:3,r:"15",m:"Axlar"},{n:"Skivstangscurl",s:3,r:"10-12",m:"Biceps"}]},
    {name:"Ben",ex:[{n:"Knaboej",s:4,r:"6-8",m:"Ben"},{n:"Rumansk marklyft",s:3,r:"10-12",m:"Ben"},{n:"Benpress",s:3,r:"12-15",m:"Ben"},{n:"Bencurl",s:3,r:"12",m:"Ben"},{n:"Vadpress",s:4,r:"15-20",m:"Ben"}]}
  ]},
  {id:"s3",name:"OK/UK Standard",split:"4D",cat:"Standardmallar",used:0,days:[
    {name:"Overkropp A",ex:[{n:"Bankpress",s:3,r:"10-12",m:"Brost"},{n:"Skivstangsrodd",s:3,r:"10-12",m:"Rygg"},{n:"Militarpress",s:3,r:"10-12",m:"Axlar"},{n:"Tricep Pushdown",s:3,r:"12-15",m:"Triceps"}]},
    {name:"Underkropp A",ex:[{n:"Knaboej",s:3,r:"10-12",m:"Ben"},{n:"Rumansk marklyft",s:3,r:"10-12",m:"Ben"},{n:"Benpress",s:3,r:"12-15",m:"Ben"},{n:"Bencurl",s:3,r:"12",m:"Ben"}]},
    {name:"Overkropp B",ex:[{n:"Hantelpress lutande",s:3,r:"10-12",m:"Brost"},{n:"Latsdrag",s:3,r:"10-12",m:"Rygg"},{n:"Sidolyft",s:3,r:"15",m:"Axlar"},{n:"Skivstangscurl",s:3,r:"12",m:"Biceps"}]},
    {name:"Underkropp B",ex:[{n:"Hip Thrust",s:3,r:"10-12",m:"Ben"},{n:"Utfall",s:3,r:"12/ben",m:"Ben"},{n:"Benextension",s:3,r:"12-15",m:"Ben"},{n:"Vadpress",s:4,r:"15-20",m:"Ben"}]}
  ]},
  {id:"s5",name:"Helkropp",split:"2D",cat:"Standardmallar",used:0,days:[
    {name:"Helkropp A",ex:[{n:"Knaboej",s:3,r:"10-12",m:"Ben"},{n:"Bankpress",s:3,r:"10-12",m:"Brost"},{n:"Latsdrag",s:3,r:"10-12",m:"Rygg"},{n:"Sidolyft",s:3,r:"15",m:"Axlar"}]},
    {name:"Helkropp B",ex:[{n:"Rumansk marklyft",s:3,r:"10-12",m:"Ben"},{n:"Maskin Brostpress",s:3,r:"12",m:"Brost"},{n:"Sittande kabelrodd",s:3,r:"12",m:"Rygg"},{n:"Militarpress",s:3,r:"10-12",m:"Axlar"}]}
  ]},
  {id:"c1",name:"Maskinbaserad PPL",split:"3D",cat:"Favoriter",used:8,days:[
    {name:"Push",ex:[{n:"Maskin Brostpress",s:3,r:"12-15",m:"Brost"},{n:"Militarpress",s:3,r:"10-12",m:"Axlar"},{n:"Sidolyft",s:3,r:"15",m:"Axlar"},{n:"Tricep Pushdown",s:3,r:"12-15",m:"Triceps"}]},
    {name:"Pull",ex:[{n:"Latsdrag",s:3,r:"10-12",m:"Rygg"},{n:"Sittande kabelrodd",s:3,r:"12",m:"Rygg"},{n:"Face Pull",s:3,r:"15",m:"Axlar"},{n:"Cable Crunch",s:3,r:"15",m:"Mage"}]},
    {name:"Ben",ex:[{n:"Benpress",s:3,r:"12-15",m:"Ben"},{n:"Bencurl",s:3,r:"12",m:"Ben"},{n:"Benextension",s:3,r:"12-15",m:"Ben"},{n:"Vadpress",s:3,r:"15-20",m:"Ben"}]}
  ]},
];

const RECIPES = [
  {id:1,name:"Havregrynsgrot",cat:"frukost",tags:["notfri","fiskfri","kottfri","kycklingfri","flaskfri"],macro:{kcal:420,p:14,c:68,f:10},ing:[{n:"Havregryn",a:80,u:"g"},{n:"Mjolk",a:200,u:"ml"},{n:"Banan",a:1,u:"st"}],steps:["Koka upp mjolk i en kastrull","Tillsatt havregryn, sank varmen","Ror om i 3-4 min tills kr–∞–ºig konsistens","Skiva banan och lagg pa toppen"]},
  {id:2,name:"Aggrora med brod",cat:"frukost",tags:["notfri","fiskfri","kottfri","kycklingfri","flaskfri"],macro:{kcal:450,p:26,c:30,f:24},ing:[{n:"Agg",a:3,u:"st"},{n:"Smor",a:10,u:"g"},{n:"Brod",a:2,u:"st"}],steps:["Smalt smor i en stekpanna pa lag varme","Vispa aggen latt och hall i pannan","Ror forsiktigt med en slev tills aggen stocknar","Rosta brodet och servera tillsammans"]},
  {id:3,name:"Kvarg med granola",cat:"frukost",tags:["notfri","kottfri","kycklingfri","flaskfri","fiskfri"],macro:{kcal:410,p:30,c:55,f:8},ing:[{n:"Kvarg",a:200,u:"g"},{n:"Granola",a:50,u:"g"}],steps:["Hall kvarg i en skal","Toppa med granola","Servera direkt"]},
  {id:4,name:"Smoothie bowl",cat:"frukost",tags:["notfri","kottfri","kycklingfri","flaskfri","fiskfri"],macro:{kcal:340,p:8,c:62,f:6},ing:[{n:"Fryst banan",a:1,u:"st"},{n:"Blabar",a:100,u:"g"},{n:"Havremjolk",a:150,u:"ml"}],steps:["Mixa fryst banan, blabar och havremjolk till tjock konsistens","Hall i en skal","Toppa med valfria toppings"]},
  {id:10,name:"Kyckling med ris",cat:"lunch",tags:["notfri","fiskfri","kottfri","flaskfri"],macro:{kcal:520,p:42,c:55,f:12},ing:[{n:"Kycklingfile",a:150,u:"g"},{n:"Ris",a:80,u:"g"},{n:"Broccoli",a:100,u:"g"}],steps:["Koka riset enligt forpackningen","Krydda kycklingen med salt och peppar","Stek kycklingen i olja pa medelhog varme 5-6 min per sida","Anga broccolin i 3-4 min","Servera allt tillsammans"]},
  {id:11,name:"Pasta med kottfars",cat:"lunch",tags:["notfri","fiskfri","kycklingfri","flaskfri"],macro:{kcal:580,p:35,c:60,f:20},ing:[{n:"Pasta",a:80,u:"g"},{n:"Notfars",a:120,u:"g"},{n:"Krossade tomater",a:1,u:"burk"}],steps:["Koka pastan enligt forpackningen","Bryn kottfarsen i en stekpanna","Tillsatt krossade tomater och lat sjuda 10 min","Blanda ihop med pastan"]},
  {id:12,name:"Lax med potatis",cat:"lunch",tags:["notfri","kottfri","kycklingfri","flaskfri"],macro:{kcal:540,p:38,c:40,f:22},ing:[{n:"Laxfile",a:150,u:"g"},{n:"Potatis",a:200,u:"g"},{n:"Smor",a:10,u:"g"}],steps:["Koka potatisen i saltat vatten ca 15 min","Krydda laxen med salt, peppar och citron","Stek laxen skinnsida ner 4 min, vand och stek 3 min till","Servera med smor pa potatisen"]},
  {id:13,name:"Halloumi-sallad",cat:"lunch",tags:["notfri","fiskfri","kottfri","kycklingfri","flaskfri"],macro:{kcal:510,p:28,c:42,f:24},ing:[{n:"Halloumi",a:1,u:"frp"},{n:"Sallad",a:1,u:"pase"},{n:"Couscous",a:60,u:"g"}],steps:["Koka couscous med lika delar vatten, lat svalla 5 min","Skiva och stek halloumin gyllenbruna pa hog varme","Blanda sallad och couscous","Lagg halloumin pa toppen"]},
  {id:20,name:"Stekt lax med nudlar",cat:"middag",tags:["notfri","kottfri","kycklingfri","flaskfri"],macro:{kcal:560,p:40,c:48,f:22},ing:[{n:"Laxfile",a:150,u:"g"},{n:"Nudlar",a:80,u:"g"},{n:"Broccoli",a:80,u:"g"}],steps:["Koka nudlarna enligt forpackningen","Stek laxen i olja 4 min per sida","Woka broccolin snabbt pa hog varme","Servera laxen pa nudlarna med broccoli"]},
  {id:21,name:"Kottbullar med mos",cat:"middag",tags:["notfri","fiskfri","kycklingfri"],macro:{kcal:650,p:32,c:55,f:32},ing:[{n:"Kottbullar",a:1,u:"frp"},{n:"Potatis",a:250,u:"g"},{n:"Gradde",a:1,u:"frp"}],steps:["Skala och koka potatisen mjuk","Stek kottbullarna i smor tills genomstekta","Mosa potatisen med gradde och smor","Servera med lingonsylt"]},
  {id:22,name:"Kycklingwok",cat:"middag",tags:["notfri","fiskfri","kottfri","flaskfri"],macro:{kcal:500,p:40,c:50,f:14},ing:[{n:"Kycklingfile",a:150,u:"g"},{n:"Wokgronsaker",a:1,u:"pase"},{n:"Nudlar",a:80,u:"g"}],steps:["Koka nudlarna enligt forpackningen","Skiva kycklingen tunt och woka pa hog varme 3-4 min","Tillsatt gronsaker och woka 2 min till","Blanda i nudlarna och sojasas"]},
  {id:23,name:"Omelett med gronsaker",cat:"middag",tags:["notfri","fiskfri","kottfri","kycklingfri","flaskfri"],macro:{kcal:480,p:28,c:28,f:26},ing:[{n:"Agg",a:6,u:"st"},{n:"Paprika",a:1,u:"st"},{n:"Ost",a:30,u:"g"}],steps:["Vispa aggen med salt och peppar","Tarna paprika i sma bitar","Hall aggsmeten i en smord panna pa medelvame","Lagg pa paprika och ost nar undersidan stocknat","Vik ihop och stek klart"]},
  {id:30,name:"Proteinshake",cat:"mellanmal",tags:["notfri","fiskfri","kottfri","kycklingfri","flaskfri"],macro:{kcal:320,p:32,c:38,f:6},ing:[{n:"Proteinpulver",a:1,u:"pase"},{n:"Mjolk",a:300,u:"ml"},{n:"Banan",a:1,u:"st"}],steps:["Lagg alla ingredienser i en mixer","Mixa i 30 sekunder tills slatt","Servera direkt"]},
  {id:31,name:"Kvarg med sylt",cat:"mellanmal",tags:["notfri","fiskfri","kottfri","kycklingfri","flaskfri"],macro:{kcal:180,p:22,c:16,f:2},ing:[{n:"Kvarg",a:1,u:"burk"},{n:"Sylt",a:1,u:"burk"}],steps:["Hall kvarg i en skal","Toppa med en klick sylt","Ror om eller lat ligga som topping"]},
];
const EXCL=[{id:"fisk",l:"Fisk",tag:"fiskfri"},{id:"kott",l:"Kott",tag:"kottfri"},{id:"kyckling",l:"Kyckling",tag:"kycklingfri"},{id:"flask",l:"Flask",tag:"flaskfri"},{id:"notter",l:"Notter",tag:"notfri"}];
const MEAL_S={3:[{s:"Frukost",c:"frukost"},{s:"Lunch",c:"lunch"},{s:"Middag",c:"middag"}],4:[{s:"Frukost",c:"frukost"},{s:"Lunch",c:"lunch"},{s:"Mellanmal",c:"mellanmal"},{s:"Middag",c:"middag"}],5:[{s:"Frukost",c:"frukost"},{s:"Mellanmal",c:"mellanmal"},{s:"Lunch",c:"lunch"},{s:"Mellanmal",c:"mellanmal"},{s:"Middag",c:"middag"}]};
const DAYNAMES=["Man","Tis","Ons","Tor","Fre","Lor","Son"];
function sRng(seed){let s=Math.abs(seed)||1;return()=>{s=(s*16807)%2147483647;return(s-1)/2147483646;};}

// MOCK DATA: hoursLeft = countdown. Onboard=48h, Review=24h
const INIT_CL = [
  {id:"c1",name:"Erik Johansson",gender:"Man",age:28,height:182,startW:88,curW:84.2,goal:"lose",level:"Medel",split:"4D",status:"active",diet:"Inga mejeriprodukter",notes:"Kontorsjobb, tranar kvallar",activity:"1.55",wkT:12,wkC:6,form:true,macros:{p:180,c:220,f:60},wIns:[{w:1,kg:88},{w:2,kg:87.4},{w:3,kg:86.8},{w:4,kg:86.1},{w:5,kg:85.2},{w:6,kg:84.2}],prs:[{ex:"Bankpress",kg:105},{ex:"Knaboej",kg:140}],logs:[{wk:6,day:"Brost/Tri",done:true,vol:12400},{wk:6,day:"Rygg/Bi",done:true,vol:14200},{wk:6,day:"Axlar",done:false,vol:0},{wk:6,day:"Ben",done:false,vol:0}],mLogs:[{p:175,c:210,f:55},{p:182,c:230,f:62},{p:170,c:200,f:58}],cardio:[{type:"30 min promenad",target:4,done:2}],hoursLeft:0,nextReviewIn:72},
  {id:"c2",name:"Sara Lindgren",gender:"Kvinna",age:32,height:168,startW:65,curW:63.8,goal:"lose",level:"Nyborjare",split:"3D",status:"pending_review",diet:"Vegetarian",notes:"Stressigt jobb",activity:"1.55",wkT:8,wkC:6,form:true,macros:{p:130,c:160,f:50},wIns:[
      {w:1,kg:65,days:[65.2,65.0,65.1,64.8,65.0,65.3,64.9]},
      {w:2,kg:64.5,days:[64.8,64.6,64.5,64.3,64.5,64.7,64.2]},
      {w:3,kg:64.8,days:[64.4,64.6,64.9,65.0,64.8,65.1,64.7]},
      {w:4,kg:64.2,days:[64.6,64.4,64.3,64.1,64.2,64.0,64.3]},
      {w:5,kg:64.0,days:[64.2,64.1,63.9,64.0,63.8,64.1,63.9]},
      {w:6,kg:63.8,days:[64.0,63.9,63.7,63.8,63.6,63.9,63.7]}
    ],prs:[{ex:"Hip Thrust",kg:80}],logs:[{wk:6,day:"Overkropp",done:true,vol:6200},{wk:6,day:"Underkropp",done:true,vol:8100},{wk:6,day:"Helkropp",done:true,vol:7400}],mLogs:[{p:125,c:155,f:48},{p:132,c:168,f:52},{p:128,c:150,f:45},{p:130,c:162,f:50},{p:118,c:175,f:55},{p:135,c:145,f:47},{p:126,c:158,f:51}],
    weeklyMacros:[
      {week:1,days:[{d:"M√•n",p:120,c:148,f:44},{d:"Tis",p:128,c:162,f:50},{d:"Ons",p:115,c:140,f:42},{d:"Tor",p:130,c:155,f:48},{d:"Fre",p:122,c:170,f:52},{d:"L√∂r",p:110,c:180,f:58},{d:"S√∂n",p:105,c:190,f:60}]},
      {week:2,days:[{d:"M√•n",p:125,c:155,f:46},{d:"Tis",p:130,c:160,f:48},{d:"Ons",p:118,c:145,f:44},{d:"Tor",p:132,c:158,f:50},{d:"Fre",p:126,c:165,f:52},{d:"L√∂r",p:115,c:175,f:55},{d:"S√∂n",p:108,c:185,f:58}]},
      {week:3,days:[{d:"M√•n",p:128,c:152,f:45},{d:"Tis",p:135,c:158,f:48},{d:"Ons",p:122,c:148,f:46},{d:"Tor",p:130,c:155,f:48},{d:"Fre",p:128,c:162,f:50},{d:"L√∂r",p:118,c:172,f:54},{d:"S√∂n",p:112,c:178,f:56}]},
      {week:4,days:[{d:"M√•n",p:130,c:155,f:47},{d:"Tis",p:132,c:160,f:49},{d:"Ons",p:126,c:150,f:46},{d:"Tor",p:128,c:158,f:48},{d:"Fre",p:130,c:160,f:50},{d:"L√∂r",p:120,c:168,f:52},{d:"S√∂n",p:115,c:175,f:55}]},
      {week:5,days:[{d:"M√•n",p:132,c:155,f:48},{d:"Tis",p:130,c:158,f:50},{d:"Ons",p:128,c:152,f:47},{d:"Tor",p:135,c:155,f:48},{d:"Fre",p:126,c:160,f:50},{d:"L√∂r",p:118,c:165,f:52},{d:"S√∂n",p:112,c:172,f:54}]},
      {week:6,days:[{d:"M√•n",p:125,c:155,f:48},{d:"Tis",p:132,c:168,f:52},{d:"Ons",p:128,c:150,f:45},{d:"Tor",p:130,c:162,f:50},{d:"Fre",p:118,c:175,f:55},{d:"L√∂r",p:135,c:145,f:47},{d:"S√∂n",p:126,c:158,f:51}]}
    ],cardio:[{type:"30 min promenad",target:5,done:5}],hoursLeft:18,nextReviewIn:0,
    message:"Hej! Bra vecka overlag, men kande mig ganska trott onsdag-torsdag. Tror jag sov daligt. Annars kul att traningen gar framat!",
    plan:"full", // "full" | "train_only" | "food_only"
    selfAssess:{difficulty:"Perfekt utmanande",energy:"Trott",mood:"Bra"},
    program:[
      {name:"Overkropp",ex:[{n:"Bankpress",s:3,r:"10-12",m:"Brost"},{n:"Latsdrag",s:3,r:"10-12",m:"Rygg"},{n:"Militarpress",s:3,r:"10-12",m:"Axlar"},{n:"Tricep Pushdown",s:3,r:"12-15",m:"Triceps"}]},
      {name:"Underkropp",ex:[{n:"Hip Thrust",s:3,r:"10-12",m:"Ben"},{n:"Knaboej",s:3,r:"10-12",m:"Ben"},{n:"Rumansk marklyft",s:3,r:"10-12",m:"Ben"},{n:"Bencurl",s:3,r:"12",m:"Ben"}]},
      {name:"Helkropp",ex:[{n:"Benpress",s:3,r:"12-15",m:"Ben"},{n:"Maskin Brostpress",s:3,r:"12",m:"Brost"},{n:"Sittande kabelrodd",s:3,r:"12",m:"Rygg"},{n:"Sidolyft",s:3,r:"15",m:"Axlar"}]}
    ],
    mealPlan:[
      {name:"Man",meals:[
        {slot:"Frukost",r:"Havregrynsgr√∂t med b√§r",kcal:420,p:14,c:68,f:10,
          ingredients:["80g havregryn","2dl mj√∂lk","1 msk honung","100g frysta bl√•b√§r","1 msk chiafron"],
          steps:["Koka havregryn med mj√∂lk i 3 min.","Toppa med bl√•b√§r, honung och chiafron."]},
        {slot:"Lunch",r:"Halloumi-sallad",kcal:510,p:28,c:42,f:24,
          ingredients:["200g halloumi","150g blandad sallad","1 avokado","10 k√∂rsb√§rstomater","1 msk olivolja","¬Ω citron"],
          steps:["Sk√§r halloumi i skivor och stek gyllene.","Blanda sallad, tomat och avokado.","Toppa med halloumi, olja och citron."]},
        {slot:"Middag",r:"Kycklingwok med ris",kcal:500,p:40,c:50,f:14,
          ingredients:["250g kycklingfil√©","150g jasminris","100g broccoli","1 paprika","2 msk sojas√•s","1 msk sesamolja"],
          steps:["Koka riset enligt f√∂rpackning.","Sk√§r kycklingen i bitar, stek p√• h√∂g v√§rme 4 min.","Tills√§tt gr√∂nsaker, soja och sesamolja. Stek 3 min."]}
      ]},
      {name:"Tis",meals:[
        {slot:"Frukost",r:"Kvarg med granola",kcal:410,p:30,c:55,f:8,
          ingredients:["250g kvarg","60g granola","1 banan","1 msk honung"],
          steps:["H√§ll kvarg i sk√•l.","Toppa med granola, skivad banan och honung."]},
        {slot:"Lunch",r:"Kyckling med ris",kcal:520,p:42,c:55,f:12,
          ingredients:["250g kycklingfil√©","150g ris","100g haricots verts","1 msk olivolja","Salt och peppar"],
          steps:["Koka ris.","Krydda och stek kyckling i olivolja 5 min per sida.","Koka haricots verts 3 min. Servera."]},
        {slot:"Middag",r:"Omelett med gr√∂nsaker",kcal:480,p:28,c:28,f:26,
          ingredients:["4 √§gg","50g ost","1 tomat","50g spenat","1 msk sm√∂r"],
          steps:["Vispa √§ggen.","Sm√§lt sm√∂r, h√§ll i √§ggsmeten.","L√§gg p√• spenat, tomat och ost. Vik ihop."]}
      ]},
      {name:"Ons",meals:[
        {slot:"Frukost",r:"√Ñggr√∂ra med br√∂d",kcal:450,p:26,c:30,f:24,
          ingredients:["3 √§gg","2 skivor fullkornsbr√∂d","1 msk sm√∂r","Salt och peppar"],
          steps:["Sm√§lt sm√∂r. Vispa √§gg och stek mjukt.","Rosta br√∂d. Servera."]},
        {slot:"Lunch",r:"Lax med potatis",kcal:540,p:38,c:40,f:22,
          ingredients:["200g laxfil√©","300g potatis","100g sparris","1 msk olivolja","¬Ω citron"],
          steps:["Ugn 200¬∞C. L√§gg lax och potatis p√• pl√•t.","Ringla olja, salta. Baka 20 min.","Tills√§tt sparris sista 8 min."]},
        {slot:"Middag",r:"K√∂ttbullar med mos",kcal:650,p:32,c:55,f:32,
          ingredients:["300g k√∂ttf√§rs","1 √§gg","3 msk str√∂br√∂d","500g potatis","1dl mj√∂lk","Lingonsylt"],
          steps:["Blanda f√§rs, √§gg, str√∂br√∂d. Rulla bullar.","Stek k√∂ttbullar 8 min.","Koka och mosa potatis med mj√∂lk."]}
      ]},
      {name:"Tor",meals:[
        {slot:"Frukost",r:"Havregrynsgr√∂t med b√§r",kcal:420,p:14,c:68,f:10,
          ingredients:["80g havregryn","2dl mj√∂lk","1 msk honung","100g frysta bl√•b√§r","1 msk chiafron"],
          steps:["Koka havregryn med mj√∂lk i 3 min.","Toppa med bl√•b√§r, honung och chiafron."]},
        {slot:"Lunch",r:"Pasta med k√∂ttf√§rss√•s",kcal:580,p:35,c:60,f:20,
          ingredients:["150g pasta","200g k√∂ttf√§rs","1 burk krossade tomater","1 l√∂k","2 vitl√∂ksklyftor","1 msk olivolja"],
          steps:["Koka pasta.","Fr√§s l√∂k och vitl√∂k. Bryn f√§rs.","Tills√§tt tomater, sjud 15 min."]},
        {slot:"Middag",r:"Stekt lax med nudlar",kcal:560,p:40,c:48,f:22,
          ingredients:["200g laxfil√©","150g √§ggnudlar","100g socker√§rtor","2 msk sojas√•s","1 msk sweet chili"],
          steps:["Koka nudlar.","Stek lax 3 min per sida.","Fr√§s socker√§rtor, blanda med nudlar och s√•s."]}
      ]},
      {name:"Fre",meals:[
        {slot:"Frukost",r:"Smoothie bowl",kcal:340,p:8,c:62,f:6,
          ingredients:["1 banan","150g frysta hallon","1dl havremj√∂lk","30g granola","1 msk kokosflingor"],
          steps:["Mixa banan, hallon och havremj√∂lk.","H√§ll i sk√•l, toppa med granola och kokos."]},
        {slot:"Lunch",r:"Halloumi-sallad",kcal:510,p:28,c:42,f:24,
          ingredients:["200g halloumi","150g blandad sallad","1 avokado","10 k√∂rsb√§rstomater","1 msk olivolja","¬Ω citron"],
          steps:["Sk√§r halloumi i skivor och stek gyllene.","Blanda sallad, tomat och avokado.","Toppa med halloumi, olja och citron."]},
        {slot:"Middag",r:"Kycklingwok med ris",kcal:500,p:40,c:50,f:14,
          ingredients:["250g kycklingfil√©","150g jasminris","100g broccoli","1 paprika","2 msk sojas√•s","1 msk sesamolja"],
          steps:["Koka riset enligt f√∂rpackning.","Sk√§r kycklingen i bitar, stek p√• h√∂g v√§rme 4 min.","Tills√§tt gr√∂nsaker, soja och sesamolja. Stek 3 min."]}
      ]}
    ],
    weeklyLogs:[
      {week:1,days:[
        {name:"Overkropp",exercises:[{n:"Bankpress",sets:[{kg:25,reps:12},{kg:25,reps:10},{kg:25,reps:8}]},{n:"Latsdrag",sets:[{kg:30,reps:12},{kg:30,reps:10},{kg:30,reps:9}]},{n:"Militarpress",sets:[{kg:12.5,reps:12},{kg:12.5,reps:10},{kg:12.5,reps:8}]},{n:"Tricep Pushdown",sets:[{kg:12.5,reps:15},{kg:12.5,reps:12},{kg:12.5,reps:10}]}]},
        {name:"Underkropp",exercises:[{n:"Hip Thrust",sets:[{kg:50,reps:12},{kg:50,reps:10},{kg:50,reps:9}]},{n:"Knaboej",sets:[{kg:30,reps:12},{kg:30,reps:10},{kg:30,reps:8}]},{n:"Rumansk marklyft",sets:[{kg:35,reps:12},{kg:35,reps:10},{kg:35,reps:10}]},{n:"Bencurl",sets:[{kg:15,reps:12},{kg:15,reps:12},{kg:15,reps:10}]}]},
        {name:"Helkropp",exercises:[{n:"Benpress",sets:[{kg:50,reps:15},{kg:50,reps:12},{kg:50,reps:10}]},{n:"Maskin Brostpress",sets:[{kg:20,reps:12},{kg:20,reps:10},{kg:20,reps:8}]},{n:"Sittande kabelrodd",sets:[{kg:25,reps:12},{kg:25,reps:10},{kg:25,reps:9}]},{n:"Sidolyft",sets:[{kg:4,reps:15},{kg:4,reps:12},{kg:4,reps:10}]}]}
      ]},
      {week:2,days:[
        {name:"Overkropp",exercises:[{n:"Bankpress",sets:[{kg:27.5,reps:12},{kg:27.5,reps:11},{kg:27.5,reps:9}]},{n:"Latsdrag",sets:[{kg:32.5,reps:12},{kg:32.5,reps:11},{kg:32.5,reps:10}]},{n:"Militarpress",sets:[{kg:12.5,reps:12},{kg:12.5,reps:12},{kg:12.5,reps:10}]},{n:"Tricep Pushdown",sets:[{kg:12.5,reps:15},{kg:12.5,reps:14},{kg:12.5,reps:12}]}]},
        {name:"Underkropp",exercises:[{n:"Hip Thrust",sets:[{kg:55,reps:12},{kg:55,reps:11},{kg:55,reps:10}]},{n:"Knaboej",sets:[{kg:35,reps:12},{kg:35,reps:10},{kg:35,reps:9}]},{n:"Rumansk marklyft",sets:[{kg:37.5,reps:12},{kg:37.5,reps:11},{kg:37.5,reps:10}]},{n:"Bencurl",sets:[{kg:17.5,reps:12},{kg:17.5,reps:11},{kg:17.5,reps:10}]}]},
        {name:"Helkropp",exercises:[{n:"Benpress",sets:[{kg:55,reps:15},{kg:55,reps:13},{kg:55,reps:11}]},{n:"Maskin Brostpress",sets:[{kg:22.5,reps:12},{kg:22.5,reps:10},{kg:22.5,reps:9}]},{n:"Sittande kabelrodd",sets:[{kg:27.5,reps:12},{kg:27.5,reps:11},{kg:27.5,reps:10}]},{n:"Sidolyft",sets:[{kg:5,reps:15},{kg:5,reps:13},{kg:5,reps:11}]}]}
      ]},
      {week:3,days:[
        {name:"Overkropp",exercises:[{n:"Bankpress",sets:[{kg:30,reps:12},{kg:30,reps:10},{kg:30,reps:9}]},{n:"Latsdrag",sets:[{kg:35,reps:12},{kg:35,reps:11},{kg:35,reps:10}]},{n:"Militarpress",sets:[{kg:15,reps:12},{kg:15,reps:10},{kg:15,reps:10}]},{n:"Tricep Pushdown",sets:[{kg:15,reps:15},{kg:15,reps:12},{kg:15,reps:12}]}]},
        {name:"Underkropp",exercises:[{n:"Hip Thrust",sets:[{kg:60,reps:12},{kg:60,reps:10},{kg:60,reps:10}]},{n:"Knaboej",sets:[{kg:40,reps:12},{kg:40,reps:10},{kg:40,reps:9}]},{n:"Rumansk marklyft",sets:[{kg:40,reps:12},{kg:40,reps:12},{kg:40,reps:10}]},{n:"Bencurl",sets:[{kg:20,reps:12},{kg:20,reps:12},{kg:20,reps:10}]}]},
        {name:"Helkropp",exercises:[{n:"Benpress",sets:[{kg:60,reps:15},{kg:60,reps:12},{kg:60,reps:12}]},{n:"Maskin Brostpress",sets:[{kg:25,reps:12},{kg:25,reps:10},{kg:25,reps:10}]},{n:"Sittande kabelrodd",sets:[{kg:30,reps:12},{kg:30,reps:11},{kg:30,reps:10}]},{n:"Sidolyft",sets:[{kg:5,reps:15},{kg:5,reps:14},{kg:5,reps:12}]}]}
      ]},
      {week:4,days:[
        {name:"Overkropp",exercises:[{n:"Bankpress",sets:[{kg:30,reps:12},{kg:30,reps:12},{kg:30,reps:10}]},{n:"Latsdrag",sets:[{kg:37.5,reps:12},{kg:37.5,reps:10},{kg:37.5,reps:10}]},{n:"Militarpress",sets:[{kg:15,reps:12},{kg:15,reps:12},{kg:15,reps:10}]},{n:"Tricep Pushdown",sets:[{kg:15,reps:15},{kg:15,reps:14},{kg:15,reps:13}]}]},
        {name:"Underkropp",exercises:[{n:"Hip Thrust",sets:[{kg:62.5,reps:12},{kg:62.5,reps:11},{kg:62.5,reps:10}]},{n:"Knaboej",sets:[{kg:40,reps:12},{kg:40,reps:11},{kg:40,reps:10}]},{n:"Rumansk marklyft",sets:[{kg:42.5,reps:12},{kg:42.5,reps:11},{kg:42.5,reps:10}]},{n:"Bencurl",sets:[{kg:20,reps:12},{kg:20,reps:12},{kg:20,reps:12}]}]},
        {name:"Helkropp",exercises:[{n:"Benpress",sets:[{kg:65,reps:15},{kg:65,reps:14},{kg:65,reps:12}]},{n:"Maskin Brostpress",sets:[{kg:27.5,reps:12},{kg:27.5,reps:11},{kg:27.5,reps:10}]},{n:"Sittande kabelrodd",sets:[{kg:32.5,reps:12},{kg:32.5,reps:12},{kg:32.5,reps:10}]},{n:"Sidolyft",sets:[{kg:6,reps:15},{kg:6,reps:14},{kg:6,reps:13}]}]}
      ]},
      {week:5,days:[
        {name:"Overkropp",exercises:[{n:"Bankpress",sets:[{kg:32.5,reps:12},{kg:32.5,reps:10},{kg:32.5,reps:9}]},{n:"Latsdrag",sets:[{kg:37.5,reps:12},{kg:37.5,reps:11},{kg:37.5,reps:10}]},{n:"Militarpress",sets:[{kg:17.5,reps:10},{kg:17.5,reps:9},{kg:17.5,reps:8}]},{n:"Tricep Pushdown",sets:[{kg:17.5,reps:14},{kg:17.5,reps:12},{kg:17.5,reps:11}]}]},
        {name:"Underkropp",exercises:[{n:"Hip Thrust",sets:[{kg:65,reps:12},{kg:65,reps:11},{kg:65,reps:10}]},{n:"Knaboej",sets:[{kg:42.5,reps:11},{kg:42.5,reps:10},{kg:42.5,reps:9}]},{n:"Rumansk marklyft",sets:[{kg:42.5,reps:12},{kg:42.5,reps:11},{kg:42.5,reps:10}]},{n:"Bencurl",sets:[{kg:22.5,reps:12},{kg:22.5,reps:11},{kg:22.5,reps:10}]}]},
        {name:"Helkropp",exercises:[{n:"Benpress",sets:[{kg:65,reps:15},{kg:65,reps:13},{kg:65,reps:12}]},{n:"Maskin Brostpress",sets:[{kg:27.5,reps:12},{kg:27.5,reps:11},{kg:27.5,reps:10}]},{n:"Sittande kabelrodd",sets:[{kg:32.5,reps:12},{kg:32.5,reps:11},{kg:32.5,reps:10}]},{n:"Sidolyft",sets:[{kg:6,reps:15},{kg:6,reps:14},{kg:6,reps:13}]}]}
      ]},
      {week:6,days:[
        {name:"Overkropp",exercises:[{n:"Bankpress",sets:[{kg:35,reps:12},{kg:35,reps:11},{kg:35,reps:10}]},{n:"Latsdrag",sets:[{kg:40,reps:12},{kg:40,reps:10},{kg:40,reps:10}]},{n:"Militarpress",sets:[{kg:17.5,reps:12},{kg:17.5,reps:10},{kg:17.5,reps:10}]},{n:"Tricep Pushdown",sets:[{kg:17.5,reps:15},{kg:17.5,reps:13},{kg:17.5,reps:12}]}]},
        {name:"Underkropp",exercises:[{n:"Hip Thrust",sets:[{kg:70,reps:12},{kg:70,reps:10}]},{n:"Knaboej",sets:[{kg:45,reps:10}]},{n:"Rumansk marklyft",sets:[]},{n:"Bencurl",sets:[]}]},
        {name:"Helkropp",exercises:[{n:"Benpress",sets:[]},{n:"Maskin Brostpress",sets:[]},{n:"Sittande kabelrodd",sets:[]},{n:"Sidolyft",sets:[]}]}
      ]}
    ]
  },
  {id:"c3",name:"Marcus Svensson",gender:"Man",age:24,height:175,startW:72,curW:74.8,goal:"build",level:"Medel",split:"5D",status:"pending_review",diet:"Inga",notes:"Student",activity:"1.725",wkT:16,wkC:10,form:true,macros:{p:170,c:320,f:75},wIns:[{w:1,kg:72},{w:5,kg:73.1},{w:8,kg:74},{w:10,kg:74.8}],prs:[{ex:"Bankpress",kg:95},{ex:"Marklyft",kg:160}],logs:[{wk:10,day:"Brost",done:true,vol:11800},{wk:10,day:"Rygg",done:true,vol:15200},{wk:10,day:"Axlar",done:true,vol:8600},{wk:10,day:"Ben",done:false,vol:0},{wk:10,day:"Bi/Tri",done:false,vol:0}],mLogs:[{p:168,c:315,f:72},{p:172,c:330,f:78}],cardio:[{type:"15 min LISS",target:2,done:1}],hoursLeft:2,nextReviewIn:0},
  {id:"c4",name:"Anna Ekstrom",gender:"Kvinna",age:27,height:172,startW:58,curW:58,goal:"build",level:"Nyborjare",split:"3D",status:"new_signup",diet:"Glutenfri",notes:"Vill bygga mer rumpa och ben",activity:"1.55",wkT:12,wkC:0,form:true,macros:{p:0,c:0,f:0},wIns:[],prs:[],logs:[],mLogs:[],cardio:[],hoursLeft:40,nextReviewIn:0},
  {id:"c5",name:"Johan Berg",gender:"Man",age:35,height:180,startW:95,curW:95,goal:"lose",level:"Nyborjare",split:"3D",status:"new_signup",diet:"Inga",notes:"Vill komma igang efter skada",activity:"1.375",wkT:12,wkC:0,form:false,macros:{p:0,c:0,f:0},wIns:[],prs:[],logs:[],mLogs:[],cardio:[],hoursLeft:6,nextReviewIn:0},
];

// --- PRIMITIVES ---
function Card({children,style,onClick,glow}) {
  const [h,setH]=useState(false);
  return <div onClick={onClick} onMouseEnter={onClick?()=>setH(true):undefined} onMouseLeave={onClick?()=>setH(false):undefined} style={{background:h?T.s2:T.s1,border:"1px solid "+(glow||h?T.brdH:T.brd),borderRadius:T.r,padding:16,transition:"all .15s",cursor:onClick?"pointer":"default",...style}}>{children}</div>;
}
function Btn({children,v="primary",onClick,style,disabled,full}) {
  const vs={primary:{background:T.acc,color:"#1a1a1a",border:"none",fontWeight:700},secondary:{background:"transparent",color:T.t,border:"1px solid rgba(255,255,255,0.15)",fontWeight:500},ghost:{background:"transparent",color:T.dim,border:"none",fontWeight:500}};
  return <button disabled={disabled} onClick={onClick} style={{padding:"8px 16px",borderRadius:10,fontSize:13,cursor:disabled?"not-allowed":"pointer",fontFamily:T.f,transition:"all .15s",opacity:disabled?0.35:1,width:full?"100%":"auto",...vs[v],...style}}>{children}</button>;
}
function Pill({children,active,onClick,color}) {
  const c=color||T.acc;
  return <button onClick={onClick} style={{padding:"5px 14px",borderRadius:20,border:"1px solid "+(active?c+"40":"rgba(255,255,255,0.06)"),background:active?c+"12":"transparent",color:active?c:"rgba(255,255,255,0.3)",fontSize:12,fontWeight:600,cursor:"pointer",fontFamily:T.f}}>{children}</button>;
}
function Input({label,value,onChange,type="text",placeholder,style,small}) {
  return <div style={{display:"flex",flexDirection:"column",gap:3,...style}}>{label&&<label style={{fontSize:10,color:T.dim,fontWeight:700,letterSpacing:0.5,textTransform:"uppercase"}}>{label}</label>}<input type={type} value={value} onChange={e=>onChange(e.target.value)} placeholder={placeholder} style={{padding:small?"5px 8px":"8px 11px",borderRadius:8,border:"1px solid "+T.brd,background:"rgba(255,255,255,0.03)",color:"#fff",fontSize:small?12:13,fontFamily:T.f,outline:"none",width:"100%",boxSizing:"border-box"}}/></div>;
}
function Sel({label,value,onChange,options,style}) {
  return <div style={{display:"flex",flexDirection:"column",gap:3,...style}}>{label&&<label style={{fontSize:10,color:T.dim,fontWeight:700,letterSpacing:0.5,textTransform:"uppercase"}}>{label}</label>}<select value={value} onChange={e=>onChange(e.target.value)} style={{padding:"8px 11px",borderRadius:8,border:"1px solid "+T.brd,background:"rgba(255,255,255,0.03)",color:"#fff",fontSize:13,fontFamily:T.f,outline:"none"}}>{options.map(o=><option key={o.v} value={o.v} style={{background:"#1a1a1a"}}>{o.l}</option>)}</select></div>;
}
function Lbl({children}) { return <div style={{fontSize:10,fontWeight:700,color:T.dim,marginBottom:8,textTransform:"uppercase",letterSpacing:0.5}}>{children}</div>; }

// Pyramid section header ‚Äî centered title + optional progress bar
function SectionHeader({title,accent="#fff",dimColor="rgba(255,255,255,0.35)",brdColor="rgba(255,255,255,0.08)"}){
  return <div style={{textAlign:"center",marginBottom:20}}>
    <div style={{fontSize:20,fontWeight:800,letterSpacing:-0.5,color:accent}}>{title}</div>
    <div style={{width:40,height:2,borderRadius:1,background:brdColor,margin:"12px auto 0"}}/>
  </div>;
}

// Week progress bar ‚Äî same visual level as DayTabs
function WeekProgress({weekCurrent,weekTotal,onWeekClick,activeWeek,accent="#fff",dimColor="rgba(255,255,255,0.35)",brdColor="rgba(255,255,255,0.08)"}){
  return <div style={{width:"100%",marginBottom:14}}>
    <div style={{position:"relative",height:28}}>
      {/* Track */}
      <div style={{position:"absolute",top:"50%",left:0,right:0,height:3,transform:"translateY(-50%)",background:brdColor,borderRadius:2}}/>
      {/* Filled */}
      <div style={{position:"absolute",top:"50%",left:0,height:3,transform:"translateY(-50%)",background:accent,borderRadius:2,width:Math.round((weekCurrent/weekTotal)*100)+"%",transition:"width .4s ease"}}/>
      {/* Week dots */}
      {Array.from({length:weekTotal},(_,i)=>{
        const wk=i+1;
        const pct=(wk/weekTotal)*100;
        const isCurrent=wk===weekCurrent&&(activeWeek===null||activeWeek===undefined);
        const isViewing=activeWeek===wk;
        const isCompleted=wk<weekCurrent;
        const isFuture=wk>weekCurrent;
        const isClickable=!isFuture&&onWeekClick;
        return <div key={wk} onClick={()=>isClickable&&onWeekClick(wk===weekCurrent?null:wk)} style={{position:"absolute",left:`calc(${pct}% - 10px)`,top:"50%",transform:"translateY(-50%)",zIndex:2,cursor:isClickable?"pointer":"default"}}>
          <div style={{width:isCurrent||isViewing?22:isCompleted?14:10,height:isCurrent||isViewing?22:isCompleted?14:10,borderRadius:"50%",background:isCurrent?accent:isViewing?"rgba(255,255,255,0.15)":isCompleted?accent:"transparent",border:isCurrent?"2px solid "+accent:isViewing?"2px solid "+accent:isCompleted?"none":"2px solid "+brdColor,display:"flex",alignItems:"center",justifyContent:"center",transition:"all .2s",boxShadow:isCurrent?"0 0 0 4px "+accent+"20":isViewing?"0 0 0 4px "+accent+"15":"none"}}>
            {(isCurrent||isViewing)&&<span style={{fontSize:8,fontWeight:800,color:isCurrent?"#1a1a1a":"#fff",lineHeight:1}}>{wk}</span>}
          </div>
        </div>;
      })}
    </div>
    <div style={{textAlign:"center",fontSize:10,color:dimColor,fontWeight:600,marginTop:4}}>
      {activeWeek!==null&&activeWeek!==undefined?`Vecka ${activeWeek}`:`Vecka ${weekCurrent} av ${weekTotal}`}
    </div>
  </div>;
}

// Unified day tabs ‚Äî used in kost + vikt
function DayTabs({days,active,onSelect,theme,checkFn}){
  const t=theme||{active:"#fff",activeBg:"rgba(255,255,255,0.08)",activeBrd:"rgba(255,255,255,0.3)",doneBrd:"rgba(255,255,255,0.15)",doneBg:"rgba(255,255,255,0.04)",doneCol:"rgba(255,255,255,0.5)",defBrd:"rgba(255,255,255,0.08)",defCol:"rgba(255,255,255,0.35)",font:"'Inter','Helvetica Neue',sans-serif",shadow:"none"};
  return <div style={{display:"flex",gap:3,width:"100%",marginBottom:14}}>
    {days.map((d,i)=>{
      const isActive=active===i;
      const isDone=checkFn?checkFn(i):false;
      return <button key={i} onClick={()=>onSelect(i)} style={{flex:1,padding:"7px 2px",borderRadius:9,border:"1px solid "+(isActive?t.activeBrd:isDone?t.doneBrd:t.defBrd),background:isActive?t.activeBg:isDone?t.doneBg:"transparent",color:isActive?t.active:isDone?t.doneCol:t.defCol,fontSize:9,fontWeight:700,cursor:"pointer",fontFamily:t.font,transition:"all .2s",boxShadow:isActive?t.shadow:"none"}}>
        {isDone&&!isActive?"‚úì ":""}{d}
      </button>;
    })}
  </div>;
}

// Locked tab ‚Äî pitch slideshow for upgrade
function LockedTab({type}){
  const [slide,setSlide]=useState(0);
  const slides=type==="train"?[
    {title:"Personligt tr√§ningsprogram",desc:"Din PT skapar ett skr√§ddarsytt schema anpassat efter dina m√•l, din erfarenhet och ditt liv.",icon:"üèãÔ∏è"},
    {title:"√ñvningsloggning i realtid",desc:"Logga set, vikt och reps under passet med automatisk vilotimer och progression.",icon:"üìä"},
    {title:"Vecka-f√∂r-vecka progression",desc:"Se din utveckling, bl√§ddra i historik och f√∂lj progressiv √∂verbelastning.",icon:"üìà"},
    {title:"Check-in med din PT",desc:"Skicka veckologgar direkt till din PT f√∂r feedback och justeringar.",icon:"üí¨"}
  ]:[
    {title:"Skr√§ddarsytt kostschema",desc:"Meal-plans anpassade efter din kaloribudget, allergier och preferenser ‚Äî med recept.",icon:"üçΩÔ∏è"},
    {title:"Automatisk ink√∂pslista",desc:"Allt du beh√∂ver handla genereras per vecka baserat p√• din meal-plan.",icon:"üõí"},
    {title:"Makrologgning",desc:"Logga protein, kolhydrater och fett per dag. F√∂lj dina m√•l visuellt.",icon:"üìä"},
    {title:"Viktuppf√∂ljning",desc:"Daglig inv√§gning med trender, tips och vecko√∂versikt till din PT.",icon:"‚öñÔ∏è"}
  ];
  const s=slides[slide];
  const last=slide===slides.length-1;
  // POST palette
  const Y="#ffcc00";
  const touchRef=useRef(null);
  
  return <div>
    <SectionHeader title={type==="train"?"Tr√§ning":"Kost & Vikt"} accent={Y} dimColor="rgba(255,255,255,0.35)" brdColor="rgba(255,255,255,0.1)"/>
    
    {/* Progress dots */}
    <div style={{display:"flex",justifyContent:"center",gap:6,marginBottom:14}}>
      {slides.map((_,i)=><div key={i} onClick={()=>setSlide(i)} style={{width:i===slide?20:6,height:4,borderRadius:2,background:i===slide?Y:"rgba(255,255,255,0.2)",cursor:"pointer",transition:"all .25s"}}/>)}
    </div>
    
    {/* Slide card */}
    <div
      onTouchStart={e=>touchRef.current=e.touches[0].clientX}
      onTouchEnd={e=>{
        if(!touchRef.current)return;
        const diff=e.changedTouches[0].clientX-touchRef.current;
        if(diff<-40&&slide<slides.length-1)setSlide(p=>p+1);
        if(diff>40&&slide>0)setSlide(p=>p-1);
        touchRef.current=null;
      }}
      style={{padding:"36px 24px",background:"rgba(0,0,0,0.12)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:14,textAlign:"center",minHeight:220,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",position:"relative",overflow:"hidden"}}
    >
      {/* Stamp */}
      <div style={{position:"absolute",top:12,right:12,width:36,height:36,borderRadius:4,border:"2px solid rgba(255,255,255,0.15)",display:"flex",alignItems:"center",justifyContent:"center",transform:"rotate(8deg)"}}>
        <span style={{fontSize:8,fontWeight:800,color:Y,letterSpacing:1}}>{slide+1}/{slides.length}</span>
      </div>
      
      <div key={slide} style={{animation:"fadeUp .25s ease"}}>
        {/* Icon in yellow circle */}
        <div style={{width:72,height:72,borderRadius:"50%",background:Y,display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px",boxShadow:"0 2px 12px rgba(0,0,0,0.2)"}}>
          <span style={{fontSize:36}}>{s.icon}</span>
        </div>
        <div style={{fontSize:17,fontWeight:800,color:"#fff",letterSpacing:-0.3,marginBottom:8}}>{s.title}</div>
        <div style={{fontSize:12,color:"rgba(255,255,255,0.75)",lineHeight:1.6,maxWidth:260}}>{s.desc}</div>
      </div>
    </div>
    
    {/* Yellow accent bar */}
    <div style={{height:3,borderRadius:2,margin:"0 40px",background:`linear-gradient(90deg, ${Y}00, ${Y}, ${Y}00)`}}/>
    
    {/* Advance link */}
    <div style={{textAlign:"center",marginTop:14}}>
      {!last?<button onClick={()=>setSlide(p=>p+1)} style={{background:"none",border:"none",color:Y,fontSize:12,fontWeight:700,cursor:"pointer",fontFamily:T.f,letterSpacing:0.3}}>
        Mer info ‚Üí
      </button>
      :<span style={{fontSize:11,color:"rgba(255,255,255,0.4)"}}>Prata med din PT om att uppgradera</span>}
    </div>
    
    <style>{`@keyframes fadeUp{0%{opacity:0;transform:translateY(10px)}100%{opacity:1;transform:translateY(0)}}`}</style>
  </div>;
}

function Chart({data,color=T.acc,h=50,labels,highlightIdx,smooth,onDotClick}) {
  const [hov,setHov]=useState(null);
  if(!data||data.length<2) return <div style={{height:h,display:"flex",alignItems:"center",justifyContent:"center",color:T.mut,fontSize:11}}>--</div>;
  const mn=Math.min(...data),mx=Math.max(...data),rg=mx-mn||1,W=300;
  const coords=data.map((v,i)=>({x:(i/(data.length-1))*W,y:h-((v-mn)/rg)*(h-8)-4}));
  const pcts=data.map((v,i)=>({x:(i/(data.length-1))*100,y:((h-((v-mn)/rg)*(h-8)-4)/h)*100}));
  const gId="g"+(smooth?"s":"")+color.replace(/[^a-zA-Z0-9]/g,"");
  
  // Build path ‚Äî smooth (monotone cubic) or straight
  let linePath,fillPath;
  if(smooth&&coords.length>=3){
    // Monotone cubic spline
    const pts=coords;
    let d="M"+pts[0].x+","+pts[0].y;
    for(let i=0;i<pts.length-1;i++){
      const tension=0.3;
      const p0=pts[Math.max(0,i-1)],p1=pts[i],p2=pts[i+1],p3=pts[Math.min(pts.length-1,i+2)];
      const cp1x=p1.x+(p2.x-p0.x)*tension;
      const cp1y=p1.y+(p2.y-p0.y)*tension;
      const cp2x=p2.x-(p3.x-p1.x)*tension;
      const cp2y=p2.y-(p3.y-p1.y)*tension;
      d+=` C${cp1x},${cp1y} ${cp2x},${cp2y} ${p2.x},${p2.y}`;
    }
    linePath=d;
    fillPath=d+` L${W},${h} L0,${h} Z`;
  } else {
    const pts=coords.map(c=>c.x+","+c.y).join(" ");
    linePath=null; // use polyline
    fillPath=`0,${h} ${pts} ${W},${h}`;
  }
  
  return <div style={{position:"relative",height:h,marginTop:labels?18:0}}>
    <svg viewBox={`0 0 ${W} ${h}`} style={{width:"100%",height:h,display:"block",position:"absolute",top:0,left:0}} preserveAspectRatio="none">
      <defs><linearGradient id={gId} x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stopColor={color} stopOpacity="0.2"/><stop offset="100%" stopColor={color} stopOpacity="0"/></linearGradient></defs>
      {linePath?<>
        <path d={fillPath} fill={`url(#${gId})`}/>
        <path d={linePath} fill="none" stroke={color} strokeWidth="2" strokeLinejoin="round" strokeLinecap="round"/>
      </>:<>
        <polygon points={fillPath} fill={`url(#${gId})`}/>
        <polyline points={coords.map(c=>c.x+","+c.y).join(" ")} fill="none" stroke={color} strokeWidth="2" strokeLinejoin="round"/>
      </>}
    </svg>
    {pcts.map((p,i)=>{const isLast=i===pcts.length-1;const isHov=hov===i;const isHl=highlightIdx!==undefined&&highlightIdx!==null&&i===highlightIdx;return <div key={i} onMouseEnter={()=>setHov(i)} onMouseLeave={()=>setHov(null)} onClick={()=>onDotClick&&onDotClick(i)} style={{position:"absolute",left:p.x+"%",top:p.y+"%",transform:"translate(-50%,-50%)",cursor:onDotClick?"pointer":"default",padding:8}}>
      {labels&&<div style={{position:"absolute",bottom:"100%",left:"50%",transform:"translateX(-50%)",marginBottom:2,fontSize:9,fontWeight:700,fontFamily:T.mono,color:isHl?"#fff":isLast?color:isHov?T.t:T.mut,whiteSpace:"nowrap",transition:"color .15s"}}>{labels[i]}</div>}
      <div style={{width:isHl?10:isLast?8:isHov?7:5,height:isHl?10:isLast?8:isHov?7:5,borderRadius:"50%",background:isHl?"#fff":isLast?color:isHov?color:T.bg,border:`1.5px solid ${isHl?"#fff":color}`,transition:"all .15s",boxShadow:isHl?"0 0 8px rgba(255,255,255,0.5)":"none"}}/>
    </div>})}
  </div>;
}
// Big profile placeholder (2x)
function Pfp({name,gender,size=64}) {
  const bg=gender==="Kvinna"?`linear-gradient(135deg,${T.pnk}40,${T.pur}40)`:`linear-gradient(135deg,${T.blu}40,${T.cyn}40)`;
  return <div style={{width:size,height:size,borderRadius:size*0.3,background:bg,display:"flex",alignItems:"center",justifyContent:"center",fontSize:size*0.35,fontWeight:800,color:"rgba(255,255,255,0.6)",flexShrink:0,border:"1px solid rgba(255,255,255,0.06)"}}>{name.charAt(0)}{name.split(" ")[1]?.charAt(0)||""}</div>;
}
// Slider component
function Slider({label,value,min,max,step,unit,color,onChange,disabled}) {
  return <div style={{marginBottom:10}}>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}>
      <span style={{fontSize:10,color:T.dim,fontWeight:700,textTransform:"uppercase"}}>{label}</span>
      <span style={{fontSize:14,fontWeight:800,color:color||T.t,fontFamily:T.mono}}>{value}{unit||""}</span>
    </div>
    <input type="range" min={min} max={max} step={step||1} value={value} onChange={e=>onChange(Number(e.target.value))} disabled={disabled} style={{width:"100%",accentColor:color||T.acc,height:4,cursor:disabled?"not-allowed":"pointer",opacity:disabled?0.4:1}}/>
  </div>;
}
function calcM(cl,ov={}) {
  const w=parseFloat(ov.weight)||cl.curW||cl.startW,h=cl.height,age=cl.age,isMale=cl.gender==="Man";
  const act=parseFloat(ov.activity||cl.activity||"1.55");
  const bmr=isMale?10*w+6.25*h-5*age+5:10*w+6.25*h-5*age-161;
  const tdee=Math.round(bmr*act);
  const adj=cl.goal==="lose"?-500:cl.goal==="build"?300:0;
  return {tdee,cal:tdee+adj};
}

// ===================== DASHBOARD =====================
function Dashboard({clients,onOpen}) {
  // Split: ready (form submitted, timer ticking) vs waiting (no form yet) vs in-fas
  const ready=clients.filter(c=>(c.status==="new_signup"||c.status==="pending_review")&&c.form).sort((a,b)=>a.hoursLeft-b.hoursLeft);
  const waiting=clients.filter(c=>c.status==="new_signup"&&!c.form);
  const inFas=clients.filter(c=>c.status==="active").sort((a,b)=>a.nextReviewIn-b.nextReviewIn);
  const [showFas,setShowFas]=useState(false);

  return <div>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"baseline",marginBottom:20}}>
      <h2 style={{fontSize:22,fontWeight:800,margin:0,letterSpacing:-0.5}}>Dashboard</h2>
      <span style={{fontSize:12,color:T.mut}}>{clients.length} klienter</span>
    </div>

    {ready.length===0&&waiting.length===0&&<div style={{textAlign:"center",padding:"30px 0",color:T.mut,fontSize:13}}>Alla klienter i fas</div>}

    {ready.map(c=>{
      const isNew=c.status==="new_signup";
      const totalH=isNew?48:24;
      const ratio=c.hoursLeft/totalH;
      const urgColor=ratio<=0.25?T.red:ratio<=0.5?T.yel:T.grn;
      return <Card key={c.id} onClick={()=>onOpen(c,isNew?"onboard":"review")} style={{marginBottom:8,padding:"16px 18px"}}>
        <div style={{display:"flex",alignItems:"center",gap:16}}>
          {/* Countdown ring ‚Äî bigger */}
          <div style={{position:"relative",width:64,height:64,flexShrink:0}}>
            <svg width={64} height={64} style={{transform:"rotate(-90deg)"}}><circle cx={32} cy={32} r={27} fill="none" stroke="rgba(255,255,255,0.06)" strokeWidth={3}/><circle cx={32} cy={32} r={27} fill="none" stroke={urgColor} strokeWidth={3} strokeLinecap="round" strokeDasharray={Math.PI*54} strokeDashoffset={Math.PI*54*(1-ratio)} style={{transition:"stroke-dashoffset .5s ease"}}/></svg>
            <div style={{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"}}>
              <div style={{fontSize:22,fontWeight:800,color:urgColor,lineHeight:1}}>{c.hoursLeft}</div>
              <div style={{fontSize:8,color:T.mut,textTransform:"uppercase",letterSpacing:0.5,marginTop:1}}>tim</div>
            </div>
          </div>
          {/* Info */}
          <div style={{flex:1,minWidth:0}}>
            <div style={{fontSize:15,fontWeight:800,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",marginBottom:4}}>{c.name}</div>
            <span style={{fontSize:10,padding:"3px 10px",borderRadius:10,background:isNew?"rgba(59,130,246,0.1)":"rgba(245,158,11,0.1)",color:isNew?T.blu:T.yel,fontWeight:700,letterSpacing:0.3}}>{isNew?"Onboarding":"Granska vecka"}</span>
          </div>
          {/* Profile pic */}
          <Pfp name={c.name} gender={c.gender} size={48}/>
        </div>
      </Card>;
    })}

    {/* Waiting for form - no timer, separate */}
    {waiting.map(c=><Card key={c.id} onClick={()=>onOpen(c,"onboard")} style={{marginBottom:8,padding:"16px 18px",opacity:0.6}}>
      <div style={{display:"flex",alignItems:"center",gap:16}}>
        <div style={{width:64,height:64,borderRadius:"50%",border:"2px dashed rgba(255,255,255,0.1)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flexShrink:0}}>
          <div style={{fontSize:16,color:T.mut}}>‚è≥</div>
        </div>
        <div style={{flex:1,minWidth:0}}>
          <div style={{fontSize:15,fontWeight:800,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",marginBottom:4}}>{c.name}</div>
          <span style={{fontSize:10,color:T.yel,fontWeight:600}}>Formul√§r ej inskickat</span>
        </div>
        <Pfp name={c.name} gender={c.gender} size={48}/>
      </div>
    </Card>)}

    {/* I fas - closed by default */}
    {inFas.length>0&&<div style={{marginTop:20}}>
      <div onClick={()=>setShowFas(!showFas)} style={{display:"flex",alignItems:"center",gap:8,cursor:"pointer",padding:"4px 0"}}>
        <div style={{flex:1,height:1,background:T.brd}}/>
        <span style={{fontSize:10,color:T.grn,fontWeight:600}}>{showFas?"\u25BE":"\u25B8"} I fas ({inFas.length})</span>
        <div style={{flex:1,height:1,background:T.brd}}/>
      </div>
      {showFas&&<div style={{marginTop:6}}>{inFas.map(c=><Card key={c.id} onClick={()=>onOpen(c,"review")} style={{marginBottom:8,padding:"16px 18px",borderColor:"rgba(34,197,94,0.08)"}}>
        <div style={{display:"flex",alignItems:"center",gap:16}}>
          <div style={{width:64,height:64,borderRadius:"50%",background:"rgba(34,197,94,0.06)",border:"2px solid rgba(34,197,94,0.15)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",flexShrink:0}}>
            <div style={{fontSize:13,fontWeight:800,color:T.grn,lineHeight:1}}>V{c.wkC}</div>
            <div style={{fontSize:8,color:T.mut,marginTop:1}}>/{c.wkT}</div>
          </div>
          <div style={{flex:1,minWidth:0}}>
            <div style={{fontSize:15,fontWeight:800}}>{c.name}</div>
          </div>
          <Pfp name={c.name} gender={c.gender} size={48}/>
        </div>
      </Card>)}</div>}
    </div>}
  </div>;
}

// ===================== CLIENT PANEL =====================
function ClientPanel({client:c,open,onToggle}) {
  if(!c) return null;
  const SA_ICONS_P={Trott:"\u{1F634}",Pigg:"\u{1F4AA}",Bra:"\u{1F60A}",Dalig:"\u{1F614}","Perfekt utmanande":"\u{1F3AF}","For latt":"\u2B06","For svart":"\u2B07"};
  return <>
    {/* Backdrop blur */}
    {open&&<div onClick={onToggle} style={{position:"fixed",inset:0,zIndex:35,background:"rgba(0,0,0,0.4)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",transition:"opacity .3s"}}/>}
    {/* Tab toggle ‚Äî always fixed center */}
    <div onClick={onToggle} style={{position:"fixed",left:open?"45vw":0,top:"50%",transform:"translateY(-50%)",zIndex:50,background:"rgba(255,255,255,0.04)",border:"1px solid "+T.brd,borderRadius:"0 8px 8px 0",padding:"14px 6px",cursor:"pointer",transition:"left .3s ease",writingMode:"vertical-rl",fontSize:10,fontWeight:700,color:T.dim,letterSpacing:1}}>{open?"\u25C0":"\u25B6"} {c.name.split(" ")[0]}</div>
    {/* Panel */}
    <div style={{position:"fixed",left:0,top:0,bottom:0,width:"45vw",background:"rgba(26,26,26,0.98)",borderRight:"1px solid "+T.brd,zIndex:40,transform:open?"translateX(0)":"translateX(-100%)",transition:"transform .3s ease",overflowY:"auto",padding:"24px 28px"}}>
      <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:16}}>
        <Pfp name={c.name} gender={c.gender} size={52}/>
        <div style={{flex:1}}>
          <div style={{fontSize:15,fontWeight:800}}>{c.name}</div>
          <div style={{fontSize:10,color:T.dim,marginBottom:4}}>{c.gender} ¬∑ {c.age} √•r ¬∑ {c.height} cm ¬∑ {c.curW} kg</div>
          <div style={{display:"flex",gap:6,marginBottom:6}}>
            {[[c.goal==="lose"?"G√• ner":c.goal==="build"?"Bygga":"Underh√•ll",c.goal==="lose"?T.grn:T.blu],[c.split,T.dim],[c.level,T.dim]].map(([v,col],i)=><span key={i} style={{fontSize:9,fontWeight:600,padding:"2px 6px",borderRadius:4,background:col+"15",color:col,border:"1px solid "+col+"25"}}>{v}</span>)}
          </div>
          {c.wkT>0&&<div style={{display:"flex",alignItems:"center",gap:8}}>
            <div style={{flex:1,height:4,borderRadius:2,background:"rgba(255,255,255,0.06)",overflow:"hidden"}}>
              <div style={{width:Math.round((c.wkC/c.wkT)*100)+"%",height:"100%",borderRadius:2,background:`linear-gradient(90deg, ${T.acc}90, ${T.acc})`,transition:"width .4s ease"}}/>
            </div>
            <span style={{fontSize:9,fontWeight:700,fontFamily:T.mono,color:T.dim,whiteSpace:"nowrap"}}>V{c.wkC}/{c.wkT}</span>
          </div>}
        </div>
      </div>

      {c.selfAssess&&<div style={{marginBottom:20}}>
        <Lbl>Sj√§lvskattning</Lbl>
        <div style={{display:"flex",flexDirection:"column",gap:6}}>
          {[["Sv√•righet",c.selfAssess.difficulty],["Energi",c.selfAssess.energy],["M√•ende",c.selfAssess.mood]].map(([label,val])=>val&&<div key={label} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"6px 10px",background:"rgba(255,255,255,0.02)",borderRadius:6}}>
            <span style={{fontSize:10,color:T.dim}}>{label}</span>
            <span style={{fontSize:12,fontWeight:600}}>{SA_ICONS_P[val]||""} {val}</span>
          </div>)}
        </div>
      </div>}

      {c.message&&<div style={{marginBottom:20}}>
        <Lbl>Meddelande</Lbl>
        <div style={{padding:12,background:"rgba(255,255,255,0.03)",borderRadius:10,fontSize:12,color:T.dim,lineHeight:1.5,fontStyle:"italic",borderLeft:"2px solid "+T.acc}}>"{c.message}"</div>
      </div>}

      <div style={{display:"flex",flexDirection:"column",gap:6,marginBottom:16}}>
        {[
          ["Tr√§ningsdagar",c.split.replace("D"," dagar/veckan")],
          ["M√•l",c.goal==="build"?"Bygga muskler":"G√• ner i vikt"],
          ["Erfarenhet",c.level],
          ["Kost",c.diet||"Inga restriktioner"],
        ].map(([k,v],i)=><div key={i} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:"1px solid rgba(255,255,255,0.03)"}}>
          <span style={{fontSize:11,color:T.mut}}>{k}</span>
          <span style={{fontSize:11,fontWeight:600}}>{v}</span>
        </div>)}
      </div>

      {c.notes&&<div style={{marginBottom:20}}>
        <Lbl>Anteckningar</Lbl>
        <div style={{padding:10,background:"rgba(255,255,255,0.02)",borderRadius:8,fontSize:11,color:T.dim,fontStyle:"italic"}}>"{c.notes}"</div>
      </div>}

      {c.wIns.length>1&&<div style={{marginBottom:12}}><Lbl>Viktkurva</Lbl><Chart data={c.wIns.map(w=>w.kg)} h={50} color={c.goal==="lose"?T.grn:T.blu}/><div style={{display:"flex",justifyContent:"space-between",fontSize:9,color:T.mut,marginTop:2}}><span>{c.startW}kg</span><span>{c.curW}kg</span></div></div>}

      {c.prs.length>0&&<div><Lbl>PRs</Lbl><div style={{display:"flex",gap:4,flexWrap:"wrap"}}>{c.prs.map((pr,i)=><div key={i} style={{padding:"3px 7px",background:T.accD,borderRadius:6,fontSize:10}}><span style={{color:T.dim}}>{pr.ex} </span><span style={{fontWeight:800,color:T.acc}}>{pr.kg}kg</span></div>)}</div></div>}
    </div>
  </>;
}

// ===================== STEPS =====================
function Steps({steps,current,maxReached,onClick}) {
  return <div style={{display:"flex",gap:0,marginBottom:24,overflowX:"auto",paddingBottom:4}}>{steps.map((s,i)=>{const clickable=onClick&&i<=maxReached;return <div key={i} style={{display:"flex",alignItems:"center",flex:i<steps.length-1?1:"none"}}><div onClick={()=>clickable&&onClick(i)} style={{display:"flex",alignItems:"center",gap:4,cursor:clickable?"pointer":"default"}}><div style={{width:20,height:20,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:8,fontWeight:700,background:i<=current?T.acc:i<=maxReached?"rgba(255,255,255,0.15)":"rgba(255,255,255,0.06)",color:i<=current?"#fff":i<=maxReached?T.t:T.mut}}>{i<current?"\u2713":i+1}</div><span style={{fontSize:9,fontWeight:600,color:i<=current?T.t:i<=maxReached?T.dim:T.mut,whiteSpace:"nowrap"}}>{s}</span></div>{i<steps.length-1&&<div style={{flex:1,height:1,background:i<current?T.acc:i<maxReached?"rgba(255,255,255,0.15)":"rgba(255,255,255,0.06)",margin:"0 4px"}}/>}</div>})}</div>;
}

// ===================== STEP 1: ASSESSMENT =====================
function StepAssess({client:c,assess,setAssess,onNext}) {
  return <div>
    <div style={{marginBottom:14}}>
      <div style={{fontSize:10,color:T.mut,marginBottom:4}}>SPLIT</div>
      <div style={{display:"flex",gap:4,flexWrap:"wrap"}}>{["2D","3D","4D","5D"].map(s=><Pill key={s} active={assess.split===s} onClick={()=>setAssess({...assess,split:s})}>{s}</Pill>)}</div>
    </div>
    <div style={{marginBottom:14}}>
      <div style={{fontSize:10,color:T.mut,marginBottom:4}}>NIVA</div>
      <div style={{display:"flex",gap:4}}>{["Nyborjare","Medel","Avancerad"].map(l=><Pill key={l} active={assess.level===l} onClick={()=>setAssess({...assess,level:l})}>{l}</Pill>)}</div>
    </div>
    <div style={{marginBottom:14}}>
      <div style={{fontSize:10,color:T.mut,marginBottom:4}}>MAL</div>
      <div style={{display:"flex",gap:4}}>{[["lose","Ga ner"],["build","Bygga"]].map(([v,l])=><Pill key={v} active={assess.goal===v} onClick={()=>setAssess({...assess,goal:v})}>{l}</Pill>)}</div>
    </div>
    <div style={{marginBottom:14}}>
      <div style={{fontSize:10,color:T.mut,marginBottom:4}}>VECKOR</div>
      <div style={{display:"flex",gap:4}}>{["4","8","12","16"].map(w=><Pill key={w} active={assess.weeks===w} onClick={()=>setAssess({...assess,weeks:w})}>{w}v</Pill>)}</div>
    </div>
    <Btn onClick={onNext} disabled={!c.form} full>Klar, valj mall</Btn>
  </div>;
}

// ===================== STEP 2: TEMPLATE PICKER =====================
function StepTemplatePick({assess,templates,tplGroups,onSelect,onScratch}) {
  const [collapsed,setCollapsed]=useState(()=>{const init={};tplGroups.forEach(g=>{init[g]=g!=="Favoriter"});return init;});
  const [newG,setNewG]=useState("");
  const filtered=templates.filter(t=>t.split===assess.split);
  const groups=[...new Set([...tplGroups,...filtered.map(t=>t.cat)])];
  return <div>
    <div style={{fontSize:10,color:T.mut,marginBottom:8}}>Visar mallar for {assess.split}</div>
    {groups.map(gname=>{const gT=filtered.filter(t=>t.cat===gname);const isCol=collapsed[gname];const isFav=gname==="Favoriter";return <div key={gname} style={{marginBottom:4}}>
      <div onClick={()=>setCollapsed(p=>({...p,[gname]:!p[gname]}))} style={{display:"flex",alignItems:"center",gap:6,padding:"8px 10px",borderRadius:8,cursor:"pointer",background:"rgba(255,255,255,0.02)"}}>
        <span style={{fontSize:10,color:T.mut}}>{isCol?"\u25B8":"\u25BE"}</span>
        <span style={{fontSize:12,fontWeight:600,flex:1}}>{isFav&&"\u2605 "}{gname}</span>
        <span style={{fontSize:10,color:T.mut}}>{gT.length}</span>
      </div>
      {!isCol&&<div style={{marginTop:2}}>{gT.length===0?<div style={{fontSize:11,color:T.mut,padding:"6px 16px"}}>Inga mallar</div>:gT.map(t=><div key={t.id} onClick={()=>onSelect(t)} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 16px",cursor:"pointer",borderBottom:"1px solid rgba(255,255,255,0.02)"}}>
        <div><div style={{fontSize:13,fontWeight:600}}>{t.name}</div><div style={{fontSize:10,color:T.mut}}>{t.days.length} dagar | {t.days.reduce((a,d)=>a+d.ex.length,0)} ovningar</div></div>
        {t.used>0&&<span style={{fontSize:9,color:T.mut,fontFamily:T.mono,marginRight:8}}>{t.used}x</span>}
      </div>)}</div>}
    </div>;})}
    <div style={{display:"flex",gap:6,marginTop:10}}><input value={newG} onChange={e=>setNewG(e.target.value)} placeholder="+ Ny kategori..." onKeyDown={e=>{if(e.key==="Enter"&&newG.trim()){tplGroups.push(newG.trim());setCollapsed(p=>({...p,[newG.trim()]:true}));setNewG("")}}} style={{flex:1,padding:"6px 10px",borderRadius:8,border:"1px dashed "+T.brd,background:"transparent",color:T.t,fontSize:12,fontFamily:T.f,outline:"none"}}/></div>
    <div onClick={onScratch} style={{marginTop:10,padding:12,border:"1px dashed rgba(255,255,255,0.06)",borderRadius:10,textAlign:"center",cursor:"pointer",fontSize:12,color:T.dim}}>Borja fran scratch</div>
  </div>;
}

const REP_RANGES=["1-2","2-4","4-6","6-8","8-10","10-12","12-15","15-20"];
function RepPicker({value,onChange}) {
  const [open,setOpen]=useState(false);
  return <div style={{position:"relative"}}>
    <div onClick={()=>setOpen(!open)} style={{background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:6,color:T.t,fontSize:13,fontFamily:T.mono,padding:"4px 8px",cursor:"pointer",minWidth:44,textAlign:"center",fontWeight:500,userSelect:"none"}}>{value}</div>
    {open&&<div style={{position:"absolute",top:"100%",left:"50%",transform:"translateX(-50%)",zIndex:20,marginTop:4,background:"#1a1a1a",border:"1px solid "+T.brd,borderRadius:8,padding:4,minWidth:80,boxShadow:"0 8px 24px rgba(0,0,0,0.5)"}}>
      {REP_RANGES.map(r=><button key={r} onClick={()=>{onChange(r);setOpen(false)}} style={{display:"block",width:"100%",background:r===value?T.accD:"none",border:"none",color:r===value?T.acc:T.dim,fontSize:12,cursor:"pointer",padding:"5px 10px",fontFamily:T.mono,textAlign:"center",borderRadius:4,fontWeight:r===value?700:400,whiteSpace:"nowrap"}}>{r}</button>)}
    </div>}
  </div>;
}
function SetPicker({value,onChange}) {
  const [open,setOpen]=useState(false);
  return <div style={{position:"relative"}}>
    <div onClick={()=>setOpen(!open)} style={{background:"rgba(255,255,255,0.05)",border:"1px solid rgba(255,255,255,0.08)",borderRadius:6,color:T.acc,fontSize:13,fontFamily:T.mono,padding:"4px 8px",cursor:"pointer",minWidth:28,textAlign:"center",fontWeight:700,userSelect:"none"}}>{value}</div>
    {open&&<div style={{position:"absolute",top:"100%",left:"50%",transform:"translateX(-50%)",zIndex:20,marginTop:4,background:"#1a1a1a",border:"1px solid "+T.brd,borderRadius:8,padding:4,minWidth:50,boxShadow:"0 8px 24px rgba(0,0,0,0.5)"}}>
      {[1,2,3,4,5].map(n=><button key={n} onClick={()=>{onChange(n);setOpen(false)}} style={{display:"block",width:"100%",background:n===value?T.accD:"none",border:"none",color:n===value?T.acc:T.dim,fontSize:12,cursor:"pointer",padding:"5px 10px",fontFamily:T.mono,textAlign:"center",borderRadius:4,fontWeight:n===value?700:400,whiteSpace:"nowrap"}}>{n}</button>)}
    </div>}
  </div>;
}

// ===================== STEP 3: FINETUNE =====================
function StepFinetune({days,setDays,tplName,onNext}) {
  const [activeDay,setActiveDay]=useState(0);
  const [addOpen,setAddOpen]=useState(false);
  const [exS,setExS]=useState("");
  const filtE=exS?EX_DB.filter(e=>e.name.toLowerCase().includes(exS.toLowerCase())):[];
  const day=days[activeDay];
  const updEx=(eId,fld,val)=>setDays(p=>p.map((d,i)=>i===activeDay?{...d,exercises:d.exercises.map(e=>e.id===eId?{...e,[fld]:val}:e)}:d));
  const rmEx=(eId)=>setDays(p=>p.map((d,i)=>i===activeDay?{...d,exercises:d.exercises.filter(e=>e.id!==eId)}:d));
  const moveEx=(eId,dir)=>setDays(p=>p.map((d,i)=>{if(i!==activeDay)return d;const exs=[...d.exercises];const idx=exs.findIndex(e=>e.id===eId);const ni=idx+dir;if(ni<0||ni>=exs.length)return d;[exs[idx],exs[ni]]=[exs[ni],exs[idx]];return{...d,exercises:exs}}));
  const addE=(name,muscle)=>{setDays(p=>p.map((d,i)=>i===activeDay?{...d,exercises:[...d.exercises,{id:"e"+Date.now(),n:name,s:3,r:"10-12",m:muscle}]}:d));setAddOpen(false);setExS("")};
  const [swapId,setSwapId]=useState(null);
  const [editingDay,setEditingDay]=useState(null);
  const [obDrag,setObDrag]=useState({idx:null,overIdx:null});
  const reorderEx=(fromIdx,toIdx)=>{if(fromIdx===toIdx)return;setDays(p=>p.map((d,i)=>{if(i!==activeDay)return d;const exs=[...d.exercises];const [moved]=exs.splice(fromIdx,1);exs.splice(toIdx,0,moved);return{...d,exercises:exs}}));};
  const renameDay=(i,name)=>{setDays(p=>p.map((d,di)=>di===i?{...d,name}:d));setEditingDay(null);};
  if(!day) return null;
  return <div>
    {/* Day titles as navigation */}
    <div style={{display:"flex",alignItems:"flex-end",gap:20,marginBottom:6,height:34}}>
      {days.map((d,i)=><div key={i} onClick={()=>{setActiveDay(i);setAddOpen(false);setSwapId(null)}} onDoubleClick={()=>setEditingDay(i)} style={{cursor:"pointer",transition:"all .15s"}}>
        {editingDay===i?<input autoFocus value={d.name} onChange={e=>setDays(p=>p.map((dd,di)=>di===i?{...dd,name:e.target.value}:dd))} onBlur={()=>setEditingDay(null)} onKeyDown={e=>{if(e.key==="Enter")setEditingDay(null)}} style={{fontSize:i===activeDay?26:15,fontWeight:800,letterSpacing:-0.5,color:T.acc,lineHeight:1,background:"transparent",border:"none",borderBottom:"1px solid "+T.acc,outline:"none",fontFamily:T.f,width:Math.max(60,d.name.length*14),padding:0}}/>:<div style={{fontSize:i===activeDay?26:15,fontWeight:800,letterSpacing:-0.5,color:i===activeDay?T.t:"rgba(255,255,255,0.18)",transition:"all .15s",lineHeight:1}}>{d.name}</div>}
      </div>)}
    </div>
    <div style={{fontSize:10,color:T.mut,marginBottom:20}}>{tplName||"Scratch"} | Dag {activeDay+1} av {days.length}</div>
    {/* Exercises */}
    <div style={{marginBottom:16}}>
      {day.exercises.map((ex,idx)=><div key={ex.id} draggable
        onDragStart={e=>{e.dataTransfer.effectAllowed="move";setObDrag({idx,overIdx:null})}}
        onDragOver={e=>{e.preventDefault();if(obDrag.overIdx!==idx)setObDrag(p=>({...p,overIdx:idx}))}}
        onDrop={e=>{e.preventDefault();if(obDrag.idx!==null)reorderEx(obDrag.idx,idx);setObDrag({idx:null,overIdx:null})}}
        onDragEnd={()=>setObDrag({idx:null,overIdx:null})}
        onTouchStart={e=>{const t=setTimeout(()=>{setObDrag({idx,overIdx:null});e.currentTarget.style.opacity="0.5"},300);e.currentTarget._ht=t}}
        onTouchMove={e=>{if(obDrag.idx===null)return;const touch=e.touches[0];const el=document.elementFromPoint(touch.clientX,touch.clientY);if(el){const row=el.closest("[data-obidx]");if(row){const oi=parseInt(row.dataset.obidx);if(!isNaN(oi))setObDrag(p=>({...p,overIdx:oi}))}}}}
        onTouchEnd={e=>{clearTimeout(e.currentTarget._ht);e.currentTarget.style.opacity="1";if(obDrag.idx!==null&&obDrag.overIdx!==null)reorderEx(obDrag.idx,obDrag.overIdx);setObDrag({idx:null,overIdx:null})}}
        data-obidx={idx}
        style={{opacity:obDrag.idx===idx?0.4:1,borderTop:obDrag.overIdx===idx&&obDrag.idx!==idx?"2px solid "+T.acc:"2px solid transparent",transition:"border-top .1s, opacity .1s",cursor:"grab"}}>
        <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"10px 0"}}>
        {/* Drag handle + Image + Name */}
        <div style={{display:"flex",alignItems:"center",gap:10,flex:"0 1 40%",minWidth:0}}>
          <div style={{display:"flex",flexDirection:"column",gap:1.5,cursor:"grab",padding:"4px 2px",opacity:0.25,flexShrink:0}}>
            <div style={{width:12,height:1.5,background:"#fff",borderRadius:1}}/>
            <div style={{width:12,height:1.5,background:"#fff",borderRadius:1}}/>
            <div style={{width:12,height:1.5,background:"#fff",borderRadius:1}}/>
          </div>
          <div style={{width:36,height:36,borderRadius:8,background:MC[ex.m]?MC[ex.m]+"15":"rgba(255,255,255,0.03)",border:"1px solid "+(MC[ex.m]?MC[ex.m]+"25":"rgba(255,255,255,0.05)"),display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}><div style={{width:4,height:4,borderRadius:"50%",background:MC[ex.m]||T.mut}}/></div>
          <div style={{position:"relative",minWidth:0,flex:1}}>
            <div onClick={()=>setSwapId(swapId===ex.id?null:ex.id)} style={{color:"#fff",fontSize:13,fontFamily:T.f,fontWeight:600,cursor:"pointer",whiteSpace:"nowrap",overflow:"hidden",textOverflow:"ellipsis"}}>{ex.n}</div>
            {swapId===ex.id&&<div style={{position:"absolute",top:"100%",left:0,zIndex:20,marginTop:4,background:"#1a1a1a",border:"1px solid "+T.brd,borderRadius:8,padding:4,minWidth:220,maxHeight:180,overflowY:"auto",boxShadow:"0 8px 24px rgba(0,0,0,0.5)"}}>
              <div style={{fontSize:9,color:T.mut,padding:"4px 6px",textTransform:"uppercase",fontWeight:700}}>{ex.m}</div>
              {EX_DB.filter(e=>e.muscle===ex.m&&e.name!==ex.n).map((e,i)=><button key={i} onClick={()=>{updEx(ex.id,"n",e.name);setSwapId(null)}} style={{display:"block",width:"100%",background:"none",border:"none",color:T.dim,fontSize:12,cursor:"pointer",padding:"5px 8px",fontFamily:T.f,textAlign:"left",borderRadius:4,whiteSpace:"nowrap"}}>{e.name}</button>)}
            </div>}
          </div>
        </div>
        {/* Reps x Sets */}
        <div style={{display:"flex",alignItems:"center",gap:4}}>
          <RepPicker value={ex.r} onChange={v=>updEx(ex.id,"r",v)}/>
          <span style={{color:T.mut,fontSize:11,fontWeight:600}}>x</span>
          <SetPicker value={ex.s} onChange={v=>updEx(ex.id,"s",v)}/>
        </div>
        {/* Remove */}
        <button onClick={()=>rmEx(ex.id)} style={{background:"none",border:"none",color:"rgba(255,255,255,0.1)",cursor:"pointer",fontSize:14,padding:"0 3px"}}>√ó</button>
        </div>
        {idx<day.exercises.length-1&&<div style={{height:1,background:`linear-gradient(90deg, ${MC[ex.m]||"rgba(255,255,255,0.04)"}25, rgba(255,255,255,0.04) 50%, transparent)`}}/>}
      </div>)}
      {addOpen?<div style={{marginTop:8}}>
        <Input placeholder="Sok ovning..." value={exS} onChange={setExS} small/>
        {exS&&<div style={{maxHeight:140,overflowY:"auto",marginTop:4,background:"rgba(255,255,255,0.02)",borderRadius:6,padding:4}}>{filtE.length===0?<div style={{color:T.mut,fontSize:11,padding:6}}>Ingen match</div>:filtE.slice(0,8).map((e,i)=><button key={i} onClick={()=>addE(e.name,e.muscle)} style={{display:"flex",alignItems:"center",gap:5,width:"100%",background:"none",border:"none",color:T.dim,fontSize:11,cursor:"pointer",padding:"4px 6px",fontFamily:T.f,textAlign:"left"}}><span style={{width:5,height:5,borderRadius:"50%",background:MC[e.muscle]||T.mut}}/>{e.name}</button>)}</div>}
        <Btn v="ghost" onClick={()=>{setAddOpen(false);setExS("")}} style={{marginTop:3,fontSize:10}}>Avbryt</Btn>
      </div>:<button onClick={()=>setAddOpen(true)} style={{marginTop:8,background:"none",border:"1px dashed rgba(255,255,255,0.06)",borderRadius:8,color:T.mut,padding:"6px",cursor:"pointer",fontFamily:T.f,fontSize:11,width:"100%"}}>+ Lagg till</button>}
    </div>
    <Btn onClick={onNext} full>Klar, granska</Btn>
  </div>;
}

// ===================== STEP 4: REVIEW =====================
function StepReviewProg({days,onNext}) {
  return <div>
    {days.map((d,i)=><div key={i} style={{marginBottom:16}}>
      <div style={{fontSize:16,fontWeight:800,marginBottom:6}}>{d.name}</div>
      {d.exercises.map((e,j)=><div key={j} style={{padding:"4px 0",fontSize:12,color:T.dim,display:"flex",alignItems:"center",gap:6}}>
        <span style={{width:4,height:4,borderRadius:"50%",background:MC[e.m]||T.mut,flexShrink:0}}/>
        <span style={{color:T.t,fontWeight:500}}>{e.n}</span>
        <span style={{marginLeft:"auto",fontFamily:T.mono,fontSize:11,color:T.mut}}>{e.r} x {e.s}</span>
      </div>)}
    </div>)}
    <Btn onClick={onNext} full>Klar, makron</Btn>
  </div>;
}

// ===================== MACRO VALUE (double-click to edit) =====================
function MacroVal({value,color,unit,size,onChange}) {
  const [editing,setEditing]=useState(false);
  const [tmp,setTmp]=useState(String(value));
  const commit=()=>{const n=parseInt(tmp,10);if(!isNaN(n)&&n>=0)onChange(n);setEditing(false);};
  if(editing) return <input autoFocus value={tmp} onChange={e=>setTmp(e.target.value)} onBlur={commit} onKeyDown={e=>{if(e.key==="Enter")commit()}} style={{fontSize:size,fontWeight:800,color,fontFamily:T.mono,background:"transparent",border:"none",borderBottom:"1px solid "+color,outline:"none",width:Math.max(50,(String(value).length+2)*size*0.6),textAlign:"right",padding:0}}/>;
  return <span onDoubleClick={()=>{setTmp(String(value));setEditing(true)}} style={{fontSize:size,fontWeight:800,color,fontFamily:T.mono,cursor:"default"}}>{value}{unit}</span>;
}

// ===================== STEP 5: MACROS =====================
function StepMacros({client,onNext}) {
  const base=calcM(client);
  const w=client.curW||client.startW;
  const [p,setP]=useState(Math.round(w*2));
  const [c,setC]=useState(220);
  const [f,setF]=useState(60);
  const [gkg,setGkg]=useState(false);
  const [gkgOpen,setGkgOpen]=useState(false);
  const GKG_OPTS=[1.6,1.8,2.0,2.2,2.5];
  const [gkgVal,setGkgVal]=useState(2.0);
  const pActual=gkg?Math.round(w*gkgVal):p;
  const cal=pActual*4+c*4+f*9;
  return <div style={{display:"flex",flexDirection:"column",alignItems:"center"}}>
    {/* TDEE + g/kg row */}
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",width:"100%",marginBottom:16}}>
      <div style={{fontSize:10,color:T.mut}}>TDEE {base.tdee} kcal</div>
      <div style={{position:"relative"}}>
        <div onClick={()=>setGkgOpen(!gkgOpen)} style={{background:gkg?"rgba(59,130,246,0.1)":"rgba(255,255,255,0.05)",border:"1px solid "+(gkg?"rgba(59,130,246,0.2)":"rgba(255,255,255,0.08)"),borderRadius:6,padding:"4px 10px",cursor:"pointer",fontSize:11,color:gkg?T.blu:T.dim,fontWeight:600}}>{gkg?"Protein "+gkgVal+" g/kg":"Protein g/kg"}</div>
        {gkgOpen&&<div style={{position:"absolute",top:"100%",right:0,zIndex:20,marginTop:4,background:"#1a1a1a",border:"1px solid "+T.brd,borderRadius:8,padding:4,minWidth:100,boxShadow:"0 8px 24px rgba(0,0,0,0.5)"}}>
          {gkg&&<button onClick={()=>{setGkg(false);setGkgOpen(false)}} style={{display:"block",width:"100%",background:"none",border:"none",color:T.dim,fontSize:11,cursor:"pointer",padding:"5px 8px",fontFamily:T.f,textAlign:"left",borderRadius:4}}>Av</button>}
          {GKG_OPTS.map(v=><button key={v} onClick={()=>{setGkg(true);setGkgVal(v);setP(Math.round(w*v));setGkgOpen(false)}} style={{display:"block",width:"100%",background:gkg&&gkgVal===v?T.accD:"none",border:"none",color:gkg&&gkgVal===v?T.blu:T.dim,fontSize:11,cursor:"pointer",padding:"5px 8px",fontFamily:T.mono,textAlign:"left",borderRadius:4,fontWeight:gkg&&gkgVal===v?700:400}}>{v} g/kg</button>)}
        </div>}
      </div>
    </div>
    
    {/* 1. KCAL ‚Äî auto-calculated, top of pyramid */}
    <div style={{fontSize:9,color:T.mut,textTransform:"uppercase",letterSpacing:3,marginBottom:4}}>Dagligt m√•l</div>
    <div style={{fontSize:32,fontWeight:800,fontFamily:T.mono,color:T.acc,lineHeight:1}}>{cal}<span style={{fontSize:12,fontWeight:600,color:T.dim}}> kcal</span></div>
    <div style={{display:"flex",gap:16,marginTop:8,marginBottom:20}}>
      {[["Protein",pActual,T.blu],["Kolhydrater",c,T.yel],["Fett",f,T.red]].map(([l,v,col])=>
        <div key={l} style={{textAlign:"center"}}>
          <div style={{fontSize:16,fontWeight:800,fontFamily:T.mono,color:col}}>{v}<span style={{fontSize:9,fontWeight:600}}>g</span></div>
          <div style={{fontSize:8,color:T.mut}}>{l}</div>
        </div>
      )}
    </div>
    
    {/* 2. SLIDERS ‚Äî centered */}
    <div style={{width:"100%",maxWidth:360}}>
      <div style={{marginBottom:12}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3}}>
          <span style={{fontSize:11,fontWeight:700,color:T.blu}}>Protein</span>
          <MacroVal value={pActual} color={T.blu} unit="g" size={16} onChange={v=>{if(!gkg)setP(v)}}/>
        </div>
        <input type="range" min={0} max={400} step={5} value={pActual} onChange={e=>{if(!gkg)setP(Number(e.target.value))}} disabled={gkg} style={{width:"100%",accentColor:T.blu,height:6,cursor:gkg?"not-allowed":"pointer",opacity:gkg?0.35:1}}/>
      </div>
      <div style={{marginBottom:12}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3}}>
          <span style={{fontSize:11,fontWeight:700,color:T.yel}}>Kolhydrater</span>
          <MacroVal value={c} color={T.yel} unit="g" size={16} onChange={setC}/>
        </div>
        <input type="range" min={0} max={400} step={5} value={c} onChange={e=>setC(Number(e.target.value))} style={{width:"100%",accentColor:T.yel,height:6,cursor:"pointer"}}/>
      </div>
      <div style={{marginBottom:12}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3}}>
          <span style={{fontSize:11,fontWeight:700,color:T.red}}>Fett</span>
          <MacroVal value={f} color={T.red} unit="g" size={16} onChange={setF}/>
        </div>
        <input type="range" min={0} max={400} step={5} value={f} onChange={e=>setF(Number(e.target.value))} style={{width:"100%",accentColor:T.red,height:6,cursor:"pointer"}}/>
      </div>
    </div>

    <Btn onClick={()=>onNext({cal,p:pActual,c,f})} full>Klar, m√•ltidsplan</Btn>
  </div>;
}

// ===================== RECIPE MODAL =====================
function RecipeModal({meal,scale,onClose}) {
  const r=meal.recipe;
  return <div onClick={onClose} style={{position:"fixed",inset:0,zIndex:80,background:"rgba(0,0,0,0.75)",backdropFilter:"blur(8px)",display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
    <div onClick={e=>e.stopPropagation()} style={{background:T.bg,border:"1px solid "+T.brd,borderRadius:16,padding:24,maxWidth:420,width:"100%",maxHeight:"80vh",overflowY:"auto",position:"relative"}}>
      {/* Close */}
      <button onClick={onClose} style={{position:"absolute",top:12,right:12,background:"none",border:"none",color:T.dim,fontSize:20,cursor:"pointer",lineHeight:1}}>√ó</button>
      {/* Header */}
      <div style={{fontSize:9,textTransform:"uppercase",letterSpacing:1.5,color:T.acc,fontWeight:600,marginBottom:4}}>{meal.slot}</div>
      <div style={{fontSize:20,fontWeight:800,marginBottom:4}}>{r.name}</div>
      <div style={{display:"flex",gap:10,marginBottom:20,fontSize:11}}>
        <span style={{color:T.acc,fontWeight:700}}>{meal.macro.kcal} kcal</span>
        <span style={{color:T.blu}}>P {meal.macro.p}g</span>
        <span style={{color:T.yel}}>K {meal.macro.c}g</span>
        <span style={{color:T.red}}>F {meal.macro.f}g</span>
      </div>
      {/* Ingredients */}
      <div style={{marginBottom:20}}>
        <div style={{fontSize:10,fontWeight:700,color:T.dim,marginBottom:8,textTransform:"uppercase",letterSpacing:0.5}}>INGREDIENSER</div>
        {r.ing.map((ig,i)=>{
          const amt=["st","burk","frp","pase"].includes(ig.u)?Math.ceil(ig.a*scale):Math.round(ig.a*scale);
          return <div key={i} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:i<r.ing.length-1?"1px solid rgba(255,255,255,0.03)":"none",fontSize:12}}>
            <span>{ig.n}</span>
            <span style={{color:T.dim,fontFamily:T.mono}}>{amt} {ig.u}</span>
          </div>;
        })}
      </div>
      {/* Steps */}
      {r.steps&&<div>
        <div style={{fontSize:10,fontWeight:700,color:T.dim,marginBottom:8,textTransform:"uppercase",letterSpacing:0.5}}>TILLAGNING</div>
        {r.steps.map((s,i)=><div key={i} style={{display:"flex",gap:10,marginBottom:12}}>
          <div style={{width:22,height:22,borderRadius:"50%",background:T.accD,display:"flex",alignItems:"center",justifyContent:"center",fontSize:10,fontWeight:800,color:T.acc,flexShrink:0}}>{i+1}</div>
          <div style={{fontSize:12,color:T.dim,lineHeight:1.5,paddingTop:2}}>{s}</div>
        </div>)}
      </div>}
    </div>
  </div>;
}

// ===================== STEP 6: MEAL PLANNER =====================
function StepMeal({macros,onNext,mealPlan,setMealPlan}) {
  const [selMeal,setSelMeal]=useState(null);
  const [nMeals,setNMeals]=useState(4);
  const [nDays,setNDays]=useState(7);
  const [excl,setExcl]=useState([]);
  const [activeDay,setActiveDay]=useState(0);
  const [generated,setGenerated]=useState(null);
  const [showList,setShowList]=useState(false);
  const filtR=useCallback(cat=>{const tags=excl.map(id=>{const e=EXCL.find(x=>x.id===id);return e?e.tag:null}).filter(Boolean);return RECIPES.filter(r=>r.cat===cat&&tags.every(t=>r.tags.includes(t)));},[excl]);
  function generate(s){const struct=MEAL_S[nMeals]||MEAL_S[3];const tgt={kcal:macros.cal/nMeals};const rng=sRng(s);const plan=[];for(let d=0;d<nDays;d++){const meals=[];for(let mi=0;mi<struct.length;mi++){const av=filtR(struct[mi].c);if(!av.length)continue;const r=av[Math.floor(rng()*av.length)];const sc=Math.max(0.5,Math.min(2.5,tgt.kcal/r.macro.kcal));meals.push({slot:struct[mi].s,recipe:r,scale:sc,macro:{kcal:Math.round(r.macro.kcal*sc),p:Math.round(r.macro.p*sc),c:Math.round(r.macro.c*sc),f:Math.round(r.macro.f*sc)}});}plan.push({name:DAYNAMES[d%7],meals});}setGenerated(plan);setMealPlan(plan);setActiveDay(0);}

  if(!generated) return <div>
    <Card style={{marginBottom:10}}><Lbl>Maltider per dag</Lbl><div style={{display:"flex",gap:6}}>{[3,4,5].map(n=><button key={n} onClick={()=>setNMeals(n)} style={{flex:1,padding:"12px 0",border:"1px solid "+(nMeals===n?T.acc:T.brd),background:nMeals===n?T.accD:"transparent",color:nMeals===n?T.acc:T.dim,borderRadius:8,fontSize:16,fontWeight:700,cursor:"pointer",fontFamily:T.f}}>{n}</button>)}</div></Card>
    <Card style={{marginBottom:10}}><Lbl>Antal dagar</Lbl><div style={{display:"flex",gap:6}}>{[3,5,7].map(n=><button key={n} onClick={()=>setNDays(n)} style={{flex:1,padding:"12px 0",border:"1px solid "+(nDays===n?T.acc:T.brd),background:nDays===n?T.accD:"transparent",color:nDays===n?T.acc:T.dim,borderRadius:8,fontSize:16,fontWeight:700,cursor:"pointer",fontFamily:T.f}}>{n}</button>)}</div></Card>
    <Card style={{marginBottom:14}}><Lbl>Exkludera</Lbl><div style={{display:"flex",gap:6,flexWrap:"wrap"}}>{EXCL.map(ex=>{const on=excl.includes(ex.id);return <Pill key={ex.id} active={on} color={T.red} onClick={()=>setExcl(p=>on?p.filter(e=>e!==ex.id):[...p,ex.id])}>{on?"X ":""}{ex.l}</Pill>})}</div></Card>
    <Btn full onClick={()=>generate(Date.now())}>Generera matplan</Btn>
  </div>;

  const cur=generated[activeDay];
  const dayT=cur.meals.reduce((a,m)=>({kcal:a.kcal+m.macro.kcal,p:a.p+m.macro.p,c:a.c+m.macro.c,f:a.f+m.macro.f}),{kcal:0,p:0,c:0,f:0});

  return <div>
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
      <div style={{display:"flex",gap:4}}><Pill active={!showList} onClick={()=>setShowList(false)}>Matplan</Pill><Pill active={showList} onClick={()=>setShowList(true)}>Inkopslista</Pill></div>
      <button onClick={()=>generate(Date.now())} style={{background:"none",border:"none",color:T.dim,cursor:"pointer",fontSize:12,fontFamily:T.f}}>Ny plan</button>
    </div>
    {!showList?<div>
      <div style={{display:"flex",alignItems:"flex-end",gap:20,marginBottom:12,height:34}}>{generated.map((d,i)=><div key={i} onClick={()=>setActiveDay(i)} style={{cursor:"pointer",transition:"all .15s"}}><div style={{fontSize:i===activeDay?26:15,fontWeight:800,letterSpacing:-0.5,color:i===activeDay?T.t:"rgba(255,255,255,0.18)",transition:"all .15s",lineHeight:1,whiteSpace:"nowrap"}}>{d.name}</div></div>)}</div>
      {cur.meals.map((m,i)=><Card key={i} onClick={()=>setSelMeal(m)} style={{marginBottom:6,padding:12,cursor:"pointer"}}>
        <div style={{display:"flex",gap:10,alignItems:"center"}}>
          {/* Meal image placeholder */}
          <div style={{width:56,height:56,borderRadius:10,background:"rgba(255,255,255,0.03)",border:"1px dashed rgba(255,255,255,0.06)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,fontSize:9,color:T.mut}}>foto</div>
          <div style={{flex:1,minWidth:0}}>
            <div style={{fontSize:9,textTransform:"uppercase",letterSpacing:1.5,color:T.acc,fontWeight:600}}>{m.slot}</div>
            <div style={{fontSize:14,fontWeight:600,marginTop:1}}>{m.recipe.name}</div>
            <div style={{display:"flex",gap:6,marginTop:4}}>{[["P",m.macro.p,T.blu],["K",m.macro.c,T.yel],["F",m.macro.f,T.red]].map(([l,v,c])=><span key={l} style={{fontSize:10,color:c,fontWeight:600}}>{v}g {l}</span>)}</div>
          </div>
          <div style={{flexShrink:0,textAlign:"right"}}>
            <div style={{fontSize:20,fontWeight:800,color:T.acc,fontFamily:T.mono,lineHeight:1}}>{m.macro.kcal}</div>
            <div style={{fontSize:9,color:T.dim,marginTop:2}}>kcal</div>
          </div>
        </div>
      </Card>)}
      <div style={{padding:8,textAlign:"center",fontSize:11,color:T.dim,marginTop:4}}>Dagstotal: {dayT.kcal} kcal | P{dayT.p}g K{dayT.c}g F{dayT.f}g</div>
    </div>:<div>
      <Lbl>{nDays} dagar</Lbl>
      <Card>{(()=>{const map={};generated.forEach(d=>d.meals.forEach(m=>m.recipe.ing.forEach(ig=>{const k=ig.n+"__"+ig.u;if(!map[k])map[k]={n:ig.n,u:ig.u,a:0};map[k].a+=ig.a*m.scale})));return Object.values(map).sort((a,b)=>a.n.localeCompare(b.n)).map((it,i,arr)=>{
        // Round to normal units
        let display;
        if(["st","burk","frp","pase"].includes(it.u)){display=Math.ceil(it.a)+" "+it.u}
        else if(it.u==="g"){const kg=it.a/1000;display=kg>=1?Math.ceil(kg*10)/10+" kg":Math.ceil(it.a/50)*50+" g"}
        else if(it.u==="ml"){const l=it.a/1000;display=l>=1?Math.ceil(l*10)/10+" L":Math.ceil(it.a/50)*50+" ml"}
        else{display=Math.ceil(it.a)+" "+it.u}
        return <div key={i} style={{display:"flex",justifyContent:"space-between",padding:"6px 0",borderBottom:i<arr.length-1?"1px solid rgba(255,255,255,0.025)":"none",fontSize:12}}><span>{it.n}</span><span style={{color:T.dim,fontSize:11}}>{display}</span></div>;
      })})()}</Card>
    </div>}
    <Btn onClick={onNext} full style={{marginTop:12}}>Klar, granska allt</Btn>
    {selMeal&&<RecipeModal meal={selMeal} scale={selMeal.scale} onClose={()=>setSelMeal(null)}/>}
  </div>;
}

// ===================== STEP 7: FINAL =====================
function StepFinal({client,days,macros,mealPlan,tplGroups,onSend}) {
  const [saveName,setSaveName]=useState(client.name.split(" ")[0]+" "+days.length+"D");
  const [msg,setMsg]=useState("");
  return <div>
    {/* Program summary - clean */}
    {days.map((d,i)=><div key={i} style={{marginBottom:10}}>
      <div style={{fontSize:14,fontWeight:700,marginBottom:3}}>{d.name}</div>
      {d.exercises.map((e,j)=><div key={j} style={{fontSize:11,color:T.dim,padding:"2px 0"}}>{e.n} | {e.r}x{e.s}</div>)}
    </div>)}
    <div style={{padding:10,background:"rgba(255,255,255,0.02)",borderRadius:8,marginBottom:12,fontSize:12}}>
      <span style={{color:T.blu,fontWeight:600}}>P: {macros.p}g</span>
      <span style={{color:T.dim}}> | </span>
      <span style={{color:T.yel,fontWeight:600}}>K: {macros.c}g</span>
      <span style={{color:T.dim}}> | </span>
      <span style={{color:T.red,fontWeight:600}}>F: {macros.f}g</span>
      <span style={{color:T.dim}}> | </span>
      <span style={{color:T.acc,fontWeight:700}}>{macros.cal} kcal</span>
    </div>
    <Card style={{marginBottom:10}}><Lbl>Meddelande</Lbl><textarea value={msg} onChange={e=>setMsg(e.target.value)} placeholder={"Hej "+client.name.split(" ")[0]+"!"} style={{width:"100%",minHeight:50,padding:8,borderRadius:8,border:"1px solid "+T.brd,background:"rgba(255,255,255,0.03)",color:"#fff",fontSize:12,fontFamily:T.f,outline:"none",resize:"vertical",boxSizing:"border-box"}}/></Card>
    <Card style={{marginBottom:14,background:"rgba(255,255,255,0.02)"}}><Lbl>Spara traningsprogram som mall</Lbl><Input value={saveName} onChange={setSaveName} small/></Card>
    <Btn onClick={()=>onSend({msg,saveName})} full style={{fontSize:15,padding:"14px"}}>Skicka till {client.name.split(" ")[0]}</Btn>
  </div>;
}

// ===================== REVIEW: TRAINING LOG VIEWER =====================
function SetLine({sets,field,color,size=11,weight=700}) {
  return <div style={{display:"flex",alignItems:"baseline",gap:0}}>
    {sets.map((s,i)=><div key={i} style={{display:"flex",alignItems:"baseline"}}>
      <span style={{fontFamily:T.mono,fontSize:size,fontWeight:weight,color,minWidth:28,textAlign:"right",fontVariantNumeric:"tabular-nums"}}>{s[field]}</span>
      {i<sets.length-1&&<span style={{color:T.mut,fontSize:8,margin:"0 3px",opacity:0.4}}>/</span>}
    </div>)}
  </div>;
}

function ExRow({ex,prev}) {
  return <div style={{padding:"8px 0",borderBottom:"1px solid rgba(255,255,255,0.03)"}}>
    <div style={{marginBottom:4}}>
      <span style={{fontSize:12,fontWeight:700}}>{ex.n}</span>
    </div>
    {ex.sets&&ex.sets.length>0?<div>
      <div style={{display:"flex",alignItems:"baseline",gap:4}}>
        <SetLine sets={ex.sets} field="kg" color={T.acc} size={12}/>
        <span style={{fontSize:9,color:T.dim,fontWeight:600}}>kg</span>
      </div>
      <div style={{display:"flex",alignItems:"baseline",gap:4,marginTop:2}}>
        <SetLine sets={ex.sets} field="reps" color={T.dim} size={11} weight={600}/>
        <span style={{fontSize:9,color:T.mut}}>reps</span>
      </div>
    </div>:<div style={{color:T.mut,fontSize:10}}>Ej loggat</div>}
  </div>;
}

function ExRowHist({ex}) {
  if(!ex||!ex.sets||!ex.sets.length) return <div style={{padding:"8px 0",borderBottom:"1px solid rgba(255,255,255,0.03)"}}>
    <div style={{marginBottom:4,textAlign:"right"}}><span style={{fontSize:12,fontWeight:700,color:T.mut}}>{ex?ex.n:"‚Äî"}</span></div>
    <div style={{display:"flex",alignItems:"baseline",justifyContent:"flex-end",gap:4}}><span style={{fontFamily:T.mono,fontSize:12,color:T.mut}}>‚Äî</span></div>
    <div style={{marginTop:2,height:15}}/>
  </div>;
  return <div style={{padding:"8px 0",borderBottom:"1px solid rgba(255,255,255,0.03)"}}>
    <div style={{marginBottom:4,textAlign:"right"}}><span style={{fontSize:12,fontWeight:700,color:T.dim}}>{ex.n}</span></div>
    <div style={{display:"flex",alignItems:"baseline",justifyContent:"flex-end",gap:4}}>
      <span style={{fontSize:9,color:T.mut}}>kg</span>
      <SetLine sets={ex.sets} field="kg" color={T.dim} size={12}/>
    </div>
    <div style={{display:"flex",alignItems:"baseline",justifyContent:"flex-end",gap:4,marginTop:2}}>
      <span style={{fontSize:8,color:T.mut}}>reps</span>
      <SetLine sets={ex.sets} field="reps" color={T.mut} size={11} weight={600}/>
    </div>
  </div>;
}

// ===================== FOCUS CARD (timeline scroll + edit) =====================
const FW=520; // Focus area width - wider now
function FocusCard({title,signal,expanded,onToggle,onEdit,weeks,currentContent,weekRenderer,headerContent,scrollId}) {
  const [activeIdx,setActiveIdx]=useState(weeks?weeks.length:0); // default = current (last)
  const totalPanels=(weeks?weeks.length:0)+1;
  const handleScroll=(e)=>{const el=e.currentTarget;const w=el.offsetWidth;if(w>0){const idx=Math.round(el.scrollLeft/w);setActiveIdx(Math.min(idx,totalPanels-1))}};
  const scrollTo=(idx)=>{const el=scrollId&&document.getElementById(scrollId);if(el){el.scrollTo({left:idx*el.offsetWidth,behavior:"smooth"});setActiveIdx(idx)}};
  return <div style={{marginBottom:8,maxWidth:FW+40,margin:"0 auto 8px"}}>
    <div style={{display:"flex",alignItems:"center",gap:8,padding:"10px 16px",background:expanded?"rgba(255,255,255,0.04)":T.s1,border:"1px solid "+(expanded?T.brdH:T.brd),borderRadius:expanded?"10px 10px 0 0":10,cursor:"pointer",transition:"all .15s"}} onClick={onToggle}>
      <div style={{flex:1}}><div style={{fontSize:14,fontWeight:700}}>{title}</div></div>
      <div style={{display:"flex",alignItems:"center",gap:8}}>
        {signal}
        {onEdit&&<div onClick={e=>{e.stopPropagation();onEdit()}} style={{width:24,height:24,borderRadius:6,display:"flex",alignItems:"center",justifyContent:"center",border:"1px solid "+T.brd,background:"rgba(255,255,255,0.03)",cursor:"pointer",transition:"all .15s",fontSize:11}} onMouseEnter={e=>{e.currentTarget.style.borderColor=T.acc;e.currentTarget.style.background="rgba(255,255,255,0.06)"}} onMouseLeave={e=>{e.currentTarget.style.borderColor=T.brd;e.currentTarget.style.background="rgba(255,255,255,0.03)"}}>‚úé</div>}
      </div>
    </div>
    {expanded&&<div style={{border:"1px solid "+T.brd,borderTop:"none",borderRadius:"0 0 10px 10px",overflow:"hidden"}}>
      {headerContent&&<div style={{padding:"12px 20px",borderBottom:"1px solid rgba(255,255,255,0.04)"}}>{typeof headerContent==="function"?headerContent(activeIdx,scrollTo):headerContent}</div>}
      <div id={scrollId||undefined} onScroll={handleScroll} ref={el=>{if(el&&!el.dataset.scrolled){el.scrollLeft=el.scrollWidth;el.dataset.scrolled="1"}}} style={{display:"flex",overflowX:"auto",scrollSnapType:"x mandatory",scrollBehavior:"smooth"}}>
        {weeks&&weeks.map((wk,wi)=><div key={wi} style={{minWidth:"100%",flexShrink:0,scrollSnapAlign:"center",background:"rgba(255,255,255,0.01)"}}>
          <div style={{maxHeight:"60vh",overflowY:"auto",padding:"0 20px"}}>
            <div style={{padding:"8px 0",fontSize:10,fontWeight:800,color:T.mut,textAlign:"center",borderBottom:"1px solid "+T.brd,letterSpacing:0.5,position:"sticky",top:0,background:T.bg,zIndex:1}}>V{wk.week||wk.w||wi+1}</div>
            {weekRenderer?weekRenderer(wk,wi):null}
          </div>
        </div>)}
        <div style={{minWidth:"100%",flexShrink:0,scrollSnapAlign:"center",background:"rgba(255,255,255,0.02)"}}>
          <div style={{maxHeight:"60vh",overflowY:"auto",padding:"0 20px"}}>
            {currentContent}
          </div>
        </div>
      </div>
    </div>}
  </div>;
}

function TrainingLogDay({dayLog,prevLogs,dayName,expanded,onToggle,onEdit}) {
  if(!dayLog) return null;
  const completed=dayLog.exercises.filter(e=>e.sets&&e.sets.length>0).length;
  const total=dayLog.exercises.length;
  const pct=total>0?Math.round(completed/total*100):0;
  const curExNames=dayLog.exercises.map(e=>e.n);

  return <FocusCard title={dayName} signal={<span style={{fontSize:11,fontWeight:700,color:pct===100?T.grn:pct>50?T.yel:T.red}}>{pct}%</span>} expanded={expanded} onToggle={onToggle} onEdit={onEdit} weeks={prevLogs.map(wk=>({...wk,week:wk.week}))} weekRenderer={(wk)=><div>
    {curExNames.map((name,ei)=>{
      const ex=wk.exercises.find(e=>e.n===name);
      return <ExRow key={ei} ex={ex||{n:name}} prev={null}/>;
    })}
  </div>} currentContent={<div>
    <div style={{padding:"8px 0",fontSize:10,fontWeight:800,color:T.acc,textAlign:"center",borderBottom:"1px solid rgba(255,255,255,0.10)",letterSpacing:0.5}}>V{dayLog.week}</div>
    {dayLog.exercises.map((ex,ei)=><ExRow key={ei} ex={ex} prev={null}/>)}
  </div>}/>;
}

// ===================== WEEKLY REVIEW (3-PANEL) =====================
function WeeklyReview({client:c,onSend,templates,tplGroups}) {
  const [openDays,setOpenDays]=useState({});
  const [openSections,setOpenSections]=useState({});
  const [changed,setChanged]=useState(false);
  const [profileOpen,setProfileOpen]=useState(true);
  const [reviewed,setReviewed]=useState({});
  const [lightbox,setLightbox]=useState(null);
  const [physiqueView,setPhysiqueView]=useState("Fram");
  const [mealDayIdx,setMealDayIdx]=useState(0);
  const [trainDayIdx,setTrainDayIdx]=useState(0);
  const [editMeals,setEditMeals]=useState(()=>c.mealPlan?(c.mealPlan.map(d=>({...d,meals:d.meals.map(m=>({...m}))}))):[]); 
  const [builderModal,setBuilderModal]=useState(null); // "vikt"|"kost"|"training"
  const reviewSteps=["Vikt","Kost","Tr√§ning"];
  // Editable program
  const [days,setDays]=useState(()=>(c.program||[]).map((d,i)=>({id:"d"+i,name:d.name,exercises:d.ex.map((e,j)=>({...e,id:"e"+i+j}))})));
  const [addOpen,setAddOpen]=useState(null);
  const [exS,setExS]=useState("");
  const [swapId,setSwapId]=useState(null);
  const [editingDay,setEditingDay]=useState(null);
  const [customEx,setCustomEx]=useState([]);
  const [muscleFilter,setMuscleFilter]=useState("Alla");
  const [newExName,setNewExName]=useState("");
  const allEx=[...EX_DB,...customEx];
  const [dragState,setDragState]=useState({di:null,idx:null,overIdx:null});
  const reorderEx=(di,fromIdx,toIdx)=>{if(fromIdx===toIdx)return;markChanged();setDays(p=>p.map((d,i)=>{if(i!==di)return d;const exs=[...d.exercises];const [moved]=exs.splice(fromIdx,1);exs.splice(toIdx,0,moved);return{...d,exercises:exs}}));};
  const filtE=(()=>{let list=allEx;if(muscleFilter!=="Alla")list=list.filter(e=>e.muscle===muscleFilter);if(exS)list=list.filter(e=>e.name.toLowerCase().includes(exS.toLowerCase()));return list})();
  const markChanged=()=>{if(!changed)setChanged(true)};
  const updEx=(di,eId,fld,val)=>{markChanged();setDays(p=>p.map((d,i)=>i===di?{...d,exercises:d.exercises.map(e=>e.id===eId?{...e,[fld]:val}:e)}:d));};
  const rmEx=(di,eId)=>{markChanged();setDays(p=>p.map((d,i)=>i===di?{...d,exercises:d.exercises.filter(e=>e.id!==eId)}:d));};
  const addE=(di,name,muscle)=>{markChanged();setDays(p=>p.map((d,i)=>i===di?{...d,exercises:[...d.exercises,{id:"e"+Date.now(),n:name,s:3,r:"10-12",m:muscle}]}:d));setAddOpen(null);setExS("")};
  const toggleDay=(di)=>{
    setOpenDays(p=>({...p,[di]:!p[di]}));
    if(!openDays[di]){setReviewed(p=>({...p,["day"+di]:true}));setAddOpen(null);setSwapId(null);}
  };
  const toggleSection=(key)=>{
    setOpenSections(p=>({...p,[key]:!p[key]}));
    if(!openSections[key]) setReviewed(p=>({...p,[key]:true}));
  };

  // Training log data
  const wLogs=c.weeklyLogs||[];
  const curWeek=wLogs.length>0?wLogs[wLogs.length-1]:null;
  const prevWeeks=wLogs.slice(0,-1);

  // Nutrition - weekly macro data
  const wMacros=c.weeklyMacros||[];
  const curMacros=wMacros.length>0?wMacros[wMacros.length-1]:null;
  const prevMacros=wMacros.slice(0,-1);
  const [editMacros,setEditMacros]=useState(()=>({p:c.macros?.p||0,c:c.macros?.c||0,f:c.macros?.f||0}));
  const tCal=editMacros.p*4+editMacros.c*4+editMacros.f*9;
  // Averages from current week
  const avgP=curMacros?Math.round(curMacros.days.reduce((a,d)=>a+d.p,0)/curMacros.days.length):0;
  const avgC=curMacros?Math.round(curMacros.days.reduce((a,d)=>a+d.c,0)/curMacros.days.length):0;
  const avgF=curMacros?Math.round(curMacros.days.reduce((a,d)=>a+d.f,0)/curMacros.days.length):0;
  const avgCal=avgP*4+avgC*4+avgF*9;
  const costPct=tCal>0?Math.round(avgCal/tCal*100):0;
  const weeklyKcals=wMacros.map(wm=>{const ds=wm.days||[];const avg=ds.length?Math.round(ds.reduce((a,d)=>a+d.p*4+d.c*4+d.f*9,0)/ds.length):0;return {week:wm.week,kcal:avg}});
  const lastW=c.wIns.length>=2?c.wIns[c.wIns.length-1].kg-c.wIns[c.wIns.length-2].kg:0;

  // Training volume per week
  const calcVol=(wk)=>wk.days.reduce((a,d)=>a+d.exercises.reduce((b,ex)=>b+(ex.sets||[]).reduce((c,s)=>c+(s.kg||0)*(s.reps||0),0),0),0);
  const weekVolumes=wLogs.map(wk=>({week:wk.week,vol:calcVol(wk)}));
  const curVol=curWeek?calcVol(curWeek):0;

  // Completion: prescribed sets vs logged sets
  const calcCompletion=(weekLog,prog)=>{
    if(!weekLog||!prog) return{done:0,total:0,pct:0};
    let done=0,total=0;
    weekLog.days.forEach((d,di)=>{
      const p=prog[di];
      if(!p) return;
      p.exercises.forEach(pe=>{
        const prescribedSets=pe.s||3;
        total+=prescribedSets;
        const logged=d.exercises.find(e=>e.n===pe.n);
        if(logged&&logged.sets) done+=Math.min(logged.sets.length,prescribedSets);
      });
    });
    return{done,total,pct:total>0?Math.round(done/total*100):0};
  };
  const completion=calcCompletion(curWeek,days);

  // Macro row component ‚Äî used in both review and history
  const [kostDetailOpen,setKostDetailOpen]=useState(false);
  const [weighDetailOpen,setWeighDetailOpen]=useState(false);
  const kcal=(p,c,f)=>p*4+c*4+f*9;
  const diffCol=(actual,goal,isKcal)=>{const d=Math.abs(actual-goal);if(isKcal)return d<=20?T.grn:d<=50?T.yel:T.red;return d<=5?T.grn:d<=10?T.yel:T.red};

  const MacroBlock=({label,target,actual,large,zebra})=>{
    const tK=kcal(target.p,target.c,target.f);
    const aK=kcal(actual.p,actual.c,actual.f);
    const dK=aK-tK;
    const sz=large?{val:15,hdr:9,lbl:11}:{val:12,hdr:8,lbl:10};
    // Column zebra tints ‚Äî progressively lighter left‚Üíright
    const colZ=["transparent","rgba(255,255,255,0.035)","transparent"];
    const vBrd="1px solid rgba(255,255,255,0.06)";
    const cell=(ci)=>({textAlign:"center",padding:large?"9px 4px":"7px 3px",background:colZ[ci],borderLeft:ci>0?vBrd:"none"});
    const lblCell={textAlign:"left",padding:large?"9px 6px":"7px 4px"};
    const rows=[
      {l:"kcal",col:T.acc,tgt:tK,act:aK,d:dK,isK:true,bg:"rgba(255,255,255,0.03)",brd:"rgba(255,255,255,0.06)"},
      {l:"P",col:T.blu,tgt:target.p,act:actual.p,d:actual.p-target.p,isK:false,bg:"rgba(59,130,246,0.06)",brd:"rgba(59,130,246,0.12)"},
      {l:"K",col:T.yel,tgt:target.c,act:actual.c,d:actual.c-target.c,isK:false,bg:"rgba(234,179,8,0.05)",brd:"rgba(234,179,8,0.10)"},
      {l:"F",col:T.red,tgt:target.f,act:actual.f,d:actual.f-target.f,isK:false,bg:"rgba(239,68,68,0.05)",brd:"rgba(239,68,68,0.10)"}
    ];
    return <div style={{padding:large?"12px 0":"8px 0",background:zebra?ZB[1]:ZB[0],borderRadius:6}}>
      {label&&<div style={{fontSize:sz.lbl,fontWeight:700,color:large?T.acc:T.dim,marginBottom:10,paddingLeft:2}}>{label}</div>}
      {/* Column headers */}
      <div style={{display:"grid",gridTemplateColumns:"48px 1fr 1fr 1fr",borderBottom:"1px solid rgba(255,255,255,0.1)",marginBottom:4}}>
        <div/>
        <div style={{...cell(0),fontSize:sz.hdr,fontWeight:700,color:T.mut,textTransform:"uppercase",letterSpacing:0.5,paddingBottom:6}}>M√•l</div>
        <div style={{...cell(1),fontSize:sz.hdr,fontWeight:700,color:T.mut,textTransform:"uppercase",letterSpacing:0.5,paddingBottom:6}}>Logg</div>
        <div style={{...cell(2),fontSize:sz.hdr,fontWeight:700,color:T.mut,textTransform:"uppercase",letterSpacing:0.5,paddingBottom:6}}>Diff</div>
      </div>
      {/* Data rows */}
      {rows.map((r,ri)=><div key={r.l} style={{display:"grid",gridTemplateColumns:"48px 1fr 1fr 1fr",borderRadius:6,background:r.bg,border:"1px solid "+r.brd,marginBottom:ri<3?4:0}}>
        <div style={{...lblCell,fontSize:sz.lbl,fontWeight:800,color:r.col}}>{r.l}</div>
        <div style={{...cell(0),fontSize:sz.val,fontWeight:700,fontFamily:T.mono,color:r.col}}>{r.tgt}{r.isK?"":"g"}</div>
        <div style={{...cell(1),fontSize:sz.val,fontWeight:800,fontFamily:T.mono,color:"#fff"}}>{r.act}{r.isK?"":"g"}</div>
        <div style={{...cell(2),fontSize:sz.val,fontWeight:700,fontFamily:T.mono,color:diffCol(r.act,r.tgt,r.isK)}}>{r.d>0?"+":""}{r.d}{r.isK?"":"g"}</div>
      </div>)}
    </div>;
  };
  const MacroWeekView=({macroWeek,target,showDetail,onToggleDetail})=>{
    if(!macroWeek) return null;
    const ds=macroWeek.days;
    const avg={p:Math.round(ds.reduce((a,d)=>a+d.p,0)/ds.length),c:Math.round(ds.reduce((a,d)=>a+d.c,0)/ds.length),f:Math.round(ds.reduce((a,d)=>a+d.f,0)/ds.length)};
    return <div>
      <MacroBlock label={null} target={target} actual={avg} large/>
      {onToggleDetail&&<div onClick={onToggleDetail} style={{padding:"10px 0",textAlign:"center",cursor:"pointer",fontSize:11,fontWeight:700,color:T.dim,background:"rgba(255,255,255,0.02)",borderRadius:6,margin:"8px 0"}}>
        {showDetail?"‚ñ≤ D√∂lj dagarna":"‚ñº Visa alla 7 dagar"}
      </div>}
      {showDetail&&ds.map((d,i)=><MacroBlock key={i} label={d.d} target={target} actual={d} zebra={i%2===1}/>)}
    </div>;
  };

  // Self-assess labels
  const SA_ICONS={Trott:"\u{1F634}",Pigg:"\u{1F4AA}",Bra:"\u{1F60A}",Dalig:"\u{1F614}","Perfekt utmanande":"\u{1F3AF}","For latt":"\u2B06","For svart":"\u2B07"};

  return <div style={{minHeight:"calc(100vh - 60px)",position:"relative",overflowY:"auto"}}>
    {/* LEFT PANEL - Floating, independently togglable */}
    {/* Backdrop blur when profile open */}
    {profileOpen&&<div onClick={()=>setProfileOpen(false)} style={{position:"fixed",inset:0,zIndex:35,background:"rgba(0,0,0,0.4)",backdropFilter:"blur(8px)",WebkitBackdropFilter:"blur(8px)",transition:"opacity .3s"}}/>}
    <div onClick={()=>setProfileOpen(!profileOpen)} style={{position:"fixed",left:profileOpen?"45vw":0,top:"50%",transform:"translateY(-50%)",zIndex:50,background:"rgba(255,255,255,0.04)",border:"1px solid "+T.brd,borderRadius:"0 8px 8px 0",padding:"14px 6px",cursor:"pointer",transition:"left .3s ease",writingMode:"vertical-rl",fontSize:10,fontWeight:700,color:T.dim,letterSpacing:1}}>{profileOpen?"\u25C0":"\u25B6"} {c.name.split(" ")[0]}</div>
    <div style={{position:"fixed",left:0,top:0,bottom:0,width:"45vw",background:"rgba(26,26,26,0.98)",borderRight:"1px solid "+T.brd,zIndex:40,transform:profileOpen?"translateX(0)":"translateX(-100%)",transition:"transform .3s ease",overflowY:"auto",padding:"24px 28px"}}>
      <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:16}}>
        <Pfp name={c.name} gender={c.gender} size={52}/>
        <div style={{flex:1}}>
          <div style={{fontSize:15,fontWeight:800}}>{c.name}</div>
          <div style={{fontSize:10,color:T.dim,marginBottom:4}}>{c.gender} ¬∑ {c.age} √•r ¬∑ {c.height} cm ¬∑ {c.curW} kg</div>
          <div style={{display:"flex",gap:6,marginBottom:6}}>
            {[[c.goal==="lose"?"G√• ner":c.goal==="build"?"Bygga":"Underh√•ll",c.goal==="lose"?T.grn:T.blu],[c.split,T.dim],[c.level,T.dim]].map(([v,col],i)=><span key={i} style={{fontSize:9,fontWeight:600,padding:"2px 6px",borderRadius:4,background:col+"15",color:col,border:"1px solid "+col+"25"}}>{v}</span>)}
          </div>
          <div style={{display:"flex",alignItems:"center",gap:8}}>
            <div style={{flex:1,height:4,borderRadius:2,background:"rgba(255,255,255,0.06)",overflow:"hidden"}}>
              <div style={{width:Math.round((c.wkC/c.wkT)*100)+"%",height:"100%",borderRadius:2,background:`linear-gradient(90deg, ${T.acc}90, ${T.acc})`,transition:"width .4s ease"}}/>
            </div>
            <span style={{fontSize:9,fontWeight:700,fontFamily:T.mono,color:T.dim,whiteSpace:"nowrap"}}>V{c.wkC}/{c.wkT}</span>
          </div>
        </div>
      </div>

      {c.message&&<div style={{marginBottom:20}}>
        <Lbl>Meddelande</Lbl>
        <div style={{padding:12,background:"rgba(255,255,255,0.03)",borderRadius:10,fontSize:12,color:T.dim,lineHeight:1.5,fontStyle:"italic",borderLeft:"2px solid "+T.acc}}>"{c.message}"</div>
      </div>}

      {c.selfAssess&&<div style={{marginBottom:20}}>
        <Lbl>Sjalvskattning</Lbl>
        <div style={{display:"flex",flexDirection:"column",gap:6}}>
          {[["Svarighet",c.selfAssess.difficulty],["Energi",c.selfAssess.energy],["Maende",c.selfAssess.mood]].map(([label,val])=>val&&<div key={label} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"6px 10px",background:"rgba(255,255,255,0.02)",borderRadius:6}}>
            <span style={{fontSize:10,color:T.dim}}>{label}</span>
            <span style={{fontSize:12,fontWeight:600}}>{SA_ICONS[val]||""} {val}</span>
          </div>)}
        </div>
      </div>}

      {c.notes&&<div style={{marginBottom:20}}>
        <Lbl>PTns anteckningar</Lbl>
        <div style={{padding:10,background:"rgba(255,255,255,0.02)",borderRadius:8,fontSize:11,color:T.dim}}>{c.notes}</div>
      </div>}
    </div>

    {/* Content */}
    <div style={{padding:"24px 24px 80px",overflowY:"auto"}}>
      <div style={{maxWidth:FW+40,margin:"0 auto 20px"}}>
        <div style={{fontSize:18,fontWeight:800,marginBottom:12,textAlign:"center"}}>Vecka {c.wkC}</div>
        {/* Review progress */}
        <div style={{display:"flex",alignItems:"center",gap:0}}>
          {reviewSteps.map((s,i)=>{const done=i===0?reviewed.vikt:i===1?reviewed.kost:reviewed["day"+(i-2)];return <div key={i} style={{display:"flex",alignItems:"center",flex:i<reviewSteps.length-1?1:"none"}}>
            <div style={{display:"flex",alignItems:"center",gap:4}}>
              <div style={{width:18,height:18,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:7,fontWeight:700,background:done?T.acc:"rgba(255,255,255,0.06)",color:done?"#fff":T.mut}}>{done?"\u2713":i+1}</div>
              <span style={{fontSize:8,fontWeight:600,color:done?T.t:T.mut,whiteSpace:"nowrap"}}>{s}</span>
            </div>
            {i<reviewSteps.length-1&&<div style={{flex:1,height:1,background:done?"rgba(255,255,255,0.15)":"rgba(255,255,255,0.06)",margin:"0 4px"}}/>}
          </div>})}
        </div>
      </div>

      {/* Vikt */}
      {/* Vikt */}
      <FocusCard title="Vikt" scrollId="fc-vikt" signal={<span style={{fontSize:11,fontWeight:700,fontFamily:T.mono,color:lastW<=0&&c.goal==="lose"?T.grn:lastW>=0&&c.goal==="build"?T.grn:T.yel}}>{lastW>0?"+":""}{lastW.toFixed(1)}kg</span>} expanded={!!openSections.vikt} onToggle={()=>toggleSection("vikt")}
        headerContent={(activeIdx,scrollTo)=><div>
          <Chart data={c.wIns.map(w=>w.kg)} labels={c.wIns.map(w=>"V"+w.w)} h={80} color={c.goal==="lose"?T.grn:T.blu} highlightIdx={activeIdx} onDotClick={scrollTo}/>
          <div style={{display:"flex",justifyContent:"space-between",marginTop:4}}>
            <span style={{fontSize:10,color:T.mut}}>V{c.wIns[0]?.w||1}: {c.wIns[0]?.kg}kg</span>
            <span style={{fontSize:12,fontWeight:700,fontFamily:T.mono,color:T.dim}}>{c.curW} kg</span>
          </div>
        </div>}
        weeks={c.wIns.slice(0,-1).map(w=>({week:w.w,kg:w.kg,days:w.days||[]}))}
        weekRenderer={(wk)=>{
          const ds=wk.days||[];
          const avg=ds.length?(ds.reduce((a,v)=>a+v,0)/ds.length).toFixed(1):wk.kg;
          const DN=["M√•n","Tis","Ons","Tor","Fre","L√∂r","S√∂n"];
          return <div style={{padding:"16px 0"}}>
            <div style={{textAlign:"center",marginBottom:12}}>
              <div style={{fontSize:28,fontWeight:800,fontFamily:T.mono,color:T.dim}}>{avg} kg</div>
              <div style={{fontSize:11,color:T.mut,marginTop:2}}>snitt</div>
            </div>
            {ds.length>0&&<div>
              <div onClick={()=>setWeighDetailOpen(p=>!p)} style={{padding:"8px 0",textAlign:"center",cursor:"pointer",fontSize:11,fontWeight:700,color:T.dim,background:"rgba(255,255,255,0.02)",borderRadius:6,marginBottom:12}}>
                {weighDetailOpen?"‚ñ≤ D√∂lj inv√§gningar":"‚ñº Visa inv√§gningar"}
              </div>
              {weighDetailOpen&&<div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:2,marginBottom:16}}>
                {ds.map((v,i)=><div key={i} style={{textAlign:"center",padding:"6px 0",borderRadius:6,background:i%2?ZB[1]:"rgba(255,255,255,0.02)"}}>
                  <div style={{fontSize:9,fontWeight:700,color:T.mut,marginBottom:3}}>{DN[i]}</div>
                  <div style={{fontSize:13,fontFamily:T.mono,color:T.dim,fontWeight:600}}>{v}</div>
                </div>)}
              </div>}
            </div>}
            <div onClick={()=>setLightbox({week:wk.week,view:physiqueView})} style={{height:180,borderRadius:8,border:"1px dashed rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.02)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"}}>
              <div style={{fontSize:11,color:T.mut}}>üì∑ {physiqueView}</div>
            </div>
            <div style={{display:"flex",justifyContent:"center",gap:4,marginTop:8}}>
              {["Fram","Sida","Rygg"].map(v=><button key={v} onClick={e=>{e.stopPropagation();setPhysiqueView(v)}} style={{padding:"4px 10px",borderRadius:5,border:"1px solid "+(physiqueView===v?T.acc+"50":T.brd),background:physiqueView===v?"rgba(255,255,255,0.06)":"transparent",color:physiqueView===v?T.acc:T.mut,fontSize:9,fontWeight:700,cursor:"pointer",fontFamily:T.f}}>{v}</button>)}
            </div>
          </div>;
        }}
        currentContent={<div style={{padding:"16px 0"}}>
          {(()=>{
            const curW=c.wIns[c.wIns.length-1];
            const ds=curW?.days||[];
            const avg=ds.length?(ds.reduce((a,v)=>a+v,0)/ds.length).toFixed(1):curW?.kg||0;
            const DN=["M√•n","Tis","Ons","Tor","Fre","L√∂r","S√∂n"];
            return <div>
              <div style={{fontSize:11,fontWeight:800,color:T.acc,textAlign:"center",letterSpacing:0.5,marginBottom:12}}>V{c.wkC}</div>
              <div style={{textAlign:"center",marginBottom:12}}>
                <div style={{fontSize:32,fontWeight:800,fontFamily:T.mono}}>{avg} kg</div>
                <div style={{fontSize:12,color:T.mut,marginTop:2}}>veckans snitt</div>
              </div>
              {ds.length>0&&<div>
                <div onClick={()=>setWeighDetailOpen(p=>!p)} style={{padding:"8px 0",textAlign:"center",cursor:"pointer",fontSize:11,fontWeight:700,color:T.dim,background:"rgba(255,255,255,0.02)",borderRadius:6,marginBottom:12}}>
                  {weighDetailOpen?"‚ñ≤ D√∂lj inv√§gningar":"‚ñº Visa inv√§gningar"}
                </div>
                {weighDetailOpen&&<div style={{display:"grid",gridTemplateColumns:"repeat(7,1fr)",gap:2,marginBottom:16}}>
                  {ds.map((v,i)=><div key={i} style={{textAlign:"center",padding:"8px 0",borderRadius:6,background:i%2?"rgba(255,255,255,0.03)":"rgba(255,255,255,0.02)"}}>
                    <div style={{fontSize:10,fontWeight:700,color:T.mut,marginBottom:3}}>{DN[i]}</div>
                    <div style={{fontSize:14,fontFamily:T.mono,color:T.dim,fontWeight:700}}>{v}</div>
                  </div>)}
                </div>}
              </div>}
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
                <span style={{fontSize:11,fontWeight:700,color:T.dim}}>Fysik</span>
                <div style={{display:"flex",gap:4}}>
                  {["Fram","Sida","Rygg"].map(v=><button key={v} onClick={e=>{e.stopPropagation();setPhysiqueView(v)}} style={{padding:"4px 10px",borderRadius:5,border:"1px solid "+(physiqueView===v?T.acc+"50":T.brd),background:physiqueView===v?"rgba(255,255,255,0.06)":"transparent",color:physiqueView===v?T.acc:T.mut,fontSize:9,fontWeight:700,cursor:"pointer",fontFamily:T.f}}>{v}</button>)}
                </div>
              </div>
              <div onClick={()=>setLightbox({week:c.wkC,view:physiqueView})} style={{width:"100%",height:200,borderRadius:8,border:"1px dashed rgba(255,255,255,0.08)",background:"rgba(255,255,255,0.02)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"border-color .15s"}} onMouseEnter={e=>e.currentTarget.style.borderColor="rgba(255,255,255,0.15)"} onMouseLeave={e=>e.currentTarget.style.borderColor="rgba(255,255,255,0.08)"}>
                <div style={{fontSize:12,color:T.mut}}>üì∑ {physiqueView}</div>
              </div>
            </div>;
          })()}
        </div>}/>

      {/* Kost */}
      {tCal>0&&<FocusCard title="Kost" scrollId="fc-kost" signal={<span style={{fontSize:11,fontWeight:700,color:costPct>=85?T.grn:T.yel}}>{costPct}% tr√§ff</span>} expanded={!!openSections.kost} onToggle={()=>toggleSection("kost")} onEdit={()=>setBuilderModal("kost")}
        headerContent={weeklyKcals.length>1?((activeIdx,scrollTo)=><div>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
            <span style={{fontSize:10,fontWeight:700,color:T.dim}}>Snitt kcal / dag</span>
            <div style={{display:"flex",alignItems:"baseline",gap:4}}>
              <span style={{fontSize:12,fontWeight:700,fontFamily:T.mono,color:T.dim}}>{weeklyKcals[activeIdx]?.kcal||0}</span>
              <span style={{fontSize:9,color:T.mut}}>/ {tCal}</span>
            </div>
          </div>
          <div style={{position:"relative"}}>
            {(()=>{const vals=weeklyKcals.map(w=>w.kcal);const mn=Math.min(...vals,tCal),mx=Math.max(...vals,tCal),rg=mx-mn||1;const tgtPct=((tCal-mn)/rg)*100;return <div style={{position:"absolute",top:(100-tgtPct)*0.72+4+"%",left:0,right:0,height:1,background:"rgba(255,255,255,0.25)",zIndex:3,pointerEvents:"none"}}>
              <span style={{position:"absolute",right:0,top:-10,fontSize:8,color:T.acc,fontWeight:600}}>m√•l</span>
            </div>})()}
            <Chart data={weeklyKcals.map(w=>w.kcal)} labels={weeklyKcals.map(w=>"V"+w.week)} h={80} color={T.acc} highlightIdx={activeIdx} smooth onDotClick={scrollTo}/>
          </div>
        </div>):null}
        weeks={prevMacros.map(wm=>({week:wm.week,data:wm}))} weekRenderer={(wk)=><div style={{padding:"8px 0"}}>
        <MacroWeekView macroWeek={wk.data} target={editMacros}/>
      </div>} currentContent={<div style={{padding:"10px 0"}}>
        <div style={{padding:"6px 0",fontSize:10,fontWeight:800,color:T.acc,textAlign:"center",borderBottom:"1px solid rgba(255,255,255,0.10)",letterSpacing:0.5,marginBottom:6}}>V{c.wkC}</div>
        <MacroWeekView macroWeek={curMacros} target={editMacros} showDetail={kostDetailOpen} onToggleDetail={()=>setKostDetailOpen(p=>!p)}/>
      </div>}/>}

      {/* Tr√§ning */}
      {curWeek&&<FocusCard title="Tr√§ning" scrollId="fc-train" signal={<span style={{fontSize:11,fontWeight:700,color:completion.pct>=90?T.grn:completion.pct>=50?T.yel:T.red}}>{completion.pct}% ({completion.done}/{completion.total} set)</span>} expanded={!!openSections.training} onToggle={()=>toggleSection("training")} onEdit={()=>setBuilderModal("training")}
        headerContent={weekVolumes.length>1?((activeIdx,scrollTo)=><div>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:6}}>
            <span style={{fontSize:10,fontWeight:700,color:T.dim}}>Volym (kg√óreps)</span>
            <span style={{fontSize:12,fontWeight:700,fontFamily:T.mono,color:T.dim}}>{Math.round(weekVolumes[activeIdx]?.vol||curVol).toLocaleString()}</span>
          </div>
          <div style={{display:"flex",alignItems:"flex-end",gap:2,height:36}}>
            {weekVolumes.map((wv,i)=>{const max=Math.max(...weekVolumes.map(w=>w.vol));const h=max>0?Math.max(4,(wv.vol/max)*36):4;const isActive=i===activeIdx;return <div key={i} onClick={()=>scrollTo&&scrollTo(i)} style={{flex:1,height:h,borderRadius:2,background:isActive?"#fff":"rgba(255,255,255,0.08)",boxShadow:isActive?"0 0 6px rgba(255,255,255,0.4)":"none",transition:"all .2s",cursor:"pointer"}}/>})}
          </div>
          <div style={{display:"flex",justifyContent:"space-between",marginTop:3}}>
            <span style={{fontSize:9,color:T.mut}}>V{weekVolumes[0]?.week}</span>
            <span style={{fontSize:9,color:T.mut}}>V{weekVolumes[weekVolumes.length-1]?.week}</span>
          </div>
        </div>):null}
        weeks={prevWeeks.map(pw=>({week:pw.week,days:pw.days}))} weekRenderer={(wk)=>{
        const hDay=wk.days[trainDayIdx];
        if(!hDay) return <div style={{padding:12,color:T.mut,fontSize:10}}>Inget pass</div>;
        const curExNames=curWeek.days[trainDayIdx]?curWeek.days[trainDayIdx].exercises.map(e=>e.n):[];
        return <div>
          {/* Day tabs in history */}
          <div style={{display:"flex",gap:3,padding:"8px 0",justifyContent:"center"}}>
            {wk.days.map((d,i)=><button key={i} onClick={()=>setTrainDayIdx(i)} style={{padding:"3px 8px",borderRadius:5,border:"1px solid "+(trainDayIdx===i?"rgba(255,255,255,0.15)":T.brd),background:trainDayIdx===i?"rgba(255,255,255,0.04)":"transparent",color:trainDayIdx===i?T.dim:T.mut,fontSize:9,fontWeight:700,cursor:"pointer",fontFamily:T.f}}>{d.name}</button>)}
          </div>
          {/* Header row */}
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:0,borderBottom:"1px solid rgba(255,255,255,0.06)"}}>
            <div style={{fontSize:8,fontWeight:700,color:T.mut,textTransform:"uppercase",letterSpacing:0.5,padding:"6px 8px"}}>PROGRAM</div>
            <div style={{fontSize:8,fontWeight:700,color:T.mut,textTransform:"uppercase",letterSpacing:0.5,padding:"6px 8px",borderLeft:"1px solid rgba(255,255,255,0.04)"}}>LOGG</div>
          </div>
          {/* Exercise rows ‚Äî unified zebra + hover */}
          {curExNames.map((name,ei)=>{
            const prog=days[trainDayIdx]?.exercises.find(e=>e.n===name);
            const ex=hDay.exercises.find(e=>e.n===name);
            return <div key={ei} style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:0,background:ei%2?ZB[1]:ZB[0],borderBottom:"1px solid rgba(255,255,255,0.03)",transition:"background .1s"}} onMouseEnter={e=>e.currentTarget.style.background="rgba(255,255,255,0.05)"} onMouseLeave={e=>e.currentTarget.style.background=ei%2?ZB[1]:ZB[0]}>
              <div style={{padding:"8px 8px"}}>
                <div style={{fontSize:11,fontWeight:600,color:T.dim}}>{name}</div>
                {prog&&<div style={{fontSize:9,color:T.mut,marginTop:2,fontFamily:T.mono}}>{prog.s}√ó{prog.r}</div>}
              </div>
              <div style={{padding:"8px 8px",borderLeft:"1px solid rgba(255,255,255,0.04)"}}>
                {ex&&ex.sets&&ex.sets.length?<div>
                  <div style={{display:"flex",alignItems:"baseline",gap:4}}>
                    <SetLine sets={ex.sets} field="kg" color={T.dim} size={11}/>
                    <span style={{fontSize:8,color:T.mut}}>kg</span>
                  </div>
                  <div style={{display:"flex",alignItems:"baseline",gap:4,marginTop:2}}>
                    <SetLine sets={ex.sets} field="reps" color={T.mut} size={10} weight={600}/>
                    <span style={{fontSize:7,color:T.mut}}>reps</span>
                  </div>
                </div>:<div style={{fontSize:10,color:T.mut}}>‚Äî</div>}
              </div>
            </div>;
          })}
        </div>}} currentContent={<div>
          <div style={{padding:"6px 0",fontSize:10,fontWeight:800,color:T.acc,textAlign:"center",borderBottom:"1px solid rgba(255,255,255,0.10)",letterSpacing:0.5}}>V{curWeek.week}</div>
          {/* Day tabs */}
          <div style={{display:"flex",gap:3,padding:"10px 0 8px",justifyContent:"center",flexWrap:"wrap"}}>
            {curWeek.days.map((d,i)=>{const done=d.exercises.every(e=>e.sets&&e.sets.length);return <button key={i} onClick={()=>setTrainDayIdx(i)} style={{padding:"4px 10px",borderRadius:5,border:"1px solid "+(trainDayIdx===i?T.acc+"50":T.brd),background:trainDayIdx===i?"rgba(255,255,255,0.06)":"transparent",color:trainDayIdx===i?T.acc:done?T.dim:T.mut,fontSize:10,fontWeight:700,cursor:"pointer",fontFamily:T.f,position:"relative"}}>
              {d.name}
              {done&&<span style={{position:"absolute",top:-2,right:-2,width:6,height:6,borderRadius:"50%",background:T.grn}}/>}
            </button>})}
          </div>
          {/* Split: program | log */}
          {(()=>{
            const dayLog=curWeek.days[trainDayIdx];
            const dayProg=days[trainDayIdx];
            if(!dayLog) return <div style={{padding:12,color:T.mut,fontSize:10}}>Inget pass valt</div>;
            return <div>
              {/* Header row */}
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:0,borderBottom:"1px solid rgba(255,255,255,0.06)"}}>
                <div style={{fontSize:9,fontWeight:700,color:T.mut,textTransform:"uppercase",letterSpacing:0.5,padding:"6px 8px"}}>PROGRAM</div>
                <div style={{fontSize:9,fontWeight:700,color:T.mut,textTransform:"uppercase",letterSpacing:0.5,padding:"6px 8px",borderLeft:"1px solid rgba(255,255,255,0.04)"}}>LOGG</div>
              </div>
              {/* Exercise rows ‚Äî unified zebra + hover */}
              {(dayProg?dayProg.exercises:[]).map((pEx,ei)=>{
                const logEx=dayLog.exercises[ei];
                return <div key={pEx.id} style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:0,background:ei%2?ZB[1]:ZB[0],borderBottom:"1px solid rgba(255,255,255,0.03)",transition:"background .1s"}} onMouseEnter={e=>e.currentTarget.style.background="rgba(255,255,255,0.05)"} onMouseLeave={e=>e.currentTarget.style.background=ei%2?ZB[1]:ZB[0]}>
                  <div style={{padding:"8px 8px"}}>
                    <div style={{fontSize:12,fontWeight:600}}>{pEx.n}</div>
                    <div style={{fontSize:9,color:T.mut,marginTop:2,fontFamily:T.mono}}>{pEx.s} √ó {pEx.r}</div>
                  </div>
                  <div style={{padding:"8px 8px",borderLeft:"1px solid rgba(255,255,255,0.04)"}}>
                    {logEx&&logEx.sets&&logEx.sets.length?<div>
                      <div style={{display:"flex",alignItems:"baseline",gap:4}}>
                        <SetLine sets={logEx.sets} field="kg" color={T.dim} size={12}/>
                        <span style={{fontSize:9,color:T.mut}}>kg</span>
                      </div>
                      <div style={{display:"flex",alignItems:"baseline",gap:4,marginTop:2}}>
                        <SetLine sets={logEx.sets} field="reps" color={T.mut} size={11} weight={600}/>
                        <span style={{fontSize:8,color:T.mut}}>reps</span>
                      </div>
                    </div>:<div style={{fontSize:11,color:T.mut}}>‚Äî</div>}
                  </div>
                </div>;
              })}
            </div>;
          })()}
        </div>}/>}
    </div>

    {/* Builder Modal */}
    {builderModal&&<div onClick={()=>setBuilderModal(null)} style={{position:"fixed",inset:0,zIndex:55,background:"rgba(0,0,0,0.8)",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",display:"flex",alignItems:"center",justifyContent:"center"}}>
      <div onClick={e=>e.stopPropagation()} style={{width:"90%",maxWidth:600,maxHeight:"85vh",background:T.bg,border:"1px solid "+T.brd,borderRadius:14,overflow:"hidden",display:"flex",flexDirection:"column"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"16px 20px",borderBottom:"1px solid "+T.brd}}>
          <div style={{fontSize:15,fontWeight:800}}>Redigera ‚Äî {builderModal==="vikt"?"Viktm√•l":builderModal==="kost"?"Kostplan":"Tr√§ningspass"}</div>
          <div onClick={()=>setBuilderModal(null)} style={{fontSize:16,color:T.mut,cursor:"pointer",padding:"2px 6px"}}>‚úï</div>
        </div>
        <div style={{flex:1,overflowY:"auto",padding:"16px 20px"}}>
          {builderModal==="vikt"&&<div>
            <div style={{fontSize:11,color:T.dim,marginBottom:12}}>M√•lvikt, v√§gningsfrekvens, tempo</div>
            <div style={{padding:20,borderRadius:8,border:"1px dashed rgba(255,255,255,0.06)",background:"rgba(255,255,255,0.02)",textAlign:"center",color:T.mut,fontSize:11}}>Viktinst√§llningar ‚Äî under utveckling</div>
          </div>}
          {builderModal==="kost"&&(()=>{
            const cal=editMacros.p*4+editMacros.c*4+editMacros.f*9;
            return <div style={{display:"flex",flexDirection:"column",alignItems:"center"}}>
              {/* Kcal auto-calculated top */}
              <div style={{fontSize:9,color:T.mut,textTransform:"uppercase",letterSpacing:3,marginBottom:4}}>Dagligt m√•l</div>
              <div style={{fontSize:32,fontWeight:800,fontFamily:T.mono,color:T.acc,lineHeight:1}}>{cal}<span style={{fontSize:12,fontWeight:600,color:T.dim}}> kcal</span></div>
              <div style={{display:"flex",gap:16,marginTop:8,marginBottom:20}}>
                {[["Protein",editMacros.p,T.blu],["Kolhydrater",editMacros.c,T.yel],["Fett",editMacros.f,T.red]].map(([l,v,col])=>
                  <div key={l} style={{textAlign:"center"}}>
                    <div style={{fontSize:16,fontWeight:800,fontFamily:T.mono,color:col}}>{v}<span style={{fontSize:9,fontWeight:600}}>g</span></div>
                    <div style={{fontSize:8,color:T.mut}}>{l}</div>
                  </div>
                )}
              </div>
              {/* Sliders centered */}
              <div style={{width:"100%",maxWidth:360}}>
                {[["Protein","p",T.blu],["Kolhydrater","c",T.yel],["Fett","f",T.red]].map(([label,key,col])=>
                  <div key={key} style={{marginBottom:12}}>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3}}>
                      <span style={{fontSize:11,fontWeight:700,color:col}}>{label}</span>
                      <MacroVal value={editMacros[key]} color={col} unit="g" size={16} onChange={v=>{markChanged();setEditMacros(p=>({...p,[key]:v}))}}/>
                    </div>
                    <input type="range" min={0} max={400} step={5} value={editMacros[key]} onChange={e=>{markChanged();setEditMacros(p=>({...p,[key]:Number(e.target.value)}))}} style={{width:"100%",accentColor:col,height:6,cursor:"pointer"}}/>
                  </div>
                )}
              </div>
            </div>;
          })()}
          {builderModal==="training"&&(()=>{
            const di=trainDayIdx;
            const dayData=days[di];
            return <div>
              {/* Day tabs - double click to rename + add */}
              <div style={{display:"flex",gap:3,marginBottom:12,flexWrap:"wrap",alignItems:"center"}}>
                {days.map((d,i)=>editingDay===i?<input key={i} autoFocus value={d.name} onChange={e=>{markChanged();setDays(p=>p.map((dd,di)=>di===i?{...dd,name:e.target.value}:dd))}} onBlur={()=>setEditingDay(null)} onKeyDown={e=>{if(e.key==="Enter")setEditingDay(null)}} style={{padding:"5px 12px",borderRadius:6,border:"1px solid "+T.acc,background:"rgba(255,255,255,0.06)",color:T.acc,fontSize:10,fontWeight:700,fontFamily:T.f,outline:"none",width:Math.max(60,d.name.length*7)}}/>:<button key={i} onClick={()=>{setTrainDayIdx(i);setAddOpen(null);setSwapId(null)}} onDoubleClick={()=>setEditingDay(i)} style={{padding:"5px 12px",borderRadius:6,border:"1px solid "+(di===i?T.acc+"50":T.brd),background:di===i?"rgba(255,255,255,0.06)":"transparent",color:di===i?T.acc:T.dim,fontSize:10,fontWeight:700,cursor:"pointer",fontFamily:T.f}}>{d.name}</button>)}
                <button onClick={()=>{markChanged();const ni=days.length;setDays(p=>[...p,{id:"d"+Date.now(),name:"Dag "+(ni+1),exercises:[]}]);setTrainDayIdx(ni)}} style={{padding:"5px 10px",borderRadius:6,border:"1px dashed rgba(255,255,255,0.15)",background:"transparent",color:T.acc,fontSize:10,fontWeight:700,cursor:"pointer",fontFamily:T.f}}>+</button>
              </div>
              <div style={{fontSize:8,color:T.mut,marginBottom:10}}>Dubbelklicka p√• ett pass f√∂r att byta namn</div>
              {dayData&&<div>
                <div style={{fontSize:11,color:T.dim,marginBottom:8}}>√ñvningar ‚Äî {dayData.name}</div>
              {dayData.exercises.map((ex,idx)=><div key={ex.id} draggable
                onDragStart={e=>{e.dataTransfer.effectAllowed="move";setDragState({di,idx,overIdx:null})}}
                onDragOver={e=>{e.preventDefault();e.dataTransfer.dropEffect="move";if(dragState.overIdx!==idx)setDragState(p=>({...p,overIdx:idx}))}}
                onDrop={e=>{e.preventDefault();if(dragState.idx!==null)reorderEx(di,dragState.idx,idx);setDragState({di:null,idx:null,overIdx:null})}}
                onDragEnd={()=>setDragState({di:null,idx:null,overIdx:null})}
                onTouchStart={e=>{const t=setTimeout(()=>{setDragState({di,idx,overIdx:null});e.currentTarget.style.opacity="0.5"},300);e.currentTarget._holdTimer=t}}
                onTouchMove={e=>{if(dragState.idx===null)return;const touch=e.touches[0];const el=document.elementFromPoint(touch.clientX,touch.clientY);if(el){const row=el.closest("[data-exidx]");if(row){const oi=parseInt(row.dataset.exidx);if(!isNaN(oi))setDragState(p=>({...p,overIdx:oi}))}}}}
                onTouchEnd={e=>{clearTimeout(e.currentTarget._holdTimer);e.currentTarget.style.opacity="1";if(dragState.idx!==null&&dragState.overIdx!==null)reorderEx(di,dragState.idx,dragState.overIdx);setDragState({di:null,idx:null,overIdx:null})}}
                data-exidx={idx}
                style={{padding:"8px 0",borderBottom:"1px solid rgba(255,255,255,0.04)",opacity:dragState.idx===idx?0.4:1,borderTop:dragState.overIdx===idx&&dragState.idx!==idx?"2px solid "+T.acc:"2px solid transparent",transition:"border-top .1s, opacity .1s",cursor:"grab"}}>
                <div style={{display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                  <div style={{display:"flex",alignItems:"center",gap:8}}>
                    <div style={{display:"flex",flexDirection:"column",gap:1,cursor:"grab",padding:"4px 2px",opacity:0.25,flexShrink:0}}>
                      <div style={{width:10,height:1.5,background:"#fff",borderRadius:1}}/>
                      <div style={{width:10,height:1.5,background:"#fff",borderRadius:1}}/>
                      <div style={{width:10,height:1.5,background:"#fff",borderRadius:1}}/>
                    </div>
                    <div style={{width:24,height:24,borderRadius:6,background:MC[ex.m]?MC[ex.m]+"15":"rgba(255,255,255,0.03)",border:"1px solid "+(MC[ex.m]?MC[ex.m]+"25":"rgba(255,255,255,0.05)"),display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0}}><div style={{width:4,height:4,borderRadius:"50%",background:MC[ex.m]||T.mut}}/></div>
                    <div>
                      <div onClick={()=>setSwapId(swapId===ex.id?null:ex.id)} style={{fontSize:12,fontWeight:600,cursor:"pointer"}}>{ex.n}</div>
                      {swapId===ex.id&&<div style={{marginTop:4,background:"#1a1a1a",border:"1px solid "+T.brd,borderRadius:8,padding:4,minWidth:180,maxHeight:140,overflowY:"auto"}}>
                        {EX_DB.filter(e=>e.muscle===ex.m&&e.name!==ex.n).map((e,i)=><button key={i} onClick={()=>{updEx(di,ex.id,"n",e.name);setSwapId(null)}} style={{display:"block",width:"100%",background:"none",border:"none",color:T.dim,fontSize:11,cursor:"pointer",padding:"4px 6px",fontFamily:T.f,textAlign:"left",borderRadius:4}}>{e.name}</button>)}
                      </div>}
                    </div>
                  </div>
                  <div style={{display:"flex",alignItems:"center",gap:6}}>
                    <RepPicker value={ex.r} onChange={v=>updEx(di,ex.id,"r",v)}/>
                    <span style={{color:T.mut,fontSize:10}}>√ó</span>
                    <SetPicker value={ex.s} onChange={v=>updEx(di,ex.id,"s",v)}/>
                    <button onClick={()=>rmEx(di,ex.id)} style={{background:"none",border:"none",color:"rgba(255,255,255,0.15)",cursor:"pointer",fontSize:14,marginLeft:4}}>√ó</button>
                  </div>
                </div>
              </div>)}
              {addOpen===di?<div style={{marginTop:8,padding:10,background:"rgba(255,255,255,0.02)",borderRadius:8,border:"1px solid "+T.brd}}>
                {/* Muscle group tabs */}
                <div style={{display:"flex",gap:2,marginBottom:6,flexWrap:"wrap"}}>
                  {MUSCLES.map(m=><button key={m} onClick={()=>setMuscleFilter(m)} style={{padding:"2px 8px",borderRadius:4,border:"1px solid "+(muscleFilter===m?T.acc+"40":T.brd),background:muscleFilter===m?"rgba(255,255,255,0.04)":"transparent",color:muscleFilter===m?T.acc:T.mut,fontSize:8,fontWeight:700,cursor:"pointer",fontFamily:T.f}}>{m}</button>)}
                </div>
                <Input placeholder="S√∂k √∂vning..." value={exS} onChange={setExS} small/>
                <div style={{maxHeight:140,overflowY:"auto",marginTop:4}}>
                  {filtE.length===0?<div style={{color:T.mut,fontSize:10,padding:4}}>Ingen match</div>:filtE.slice(0,10).map((e,i)=><button key={i} onClick={()=>addE(di,e.name,e.muscle)} style={{display:"flex",alignItems:"center",gap:6,width:"100%",background:"none",border:"none",color:T.dim,fontSize:11,cursor:"pointer",padding:"5px 6px",fontFamily:T.f,textAlign:"left",borderRadius:4}} onMouseEnter={e=>e.currentTarget.style.background="rgba(255,255,255,0.04)"} onMouseLeave={e=>e.currentTarget.style.background="none"}>
                    <span style={{width:5,height:5,borderRadius:"50%",background:MC[e.muscle]||T.mut,flexShrink:0}}/>
                    <span style={{flex:1}}>{e.name}</span>
                    <span style={{fontSize:8,color:T.mut}}>{e.muscle}</span>
                  </button>)}
                </div>
                {/* Custom exercise */}
                <div style={{borderTop:"1px solid "+T.brd,marginTop:6,paddingTop:6}}>
                  <div style={{fontSize:8,fontWeight:700,color:T.mut,marginBottom:4}}>SKAPA EGEN √ñVNING</div>
                  <div style={{display:"flex",gap:4}}>
                    <input placeholder="√ñvningsnamn" value={newExName} onChange={e=>setNewExName(e.target.value)} style={{flex:1,padding:"4px 8px",borderRadius:4,border:"1px solid "+T.brd,background:"rgba(255,255,255,0.03)",color:"#fff",fontSize:10,fontFamily:T.f,outline:"none"}}/>
                    <select value={muscleFilter!=="Alla"?muscleFilter:"Brost"} onChange={e=>setMuscleFilter(e.target.value)} style={{padding:"4px 6px",borderRadius:4,border:"1px solid "+T.brd,background:"rgba(255,255,255,0.03)",color:T.dim,fontSize:9,fontFamily:T.f}}>
                      {MUSCLES.filter(m=>m!=="Alla").map(m=><option key={m} value={m}>{m}</option>)}
                    </select>
                    <button onClick={()=>{if(!newExName.trim())return;const m=muscleFilter!=="Alla"?muscleFilter:"Brost";setCustomEx(p=>[...p,{name:newExName.trim(),muscle:m}]);addE(di,newExName.trim(),m);setNewExName("")}} style={{padding:"4px 10px",borderRadius:4,border:"1px solid "+T.acc,background:"rgba(255,255,255,0.06)",color:T.acc,fontSize:9,fontWeight:700,cursor:"pointer",fontFamily:T.f}}>+</button>
                  </div>
                </div>
                <Btn v="ghost" onClick={()=>{setAddOpen(null);setExS("");setMuscleFilter("Alla")}} style={{marginTop:6,fontSize:9}}>St√§ng</Btn>
              </div>:<button onClick={()=>setAddOpen(di)} style={{marginTop:8,background:"none",border:"1px dashed rgba(255,255,255,0.08)",borderRadius:6,color:T.mut,padding:"8px",cursor:"pointer",fontFamily:T.f,fontSize:10,width:"100%"}}>+ L√§gg till √∂vning</button>}
              </div>}
              {!dayData&&<div style={{padding:20,textAlign:"center",color:T.mut,fontSize:11}}>V√§lj en dag</div>}
            </div>;
          })()}
        </div>
        <div style={{padding:"12px 20px",borderTop:"1px solid "+T.brd,display:"flex",justifyContent:"flex-end",gap:8}}>
          <Btn v="ghost" onClick={()=>setBuilderModal(null)}>Avbryt</Btn>
          <Btn onClick={()=>{markChanged();setBuilderModal(null)}}>Spara</Btn>
        </div>
      </div>
    </div>}

    {/* Lightbox */}
    {lightbox&&<div onClick={()=>setLightbox(null)} style={{position:"fixed",inset:0,zIndex:60,background:"rgba(0,0,0,0.85)",backdropFilter:"blur(12px)",WebkitBackdropFilter:"blur(12px)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"}}>
      <div onClick={e=>e.stopPropagation()} style={{maxWidth:500,width:"90%",cursor:"default"}}>
        <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
          <div style={{fontSize:13,fontWeight:700}}>V{lightbox.week} ‚Äî {lightbox.view}</div>
          <div onClick={()=>setLightbox(null)} style={{fontSize:16,color:T.mut,cursor:"pointer",padding:"2px 6px"}}>‚úï</div>
        </div>
        <div style={{width:"100%",height:400,borderRadius:10,border:"1px dashed rgba(255,255,255,0.1)",background:"rgba(255,255,255,0.03)",display:"flex",alignItems:"center",justifyContent:"center",flexDirection:"column",gap:8}}>
          <div style={{fontSize:40,opacity:0.1}}>üì∑</div>
          <div style={{fontSize:11,color:T.mut}}>{lightbox.view} ‚Äî Vecka {lightbox.week}</div>
        </div>
        {/* View switcher */}
        <div style={{display:"flex",justifyContent:"center",gap:4,marginTop:12}}>
          {["Fram","Sida","Rygg"].map(v=><button key={v} onClick={()=>setLightbox(p=>({...p,view:v}))} style={{padding:"5px 16px",borderRadius:6,border:"1px solid "+(lightbox.view===v?T.acc:T.brd),background:lightbox.view===v?"rgba(255,255,255,0.06)":"transparent",color:lightbox.view===v?T.acc:T.dim,fontSize:10,fontWeight:700,cursor:"pointer",fontFamily:T.f}}>
            {v}
          </button>)}
        </div>
      </div>
    </div>}

    {/* Floating send button */}
    <div style={{position:"fixed",bottom:20,left:"50%",transform:"translateX(-50%)",zIndex:30}}>
      <Btn onClick={()=>onSend(changed?"updated":"copy")} style={{padding:"12px 32px",fontSize:14,borderRadius:12,letterSpacing:0.5,textTransform:"uppercase"}}>{changed?"Skicka uppdaterat":"Skicka samma"}</Btn>
    </div>
  </div>;
}

// ===================== LOADING OVERLAY =====================
function LoadingOverlay({name,onDone}) {
  const [phase,setPhase]=useState(0);
  useState(()=>{setTimeout(()=>setPhase(1),50);setTimeout(()=>setPhase(2),600);setTimeout(()=>setPhase(3),1100);setTimeout(()=>onDone(),1400);});
  return <div style={{position:"fixed",inset:0,zIndex:100,background:T.bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",transition:"opacity .3s",opacity:phase>=1?1:0}}>
    <div style={{marginBottom:20,transition:"transform .4s ease, opacity .4s",transform:phase>=1?"scale(1)":"scale(0.8)",opacity:phase>=1?1:0}}>
      <Pfp name={name} gender="" size={64}/>
    </div>
    <div style={{fontSize:15,fontWeight:700,transition:"opacity .3s",opacity:phase>=1?1:0}}>{name}</div>
    <div style={{marginTop:12,display:"flex",gap:6}}>
      {[0,1,2].map(i=><div key={i} style={{width:6,height:6,borderRadius:"50%",background:T.acc,opacity:phase>=2?1:0.15,transition:"opacity .2s",transitionDelay:i*100+"ms"}}/>)}
    </div>
    <div style={{marginTop:10,fontSize:11,color:T.dim,transition:"opacity .3s",opacity:phase>=3?1:0}}>Laddar klientdata...</div>
  </div>;
}

// ===================== SEND OVERLAY =====================
function SendOverlay({name,onDone}) {
  const [phase,setPhase]=useState(0);
  useState(()=>{setTimeout(()=>setPhase(1),100);setTimeout(()=>setPhase(2),1500);setTimeout(()=>onDone(),2800);});
  return <div style={{position:"fixed",inset:0,zIndex:100,background:"rgba(26,26,26,0.95)",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",transition:"opacity .5s",opacity:phase>=1?1:0}}>
    <div style={{fontSize:48,marginBottom:16,transition:"transform .5s",transform:phase>=1?"scale(1)":"scale(0.5)"}}>{phase<2?"...":"OK"}</div>
    <div style={{fontSize:18,fontWeight:700,color:T.acc,transition:"opacity .5s",opacity:phase>=2?1:0}}>Skickat till {name}!</div>
    <div style={{fontSize:12,color:T.dim,marginTop:8,transition:"opacity .5s",opacity:phase>=2?1:0}}>Atergar till dashboard...</div>
  </div>;
}

// ===================== ONBOARDING =====================
function OnboardingFlow({client,templates,tplGroups,onDone}) {
  const [step,setStep]=useState(0);
  const [maxStep,setMaxStep]=useState(0);
  const goStep=(s)=>{setStep(s);setMaxStep(m=>Math.max(m,s));};
  const [assess,setAssess]=useState({split:client.split,level:client.level,goal:client.goal,weeks:String(client.wkT||12)});
  const [days,setDays]=useState([]);
  const [tplName,setTplName]=useState("");
  const [macros,setMacros]=useState(null);
  const [mealPlan,setMealPlan]=useState(null);
  function selectTpl(t){setDays(t.days.map((d,i)=>({id:"d"+i,name:d.name,exercises:d.ex.map((e,j)=>({...e,id:"e"+i+j}))})));setTplName(t.name);goStep(2);}
  function startScratch(){const n=parseInt(assess.split,10);setDays(Array.from({length:n},(_,i)=>({id:"d"+i,name:"Dag "+(i+1),exercises:[]})));setTplName("");goStep(2);}
  const stepNames=["Bedomning","Mall","Program","Granska","Makron","Maltider","Skicka"];
  const defMacros=macros||{cal:2200,p:160,c:220,f:60};
  return <div>
    <Steps steps={stepNames} current={step} maxReached={maxStep} onClick={setStep}/>
    {step===0&&<StepAssess client={client} assess={assess} setAssess={setAssess} onNext={()=>goStep(1)}/>}
    {step===1&&<StepTemplatePick assess={assess} templates={templates} tplGroups={tplGroups} onSelect={selectTpl} onScratch={startScratch}/>}
    {step===2&&<StepFinetune days={days} setDays={setDays} tplName={tplName} onNext={()=>goStep(3)}/>}
    {step===3&&<StepReviewProg days={days} onNext={()=>goStep(4)}/>}
    {step===4&&<StepMacros client={{...client,goal:assess.goal}} onNext={m=>{setMacros(m);goStep(5)}}/>}
    {step===5&&<StepMeal macros={defMacros} mealPlan={mealPlan} setMealPlan={setMealPlan} onNext={()=>goStep(6)}/>}
    {step===6&&<StepFinal client={client} days={days} macros={defMacros} mealPlan={mealPlan} tplGroups={tplGroups} onSend={data=>onDone({days,macros:defMacros,mealPlan,...data})}/>}
  </div>;
}

// ===================== WHEEL PICKER =====================
const ZB=["transparent","rgba(255,255,255,0.025)"]; // zebra backgrounds

// KG values ‚Äî non-linear like FitLog
const WHEEL_KG=[];
for(let i=0;i<=10;i++)WHEEL_KG.push(i);
for(let i=12;i<=30;i+=2)WHEEL_KG.push(i);
for(let i=35;i<=200;i+=5)WHEEL_KG.push(i);
const WHEEL_REPS=Array.from({length:50},(_,i)=>i+1);

const WHEEL_DECIMALS=[0.25,0.5,0.75];
const WHEEL_DEC_LABELS=[",25",",5",",75"];

function FitLogWheel({items,labels,value,onChange,color=T.acc,textColor="#fff",dimColor=T.mut,bgColor="rgba(255,255,255,0.03)",width=130,itemH=80,visCount=5}) {
  const IH=itemH;
  const VIS=visCount;
  const CH=IH*VIS;
  const PAD=IH*Math.floor(VIS/2);
  const ref=useRef(null);
  const scrolling=useRef(false);
  const mounted=useRef(false);
  
  // Find index ‚Äî float-safe
  const findIdx=(val)=>{
    let best=0,bestD=Infinity;
    for(let i=0;i<items.length;i++){
      const d=Math.abs(items[i]-val);
      if(d<bestD){bestD=d;best=i;}
    }
    return best;
  };
  
  // Scroll to value on mount
  useEffect(()=>{
    if(!ref.current)return;
    const idx=findIdx(value);
    ref.current.scrollTop=idx*IH;
    mounted.current=true;
  },[]);
  
  // Scroll to value when changed externally (not by scroll)
  useEffect(()=>{
    if(!ref.current||!mounted.current||scrolling.current)return;
    const idx=findIdx(value);
    const target=idx*IH;
    if(Math.abs(ref.current.scrollTop-target)>IH*0.4){
      ref.current.scrollTop=target;
    }
  },[value]);
  
  const handleScroll=useCallback(()=>{
    if(!ref.current)return;
    scrolling.current=true;
    const i=Math.round(ref.current.scrollTop/IH);
    const clamped=Math.max(0,Math.min(items.length-1,i));
    if(Math.abs(items[clamped]-value)>0.001) onChange(items[clamped]);
    clearTimeout(ref.current._t);
    ref.current._t=setTimeout(()=>{scrolling.current=false},200);
  },[items,value,onChange]);
  
  const accentBg=color+"25";
  const fs=IH>=70?"2.2rem":IH>=50?"1.4rem":"1.1rem";
  const selIdx=findIdx(value);
  
  return <div style={{position:"relative",height:CH,width,overflow:"hidden",borderRadius:16,background:bgColor}}>
    {/* Highlight zone ‚Äî exactly at slot 3 (index 2) */}
    <div style={{position:"absolute",top:PAD,left:6,right:6,height:IH,background:accentBg,border:"2px solid "+color,borderRadius:12,pointerEvents:"none",zIndex:2}}/>
    {/* Scroll area */}
    <div ref={ref} onScroll={handleScroll} data-whl="1" style={{height:"100%",overflowY:"scroll",scrollSnapType:"y mandatory",WebkitOverflowScrolling:"touch",scrollbarWidth:"none",msOverflowStyle:"none",position:"relative",zIndex:1,scrollPaddingTop:PAD}}>
      <style>{`[data-whl]::-webkit-scrollbar{display:none}`}</style>
      <div style={{height:PAD}}/>
      {items.map((v,i)=>{
        const sel=i===selIdx;
        return <div key={i} style={{height:IH,display:"flex",alignItems:"center",justifyContent:"center",scrollSnapAlign:"start",fontSize:fs,fontWeight:sel?700:500,color:sel?textColor:dimColor,opacity:sel?1:0.3,transition:"opacity .15s, color .15s",fontFamily:T.mono}}>
          {labels?labels[i]:v}
        </div>;
      })}
      <div style={{height:PAD}}/>
    </div>
  </div>;
}

// Simpler wheel for weight tab (smaller)
function WheelPicker({value,min=0,max=200,step=0.5,unit="kg",color=T.acc,onChange}) {
  const items=[];for(let v=min;v<=max;v+=step)items.push(Math.round(v*10)/10);
  return <FitLogWheel items={items} value={value} onChange={onChange} color={color} width={160} itemH={50} visCount={3}/>;
}

// ===================== CLIENT APP =====================
function ClientApp({client:initC,sharedData,onSendWeek,demoPlan:dpProp,isSolo,onShuffle}) {
  const c=initC;
  const [tab,setTab]=useState("train"); // train | food | weight | checkin
  const [trainDay,setTrainDay]=useState(0);
  const [localProg,setLocalProg]=useState(null);
  const prog=localProg||c.program||[];
  const [shuffleAnim,setShuffleAnim]=useState(false);
  
  // Training log state ‚Äî init from week 6 mock (partially filled)
  const [trainLog,setTrainLog]=useState(()=>{
    const wk6=c.weeklyLogs?.find(w=>w.week===6);
    if(wk6) return wk6.days.map((d,di)=>{
      const pDay=prog[di];
      return {name:d.name,exercises:d.exercises.map((e,ei)=>{
        const tgt=pDay?.ex[ei]?.s||3;
        const logged=e.sets?e.sets.map(s=>({kg:s.kg,reps:s.reps})):[];
        while(logged.length<tgt) logged.push({kg:0,reps:0});
        return {n:e.n,sets:logged};
      })};
    });
    return prog.map(d=>({name:d.name,exercises:d.ex.map(e=>({n:e.n,sets:Array.from({length:e.s},()=>({kg:0,reps:0}))}))}));
  });
  
  // Macro log state ‚Äî week 6 data
  const DN=["M√•n","Tis","Ons","Tor","Fre","L√∂r","S√∂n"];
  const [macroLog,setMacroLog]=useState(()=>{
    const wk6=c.weeklyMacros?.find(w=>w.week===6);
    if(wk6) return wk6.days.map(d=>({d:d.d,p:d.p,c:d.c,f:d.f}));
    return DN.map(d=>({d,p:0,c:0,f:0}));
  });
  const [macroDay,setMacroDay]=useState(0);
  const [foodMode,setFoodMode]=useState("meals"); // "meals" | "shop" | "macro"
  const [mealChecked,setMealChecked]=useState(()=>DN.map(()=>[])); // 7 arrays of bools
  const [expandedMeal,setExpandedMeal]=useState(null); // null | {day,idx}
  const [shopChecked,setShopChecked]=useState([]); // bools per aggregated ingredient
  
  // Aggregate unique ingredients from meal plan
  const shopItems=(() => {
    if(!c.mealPlan)return[];
    const map={};
    c.mealPlan.forEach(day=>{
      day.meals.forEach(m=>{
        (m.ingredients||[]).forEach(ing=>{
          const key=ing.toLowerCase();
          if(!map[key])map[key]=ing;
        });
      });
    });
    return Object.values(map);
  })();
  
  // Sync shopChecked length with shopItems
  useEffect(()=>{
    if(shopItems.length>0&&shopChecked.length!==shopItems.length){
      setShopChecked(shopItems.map(()=>false));
    }
  },[shopItems.length]);
  const [showDoneMeals,setShowDoneMeals]=useState(false);
  const [macroTip,setMacroTip]=useState(false);
  const [animMeal,setAnimMeal]=useState(null);
  const [animShop,setAnimShop]=useState(null);
  const [foodCelebration,setFoodCelebration]=useState(null); // null or {day, kcal, tip}
  
  // Weight log state
  const [weightLog,setWeightLog]=useState(()=>{
    const wk6=c.wIns?.find(w=>w.w===6);
    return wk6?.days?[...wk6.days]:DN.map(()=>0);
  });
  const [weightDay,setWeightDay]=useState(0);
  const [weighTip,setWeighTip]=useState(false);
  const [weightSaved,setWeightSaved]=useState(DN.map(()=>false));
  const [progressPhotos,setProgressPhotos]=useState([]);
  
  // Check-in state
  const [msg,setMsg]=useState(c.message||"");
  const [selfAssess,setSelfAssess]=useState(c.selfAssess||{difficulty:"",energy:"",mood:""});
  const [sent,setSent]=useState(false);
  const [sending,setSending]=useState(false);
  const [sendDots,setSendDots]=useState(0);
  const [tabFade,setTabFade]=useState(false);
  const [weightPulse,setWeightPulse]=useState(false);
  const [weightCelebration,setWeightCelebration]=useState(null); // null or {value, day, tip, allDone, count}
  
  // Animation states
  const [wkDone,setWkDone]=useState(null);
  
  // FitLog workout mode state
  const [trainView,setTrainView]=useState("days"); // "days" | "exercises" | "workout"
  const [showDoneDays,setShowDoneDays]=useState(false);
  const [trainHistWeek,setTrainHistWeek]=useState(null); // null = current week, number = historical week index
  const [histDayLog,setHistDayLog]=useState(null); // null = current, or {name, exercises} for read-only view
  const [wkExIdx,setWkExIdx]=useState(0);
  const [wkSetIdx,setWkSetIdx]=useState(0);
  const [wkStep,setWkStep]=useState("perform"); // "perform" | "log" | "rest" | "exTransition"
  const [wkCountdown,setWkCountdown]=useState(0); // 3,2,1,0
  const [exTransition,setExTransition]=useState(null); // null or {name, muscle, icon, setOf, exNum, totalEx}
  const [wkKg,setWkKg]=useState(0);
  const [wkDec,setWkDec]=useState(0);
  const [showDec,setShowDec]=useState(false);
  const [wkReps,setWkReps]=useState(0);
  const [restSec,setRestSec]=useState(0);
  const [restTotal,setRestTotal]=useState(0);
  const [infoModal,setInfoModal]=useState(null); // null | "perform" | "rest"
  const [exPopup,setExPopup]=useState(null); // null | exercise name string for bottom sheet
  const restRef=useRef(null);
  
  const curDay=trainLog[trainDay];
  const curProg=prog[trainDay];
  
  // Navigation ‚Äî go prev/next set in workout mode
  const goPrevSet=()=>{
    clearInterval(restRef.current);
    let ei=wkExIdx,si=wkSetIdx;
    if(si>0){si--}
    else if(ei>0){ei--;si=(curProg.ex[ei]?.s||3)-1}
    else return;
    setWkExIdx(ei);setWkSetIdx(si);setWkStep("perform");setRestSec(0);
  };
  const goNextSet=()=>{
    clearInterval(restRef.current);
    let ei=wkExIdx,si=wkSetIdx;
    const tgt=curProg?.ex[ei]?.s||3;
    if(si<tgt-1){si++}
    else if(ei<(curProg?.ex?.length||1)-1){ei++;si=0}
    else return;
    setWkExIdx(ei);setWkSetIdx(si);setWkStep("perform");setRestSec(0);
  };
  const canGoPrev=wkExIdx>0||wkSetIdx>0;
  const canGoNext=curProg&&(wkExIdx<curProg.ex.length-1||wkSetIdx<(curProg.ex[wkExIdx]?.s||3)-1);
  
  const getRestTime=(repsStr)=>{
    const parts=String(repsStr).split("-");
    const mx=parseInt(parts[parts.length-1])||10;
    if(mx<=4)return 300;if(mx<=6)return 180;if(mx<=8)return 150;if(mx<=10)return 90;if(mx<=12)return 60;return 45;
  };
  const fmtTime=s=>`${Math.floor(s/60)}:${String(s%60).padStart(2,"0")}`;
  
  // Rest timer effect ‚Äî just counts down
  useEffect(()=>{
    if(wkStep==="rest"&&restSec>0){
      restRef.current=setInterval(()=>setRestSec(p=>{if(p<=1){clearInterval(restRef.current);return 0}return p-1}),1000);
      return ()=>clearInterval(restRef.current);
    }
  },[wkStep]);
  
  // When rest hits 0, advance ‚Äî show transition if new exercise
  useEffect(()=>{
    if(wkStep==="rest"&&restSec===0){
      if(!curProg)return;
      const prevExIdx=wkExIdx;
      let nextEi=null,nextSi=null;
      for(let i=wkExIdx;i<curProg.ex.length;i++){
        const tgt=curProg.ex[i].s||3;
        const dex=trainLog[trainDay]?.exercises[i];
        const startS=i===wkExIdx?wkSetIdx+1:0;
        for(let s=startS;s<tgt;s++){if(!dex?.sets[s]?.reps){nextEi=i;nextSi=s;break;}}
        if(nextEi!==null)break;
      }
      if(nextEi===null){
        setWkStep("perform");
        setTrainView("exercises");
        return;
      }
      // New exercise? Show transition
      if(nextEi!==prevExIdx){
        const nextEx=curProg.ex[nextEi];
        const mIcon={"Brost":"üèãÔ∏è","Rygg":"üßó","Axlar":"üí™","Ben":"ü¶µ","Biceps":"üí™","Triceps":"üí™","Mage":"üî•"}[nextEx.m]||"üèãÔ∏è";
        setExTransition({name:nextEx.n,muscle:nextEx.m,icon:mIcon,setOf:nextEx.s||3,exNum:nextEi+1,totalEx:curProg.ex.length});
        setWkExIdx(nextEi);setWkSetIdx(nextSi);setWkStep("exTransition");
        setTimeout(()=>{setWkStep("perform");setExTransition(null);},1500);
      } else {
        setWkExIdx(nextEi);setWkSetIdx(nextSi);setWkStep("perform");
      }
    }
  },[restSec]);
  
  const startWorkout=()=>{
    // Find first incomplete exercise/set
    let targetEi=null,targetSi=null;
    for(let i=0;i<(curProg?.ex?.length||0);i++){
      const tgt=curProg.ex[i].s||3;
      const dex=trainLog[trainDay].exercises[i];
      for(let s=0;s<tgt;s++){if(!dex?.sets[s]?.reps){targetEi=i;targetSi=s;break;}}
      if(targetEi!==null)break;
    }
    if(targetEi===null){setTrainView("exercises");return;}
    // Start countdown
    setWkExIdx(targetEi);setWkSetIdx(targetSi);setWkStep("perform");
    setWkCountdown(3);setTrainView("workout");
    let c=3;
    const iv=setInterval(()=>{c--;setWkCountdown(c);if(c<=0)clearInterval(iv);},800);
  };
  
  const logCurrentSet=()=>{
    updateSet(trainDay,wkExIdx,wkSetIdx,"kg",wkKg+wkDec);
    updateSet(trainDay,wkExIdx,wkSetIdx,"reps",wkReps);
    // Check if this was the last set
    let allDone=true;
    for(let i=0;i<(curProg?.ex?.length||0);i++){
      const tgt=curProg.ex[i].s||3;
      const dex=trainLog[trainDay]?.exercises[i];
      for(let s=0;s<tgt;s++){
        const isThis=i===wkExIdx&&s===wkSetIdx;
        if(!isThis&&!dex?.sets[s]?.reps){allDone=false;break;}
      }
      if(!allDone)break;
    }
    if(allDone){
      // Workout complete ‚Äî show summary after brief delay
      setTimeout(()=>{
        const totalSets=curProg.ex.reduce((s,e)=>s+(e.s||3),0);
        setWkDone({sets:totalSets,exercises:curProg.ex.length,day:trainLog[trainDay]?.name||"Pass"});
      },700);
      return;
    }
    const rest=getRestTime(curProg?.ex[wkExIdx]?.r||"10");
    setRestTotal(rest);
    setRestSec(rest);
    setWkStep("rest");
  };
  
  // Progress calculation for workout mode
  const getProgress=()=>{
    if(!curProg)return{positions:[],pct:0,total:0,done:0};
    let total=0,done=0;const positions=[];
    curProg.ex.forEach((ex,ei)=>{
      const tgt=ex.s||3;const dex=trainLog[trainDay]?.exercises[ei];
      for(let s=0;s<tgt;s++){
        const complete=!!dex?.sets[s]?.reps;
        const isCur=ei===wkExIdx&&s===wkSetIdx;
        positions.push({pct:0,complete,isCur,isExStart:s===0,exIdx:ei});
        if(complete)done++;total++;
      }
    });
    positions.forEach((p,i)=>p.pct=(i/total)*100);
    return{positions,pct:total>0?(done/total)*100:0,total,done};
  };
  
  const updateSet=(dI,eI,sI,field,val)=>{
    setTrainLog(p=>p.map((d,di)=>di!==dI?d:{...d,exercises:d.exercises.map((e,ei)=>ei!==eI?e:{...e,sets:e.sets.map((s,si)=>si!==sI?s:{...s,[field]:val})})}));
  };

  const kcal=(p,cc,f)=>p*4+cc*4+f*9;
  
  const TABS=isSolo?[["food","Kost","üçΩÔ∏è"],["train","Tr√§ning","üèãÔ∏è"]]:
    [["checkin","Check-in","üì®"],["weight","Vikt","‚öñÔ∏è"],["food","Kost","üçΩÔ∏è"],["train","Tr√§ning","üèãÔ∏è"]];
  const plan=dpProp||c.plan||"full";
  const isLocked=(tabId)=>{
    if(plan==="full")return false;
    if(plan==="train_only"&&(tabId==="food"||tabId==="weight"))return true;
    if(plan==="food_only"&&tabId==="train")return true;
    return false;
  };
  
  const isFood=tab==="food";
  const isWeight=tab==="weight";
  const isCheckin=tab==="checkin";
  const foodBg="#f5efe4";
  const foodHdr="rgba(245,239,228,0.96)";
  const foodText="#2c2418";
  // Bathroom blue palette
  const W={bg:"#e8f0f6",bg2:"#dce8f0",hdr:"rgba(232,240,246,0.96)",text:"#1a2e3e",dim:"#5a7a8e",mut:"#8aa4b4",acc:"#3d7a9c",acc2:"#2c6080",brd:"rgba(60,120,160,0.15)",card:"rgba(255,255,255,0.65)",cardHi:"rgba(255,255,255,0.85)",font:"'Inter','Helvetica Neue',sans-serif"};
  // Locked tab palette
  // POST palette for check-in
  const CI={bg:"#002d5a",hdr:"rgba(0,38,76,0.95)",text:"#fff",dim:"rgba(255,255,255,0.6)",mut:"rgba(255,255,255,0.35)",acc:"#ffcc00",brd:"rgba(255,255,255,0.12)",card:"rgba(0,0,0,0.15)"};
  const hasAction=(tab==="train"&&!isLocked("train")&&trainView==="exercises"&&curDay&&!histDayLog)||(tab==="food"&&!isLocked("food")&&foodMode==="macro")||(tab==="weight"&&!isLocked("weight"))||isLocked(tab);
  const footerH=hasAction?112:56;
  const locked=isLocked(tab);
  const LK={bg:"#002d5a",hdr:"rgba(0,38,76,0.95)",abg:"rgba(0,38,76,0.96)"};
  
  return <div style={{minHeight:"100vh",background:locked?LK.bg:isCheckin?CI.bg:isFood?foodBg:isWeight?W.bg:T.bg,color:locked?"#fff":isCheckin?CI.text:isFood?foodText:isWeight?W.text:T.t,fontFamily:T.f,transition:"background .3s ease, color .3s ease"}}>
    {/* Header */}
    <div style={{position:"sticky",top:0,zIndex:60,background:locked?LK.hdr:isCheckin?CI.hdr:isFood?foodHdr:isWeight?W.hdr:"rgba(26,26,26,0.92)",backdropFilter:"blur(20px)",borderBottom:"1px solid "+(locked||isCheckin?"rgba(255,255,255,0.12)":isFood?"rgba(180,150,100,0.2)":isWeight?W.brd:T.brd),padding:"9px 16px",display:"flex",justifyContent:"space-between",alignItems:"center",transition:"all .3s ease"}}>
      <div style={{display:"flex",alignItems:"center",gap:10}}>
        <div style={{fontSize:17,fontWeight:800,letterSpacing:-1}}><span style={{color:locked||isCheckin?"#ffcc00":isFood?"#b8860b":isWeight?W.acc:T.acc}}>FIT</span><span style={{color:locked||isCheckin?"rgba(255,255,255,0.4)":isFood?"#9a8b78":isWeight?W.mut:T.dim}}>BY</span><span style={{color:locked||isCheckin?"#fff":isFood?foodText:isWeight?W.text:T.t}}>YOU</span></div>
      </div>
      <div style={{display:"flex",alignItems:"center",gap:8}}>
        <span style={{fontSize:10,color:locked||isCheckin?"rgba(255,255,255,0.4)":isFood?"#9a8b78":isWeight?W.mut:T.dim}}>V{c.wkC}/{c.wkT}</span>
        <Pfp name={c.name} gender={c.gender} size={28}/>
      </div>
    </div>
    
    {/* Content */}
    <div style={{maxWidth:420,margin:"0 auto",padding:`16px 16px ${footerH+16}px`,opacity:tabFade?0:1,...(tabFade?{transform:"translateY(8px)"}:{}),transition:"opacity .12s ease, transform .12s ease"}}>
      
      {/* === TR√ÑNING === */}
      {tab==="train"&&isLocked("train")&&<LockedTab type="train"/>}
      {tab==="train"&&!isLocked("train")&&trainView==="days"&&(()=>{
        const wLogs=c.weeklyLogs||[];
        const isHistory=trainHistWeek!==null;
        const histWeek=isHistory?wLogs.find(w=>w.week===trainHistWeek):null;
        
        // Build day data ‚Äî current or historical
        const daySource=isHistory&&histWeek?histWeek.days.map((d,i)=>{
          const p=prog[i];
          const muscles=[...new Set((p?.ex||[]).map(e=>e.m).filter(Boolean))];
          const tgtSets=(p?.ex||[]).reduce((s,e)=>s+(e.s||3),0);
          const doneSets=d.exercises.reduce((s,e)=>s+(e.sets||[]).filter(ss=>ss.reps>0).length,0);
          return {d:{name:d.name,exercises:d.exercises.map(e=>({n:e.n,sets:(e.sets||[]).map(s=>({kg:s.kg,reps:s.reps}))}))},i,muscles,tgtSets,doneSets,allDone:doneSets>=tgtSets&&tgtSets>0,pct:tgtSets>0?Math.round((doneSets/tgtSets)*100):0,hist:true};
        }):trainLog.map((d,i)=>{
          const p=prog[i];
          const muscles=[...new Set((p?.ex||[]).map(e=>e.m).filter(Boolean))];
          const tgtSets=(p?.ex||[]).reduce((s,e)=>s+(e.s||3),0);
          const doneSets=d.exercises.reduce((s,e)=>s+e.sets.filter(ss=>ss.reps>0).length,0);
          const allDone=doneSets>=tgtSets&&tgtSets>0;
          const pct=tgtSets>0?Math.round((doneSets/tgtSets)*100):0;
          return {d,i,muscles,tgtSets,doneSets,allDone,pct};
        });
        const active=daySource.filter(x=>!x.allDone);
        const done=daySource.filter(x=>x.allDone);
        
        // Icon + gradient per primary muscle
        const dayVisual=(muscles)=>{
          const m=muscles[0]||"";
          const map={
            "Brost":{icon:"üèãÔ∏è",grad:"linear-gradient(135deg,#ef4444,#b91c1c)"},
            "Rygg":{icon:"üßó",grad:"linear-gradient(135deg,#3b82f6,#1d4ed8)"},
            "Axlar":{icon:"üí™",grad:"linear-gradient(135deg,#f59e0b,#d97706)"},
            "Ben":{icon:"ü¶µ",grad:"linear-gradient(135deg,#22c55e,#15803d)"},
            "Biceps":{icon:"üí™",grad:"linear-gradient(135deg,#8b5cf6,#6d28d9)"},
            "Triceps":{icon:"üí™",grad:"linear-gradient(135deg,#ec4899,#be185d)"},
            "Mage":{icon:"üî•",grad:"linear-gradient(135deg,#06b6d4,#0e7490)"}
          };
          if(muscles.length>2)return {icon:"‚ö°",grad:"linear-gradient(135deg,#fff,#ccc)"};
          return map[m]||{icon:"üèãÔ∏è",grad:"linear-gradient(135deg,#6b7280,#374151)"};
        };
        
        const DayRow=({x,dim})=>{
          const vis=dayVisual(x.muscles);
          const isHist=!!x.hist;
          return <div key={x.i} onClick={()=>{
            if(isHist){
              // Open read-only exercise view with historical data
              const histExercises=x.d.exercises.map(e=>({n:e.n,sets:(e.sets||[]).map(s=>({kg:s.kg||0,reps:s.reps||0}))}));
              setHistDayLog({name:x.d.name,exercises:histExercises,week:trainHistWeek});
              setTrainDay(x.i);
              setTrainView("exercises");
            } else {
              setHistDayLog(null);
              setTrainDay(x.i);
              setTrainView("exercises");
            }
          }} style={{padding:"14px 16px",background:dim?"rgba(255,255,255,0.015)":"rgba(255,255,255,0.025)",border:"1px solid "+(dim?"rgba(255,255,255,0.04)":x.allDone?"rgba(255,255,255,0.08)":"rgba(255,255,255,0.06)"),borderRadius:14,marginBottom:8,cursor:"pointer",transition:"all .15s",opacity:dim?0.45:1}} onMouseEnter={e=>{if(!dim){e.currentTarget.style.borderColor=T.acc;e.currentTarget.style.background="rgba(255,255,255,0.04)"}}} onMouseLeave={e=>{e.currentTarget.style.borderColor=dim?"rgba(255,255,255,0.04)":x.allDone?"rgba(255,255,255,0.08)":"rgba(255,255,255,0.06)";e.currentTarget.style.background=dim?"rgba(255,255,255,0.015)":"rgba(255,255,255,0.025)"}}>
            <div style={{display:"flex",gap:14,alignItems:"center"}}>
              <div style={{width:56,height:56,borderRadius:12,background:dim?"rgba(255,255,255,0.04)":vis.grad,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,boxShadow:dim?"none":"0 2px 8px rgba(0,0,0,0.2)"}}>
                <span style={{fontSize:26,filter:dim?"grayscale(1)":"none"}}>{vis.icon}</span>
              </div>
              <div style={{flex:1,minWidth:0}}>
                <div style={{fontSize:15,fontWeight:700,textDecoration:dim?"line-through":"none"}}>{x.d.name}</div>
                {x.muscles.length>0&&<div style={{display:"flex",gap:4,flexWrap:"wrap",marginTop:4}}>
                  {x.muscles.map(m=><span key={m} style={{fontSize:9,padding:"2px 6px",borderRadius:8,background:(MC[m]||T.dim)+"15",color:MC[m]||T.dim,fontWeight:600}}>{m}</span>)}
                </div>}
                {/* History: compact progress bar */}
                {isHist&&<div style={{marginTop:6,display:"flex",alignItems:"center",gap:8}}>
                  <div style={{flex:1,height:4,borderRadius:2,background:"rgba(255,255,255,0.06)",overflow:"hidden"}}>
                    <div style={{width:(x.tgtSets>0?(x.doneSets/x.tgtSets)*100:0)+"%",height:"100%",borderRadius:2,background:x.allDone?T.grn:T.acc,transition:"width .3s"}}/>
                  </div>
                  <span style={{fontSize:9,color:x.allDone?T.grn:T.mut,fontWeight:700,fontFamily:T.mono,flexShrink:0}}>{x.doneSets}/{x.tgtSets}</span>
                </div>}
              </div>
              {!isHist&&x.allDone&&<span style={{fontSize:16,flexShrink:0}}>‚úì</span>}
            </div>
          </div>;
        };
        
        return <div>
          {/* Pyramid header */}
          <SectionHeader 
            title="Dina tr√§ningspass" 
            accent={T.acc}
            dimColor={T.mut}
            brdColor={T.brd}
          />
          
          {/* Week progress ‚Äî same level as DayTabs in other tabs */}
          <WeekProgress
            weekCurrent={c.wkC}
            weekTotal={c.wkT}
            onWeekClick={wLogs.length>0?(wk)=>setTrainHistWeek(wk):null}
            activeWeek={trainHistWeek}
            accent={T.acc}
            dimColor={T.mut}
            brdColor={T.brd}
          />
          
          {/* History mode indicator */}
          {isHistory&&<div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:8,marginBottom:14}}>
            <span style={{fontSize:10,color:T.mut}}>Historik ‚Äî skrivskyddad</span>
            <button onClick={()=>setTrainHistWeek(null)} style={{padding:"3px 10px",borderRadius:6,border:"1px solid "+T.brd,background:"rgba(255,255,255,0.04)",color:T.acc,fontSize:10,fontWeight:700,cursor:"pointer",fontFamily:T.f}}>√ó Tillbaka</button>
          </div>}
          
          {/* Day cards */}
          {isHistory?daySource.map(x=><DayRow key={x.i} x={x}/>):<>
            {active.map(x=><DayRow key={x.i} x={x}/>)}
            {done.length>0&&<>
              <div onClick={()=>setShowDoneDays(p=>!p)} style={{display:"flex",alignItems:"center",gap:8,padding:"10px 0",margin:"8px 0 4px",cursor:"pointer",borderTop:"1px solid rgba(255,255,255,0.06)"}}>
                <span style={{fontSize:10,color:T.mut}}>{showDoneDays?"‚ñæ":"‚ñ∏"}</span>
                <span style={{fontSize:11,color:T.grn,fontWeight:700}}>‚úì Avklarade</span>
                <span style={{fontSize:10,color:T.mut}}>{done.length} pass</span>
                <div style={{flex:1,height:1,background:"rgba(255,255,255,0.06)"}}/>
              </div>
              {showDoneDays&&done.map(x=><DayRow key={x.i} x={x} dim/>)}
            </>}
          </>}
          
          
        </div>;
      })()}
      
      {/* Day exercise list + Starta pass */}
      {tab==="train"&&!isLocked("train")&&trainView==="exercises"&&(curDay||histDayLog)&&<div>
        {(()=>{
          const isHist=!!histDayLog;
          const viewDay=isHist?histDayLog:curDay;
          const viewProg=curProg;
          return <>
            <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:isHist?8:16}}>
              <button onClick={()=>{setTrainView("days");if(isHist)setHistDayLog(null)}} style={{background:"none",border:"none",color:T.dim,cursor:"pointer",fontSize:18,padding:0}}>‚Üê</button>
              <div style={{fontSize:16,fontWeight:800,flex:1}}>{viewDay.name}</div>
            </div>
            {isHist&&<div style={{display:"flex",alignItems:"center",gap:6,padding:"8px 12px",background:"rgba(255,255,255,0.03)",border:"1px solid "+T.brd,borderRadius:8,marginBottom:14,fontSize:10,color:T.mut}}>
              <span>üìã</span>
              <span>Vecka {histDayLog.week} ‚Äî skrivskyddad logg</span>
            </div>}
        
            {/* Exercise list */}
            {viewDay.exercises.map((ex,eI)=>{
              const p=viewProg?.ex[eI];
              const tgt=p?.s||3;
              const done=ex.sets.filter(s=>s.reps>0).length;
              const complete=done>=tgt;
              const mCol=MC[p?.m]||T.dim;
              const exD=EX_DATA[ex.n];
              const exIcon={"Brost":"üèãÔ∏è","Rygg":"üßó","Axlar":"üèãÔ∏è","Ben":"ü¶µ","Biceps":"üí™","Triceps":"üí™","Mage":"üî•"}[p?.m]||"üèãÔ∏è";
              const exImg=EX_IMG[ex.n];
              const exCrop=EX_CROP[ex.n]||"center";
              return <div key={eI} style={{padding:"10px",background:eI%2?ZB[1]:ZB[0],border:"1px solid "+(complete?"rgba(255,255,255,0.08)":"rgba(255,255,255,0.04)"),borderRadius:18,marginBottom:10,transition:"all .15s"}}>
                <div style={{display:"flex",alignItems:"center",gap:14}}>
                  <div onClick={()=>setExPopup(ex.n)} style={{width:88,height:88,borderRadius:14,background:exImg?"#222":(complete?"rgba(255,255,255,0.06)":`linear-gradient(135deg,${mCol}25,${mCol}08)`),display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,border:"1px solid "+(complete?"rgba(255,255,255,0.06)":mCol+"20"),cursor:"pointer",overflow:"hidden"}}>
                    {exImg?<img src={exImg} alt={ex.n} style={{width:"100%",height:"100%",objectFit:"cover",objectPosition:exCrop,opacity:complete?0.3:1}} onError={e=>{e.target.style.display="none";e.target.parentNode.style.background=`linear-gradient(135deg,${mCol}25,${mCol}08)`;const s=document.createElement("span");s.textContent=complete?"‚úì":exIcon;s.style.fontSize="32px";s.style.opacity=complete?"0.3":"0.7";e.target.parentNode.appendChild(s)}}/>
                    :<span style={{fontSize:32,opacity:complete?0.3:0.7}}>{complete?"‚úì":exIcon}</span>}
                  </div>
                  <div style={{flex:1,minWidth:0}}>
                    <div style={{fontSize:16,fontWeight:800,color:complete?T.dim:T.t,textDecoration:complete?"line-through":"none"}}>{ex.n}</div>
                    {done>0&&<div style={{fontSize:11,color:T.dim,marginTop:3}}>{done}/{tgt} set klart</div>}
                  </div>
                  <span style={{fontSize:9,padding:"4px 10px",borderRadius:8,fontWeight:700,flexShrink:0,letterSpacing:0.5,background:mCol+"15",color:mCol,border:"1px solid "+mCol+"25"}}>{p?.m||""}</span>
                </div>
                {done>0&&<div style={{marginTop:10,display:"flex",flexDirection:"column",gap:4}}>
                  {ex.sets.map((s,sI)=>s.reps>0?<div key={sI} style={{display:"flex",alignItems:"center",gap:10,padding:"5px 10px",background:"rgba(255,255,255,0.025)",borderRadius:6,fontSize:12}}>
                    <span style={{color:T.mut,minWidth:40,fontSize:10,fontWeight:600}}>Set {sI+1}</span>
                    <span style={{fontWeight:700}}>{s.kg}kg</span>
                    <span style={{color:T.mut}}>√ó</span>
                    <span style={{fontWeight:700,color:T.dim}}>{s.reps}</span>
                  </div>:null)}
                </div>}
              </div>;
            })}
          </>;
        })()}
      </div>}
      
      {/* === WORKOUT MODE ‚Äî fullscreen === */}
      {tab==="train"&&!isLocked("train")&&trainView==="workout"&&curProg&&(()=>{
        const ex=curProg.ex[wkExIdx];
        const dex=curDay?.exercises[wkExIdx];
        if(!ex||!dex)return null;
        const{positions,pct}=getProgress();
        const isOdd=wkExIdx%2===1;
        const muscleCol=MC[ex.m]||T.dim;
        const accent=muscleCol;
        const accentBg=muscleCol+"18";
        
        return <div style={{position:"fixed",top:0,left:0,right:0,bottom:56,zIndex:80,background:T.bg,display:"flex",flexDirection:"column",overflow:"hidden"}}>
          {/* Countdown overlay */}
          {wkCountdown>0&&<div style={{position:"absolute",inset:0,zIndex:10,background:T.bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:16}}>
            <div style={{fontSize:13,fontWeight:700,color:T.mut,textTransform:"uppercase",letterSpacing:2}}>Gl√∂m inte att v√§rma upp</div>
            <div style={{position:"relative",width:120,height:120,display:"flex",alignItems:"center",justifyContent:"center"}}>
              <svg width={120} height={120} style={{position:"absolute",transform:"rotate(-90deg)"}}>
                <circle cx={60} cy={60} r={54} fill="none" stroke="rgba(255,255,255,0.06)" strokeWidth={4}/>
                <circle cx={60} cy={60} r={54} fill="none" stroke={accent} strokeWidth={4} strokeLinecap="round"
                  strokeDasharray={339.3} strokeDashoffset={339.3*(1-wkCountdown/3)}
                  style={{transition:"stroke-dashoffset .7s ease"}}/>
              </svg>
              <span key={wkCountdown} style={{fontSize:56,fontWeight:800,color:"#fff",animation:"countPop .4s ease"}}>{wkCountdown}</span>
            </div>
            <div style={{fontSize:15,fontWeight:700,color:accent}}>{ex.n}</div>
            <div style={{fontSize:11,color:T.mut}}>Set {wkSetIdx+1} av {ex.s||3}</div>
            <style>{`@keyframes countPop{0%{transform:scale(1.4);opacity:0.3}100%{transform:scale(1);opacity:1}}`}</style>
          </div>}
          {/* Exercise transition interstitial */}
          {wkStep==="exTransition"&&exTransition&&<div style={{position:"absolute",inset:0,zIndex:10,background:T.bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:0}}>
            {/* Step indicator line */}
            <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:32}}>
              {curProg.ex.map((_,i)=><div key={i} style={{width:i===exTransition.exNum-1?24:16,height:3,borderRadius:2,background:i<exTransition.exNum?(MC[curProg.ex[i]?.m]||T.acc):T.brd,transition:"all .3s",opacity:i===exTransition.exNum-1?1:0.5}}/>)}
            </div>
            {/* Icon with muscle color ring */}
            <div style={{position:"relative",marginBottom:20}}>
              <div style={{width:88,height:88,borderRadius:"50%",background:(MC[exTransition.muscle]||T.acc)+"15",display:"flex",alignItems:"center",justifyContent:"center",border:"2px solid "+(MC[exTransition.muscle]||T.acc)+"40",animation:"exIconIn .5s ease"}}>
                <span style={{fontSize:40}}>{exTransition.icon}</span>
              </div>
            </div>
            {/* Exercise name */}
            <div style={{fontSize:11,color:T.mut,textTransform:"uppercase",letterSpacing:3,fontWeight:700,marginBottom:6,animation:"fadeUp .4s ease .1s both"}}>N√§sta √∂vning</div>
            <div style={{fontSize:24,fontWeight:800,color:"#fff",letterSpacing:-0.5,animation:"fadeUp .4s ease .2s both"}}>{exTransition.name}</div>
            {/* Muscle tag */}
            <div style={{marginTop:10,animation:"fadeUp .4s ease .3s both"}}>
              <span style={{fontSize:10,padding:"4px 12px",borderRadius:20,background:(MC[exTransition.muscle]||T.acc)+"15",color:MC[exTransition.muscle]||T.acc,fontWeight:700}}>{exTransition.muscle}</span>
            </div>
            {/* Sets info */}
            <div style={{fontSize:13,color:T.dim,marginTop:16,animation:"fadeUp .4s ease .4s both"}}>{exTransition.setOf} set</div>
            {/* Loading bar */}
            <div style={{width:120,height:3,borderRadius:2,background:T.brd,marginTop:24,overflow:"hidden",animation:"fadeUp .3s ease .3s both"}}>
              <div style={{height:"100%",borderRadius:2,background:MC[exTransition.muscle]||T.acc,animation:"exBarFill 1.5s linear forwards"}}/>
            </div>
            <style>{`
              @keyframes exIconIn{0%{transform:scale(0.5);opacity:0}50%{transform:scale(1.1)}100%{transform:scale(1);opacity:1}}
              @keyframes exBarFill{0%{width:0%}100%{width:100%}}
            `}</style>
          </div>}
          {/* Workout complete summary */}
          {wkDone&&<div style={{position:"absolute",inset:0,zIndex:11,background:T.bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:12,overflow:"hidden"}}>
            {/* Confetti dots */}
            {[...Array(12)].map((_,i)=><div key={i} style={{position:"absolute",width:6,height:6,borderRadius:"50%",background:[accent,"#fff",T.dim,accent+"80"][i%4],top:`${10+Math.random()*80}%`,left:`${5+Math.random()*90}%`,animation:`confettiFall ${1+Math.random()*1.5}s ease ${i*0.1}s both`,opacity:0}}/>)}
            <div style={{fontSize:56,animation:"flashPop .5s ease"}}>üèÜ</div>
            <div style={{fontSize:24,fontWeight:800,color:"#fff",letterSpacing:-0.5,animation:"fadeUp .4s ease .2s both"}}>Pass klart!</div>
            <div style={{fontSize:13,color:T.dim,animation:"fadeUp .4s ease .3s both"}}>{wkDone.day}</div>
            <div style={{display:"flex",gap:32,marginTop:12}}>
              <div style={{textAlign:"center",animation:"fadeUp .4s ease .5s both"}}>
                <div style={{fontSize:32,fontWeight:800,color:accent}}>{wkDone.exercises}</div>
                <div style={{fontSize:10,color:T.mut,textTransform:"uppercase",letterSpacing:1}}>√∂vningar</div>
              </div>
              <div style={{width:1,background:T.brd,alignSelf:"stretch"}}/>
              <div style={{textAlign:"center",animation:"fadeUp .4s ease .65s both"}}>
                <div style={{fontSize:32,fontWeight:800,color:accent}}>{wkDone.sets}</div>
                <div style={{fontSize:10,color:T.mut,textTransform:"uppercase",letterSpacing:1}}>set</div>
              </div>
            </div>
            <button onClick={()=>{setWkDone(null);setTrainView("exercises");clearInterval(restRef.current);setRestSec(0)}} style={{marginTop:24,padding:"14px 40px",background:T.acc,border:"none",borderRadius:14,color:"#1a1a1a",fontSize:15,fontWeight:800,cursor:"pointer",letterSpacing:0.5,textTransform:"uppercase",animation:"fadeUp .4s ease .9s both"}}>St√§ng</button>
          </div>}
          <style>{`
            @keyframes flashPop{0%{transform:scale(0.5);opacity:0}60%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}
            @keyframes fadeUp{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
            @keyframes confettiFall{0%{opacity:0;transform:translateY(-30px) scale(0)}20%{opacity:1;transform:translateY(0) scale(1.3)}80%{opacity:.6}100%{opacity:0;transform:translateY(50px) scale(0)}}
          `}</style>
          {/* Header */}
          <div style={{padding:"12px 16px",background:"rgba(255,255,255,0.02)",borderBottom:"1px solid "+T.brd,flexShrink:0}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8}}>
              {canGoPrev?<button onClick={goPrevSet} style={{padding:"6px 10px",background:"rgba(255,255,255,0.04)",border:"1px solid "+T.brd,borderRadius:8,color:T.mut,fontSize:12,cursor:"pointer",fontFamily:T.f}}>‚Üê</button>:<button onClick={()=>{setTrainView("exercises");clearInterval(restRef.current);setRestSec(0)}} style={{padding:"6px 10px",background:"rgba(255,255,255,0.04)",border:"1px solid "+T.brd,borderRadius:8,color:T.mut,fontSize:12,cursor:"pointer",fontFamily:T.f}}>‚úï</button>}
              <span style={{fontSize:11,color:T.mut}}>SET {wkSetIdx+1} av {ex.s||3}</span>
              {canGoNext?<button onClick={goNextSet} style={{padding:"6px 10px",background:"rgba(255,255,255,0.04)",border:"1px solid "+T.brd,borderRadius:8,color:T.mut,fontSize:12,cursor:"pointer",fontFamily:T.f}}>‚Üí</button>:<button onClick={()=>{setTrainView("exercises");clearInterval(restRef.current);setRestSec(0)}} style={{padding:"6px 10px",background:"rgba(255,255,255,0.04)",border:"1px solid "+T.brd,borderRadius:8,color:T.mut,fontSize:12,cursor:"pointer",fontFamily:T.f}}>‚úï</button>}
            </div>
            {/* Progress bar */}
            <div style={{position:"relative",height:20,margin:"0 4px"}}>
              <div style={{position:"absolute",top:"50%",left:0,right:0,height:4,transform:"translateY(-50%)",background:"rgba(255,255,255,0.06)",borderRadius:2}}/>
              <div style={{position:"absolute",top:"50%",left:0,height:4,transform:"translateY(-50%)",background:accent,borderRadius:2,width:pct+"%",transition:"width .4s ease"}}/>
              {positions.map((p,i)=>{
                const sz=p.isExStart?(p.isCur?14:10):(p.isCur?8:5);
                const bg=p.complete?accent:p.isCur?accentBg:"rgba(255,255,255,0.06)";
                const brd=p.complete?accent:p.isCur?accent:T.brd;
                return <div key={i} style={{position:"absolute",left:p.pct+"%",top:"50%",transform:"translate(-50%,-50%)",zIndex:2}}>
                  <div style={{width:sz,height:sz,borderRadius:"50%",background:bg,border:(p.isExStart?"2px":"1px")+" solid "+brd,...(p.isCur?{boxShadow:`0 0 0 3px ${accentBg}`}:{})}}/>
                </div>;
              })}
            </div>
          </div>
          
          {/* Main content area */}
          <div style={{flex:1,minHeight:0,display:"flex",flexDirection:"column",alignItems:"center",padding:"1rem 1rem",overflowY:"auto",WebkitOverflowScrolling:"touch"}}>
            {wkStep==="perform"&&<div style={{margin:"auto 0",display:"flex",flexDirection:"column",alignItems:"center",paddingTop:16}}>
              {/* Exercise name ‚Äî tappable for info popup */}
              <button onClick={()=>setExPopup(ex.n)} style={{background:"none",border:"none",fontSize:21,fontWeight:800,color:accent,textTransform:"uppercase",cursor:"pointer",display:"inline-flex",alignItems:"center",gap:8,fontFamily:T.f,padding:0,marginBottom:28,WebkitTapHighlightColor:"transparent"}}>
                {ex.n}
                <span style={{width:22,height:22,borderRadius:"50%",background:accent+"20",color:accent,fontSize:11,fontWeight:600,display:"flex",alignItems:"center",justifyContent:"center"}}>?</span>
              </button>
              <div style={{fontSize:13,color:T.mut,textTransform:"uppercase",letterSpacing:2,marginBottom:10}}>G√∂r</div>
              <div style={{display:"flex",alignItems:"center",justifyContent:"center",gap:8}}>
                <div style={{fontSize:84,fontWeight:800,color:accent,lineHeight:1}}>{ex.r}</div>
              </div>
              <div style={{fontSize:15,color:T.mut,textTransform:"uppercase",letterSpacing:2,marginTop:10}}>Reps</div>
            </div>}
            
            {wkStep==="log"&&<div style={{margin:"auto 0",display:"flex",flexDirection:"column",alignItems:"center",width:"100%",paddingTop:4}}>
              <div style={{fontSize:12,color:T.mut,marginBottom:6}}>Vad lyfte du?</div>
              <div style={{display:"flex",justifyContent:"center",alignItems:"flex-start",gap:10,marginBottom:4}}>
                {/* KG wheel + decimal */}
                <div style={{textAlign:"center"}}>
                  <div style={{fontSize:9,color:accent,textTransform:"uppercase",letterSpacing:1,marginBottom:4,fontWeight:700}}>Vikt</div>
                  <div style={{display:"flex",alignItems:"center"}}>
                    <FitLogWheel items={WHEEL_KG} value={wkKg} onChange={setWkKg} color={accent} width={100} itemH={44} visCount={3}/>
                    {showDec&&<FitLogWheel items={WHEEL_DECIMALS} labels={WHEEL_DEC_LABELS} value={wkDec} onChange={setWkDec} color={accent} width={68} itemH={44} visCount={3}/>}
                  </div>
                </div>
                {/* Reps wheel */}
                <div style={{textAlign:"center"}}>
                  <div style={{fontSize:9,color:accent,textTransform:"uppercase",letterSpacing:1,marginBottom:4,fontWeight:700}}>Reps</div>
                  <FitLogWheel items={WHEEL_REPS} value={wkReps} onChange={setWkReps} color={accent} width={85} itemH={44} visCount={3}/>
                </div>
              </div>
              <button onClick={()=>{if(!showDec){setWkDec(0.5);setShowDec(true)}else{setWkDec(0);setShowDec(false)}}} style={{background:"none",border:"none",color:T.mut,fontSize:11,cursor:"pointer",marginBottom:4,textDecoration:"underline",fontFamily:T.f}}>{showDec?"D√∂lj decimaler":"Visa decimaler"}</button>
              <div style={{fontSize:22,fontWeight:700,color:accent}}>{wkKg+wkDec} kg √ó {wkReps} reps</div>
            </div>}
            
            {wkStep==="rest"&&(()=>{
              const R=90,C=2*Math.PI*R;
              const pct=restTotal>0?restSec/restTotal:0;
              const offset=C*(1-pct);
              const urgent=pct<0.2;
              const ringColor=urgent?T.red:accent;
              return <>
                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:24}}>
                  <div style={{fontSize:13,color:T.mut,textTransform:"uppercase",letterSpacing:2}}>Vila</div>
                  <button onClick={()=>setInfoModal("rest")} style={{width:22,height:22,background:"rgba(255,255,255,0.04)",border:"1px solid "+T.brd,borderRadius:"50%",color:T.mut,fontSize:10,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}}>?</button>
                </div>
                <div style={{position:"relative",width:220,height:220}}>
                  <svg width={220} height={220} style={{transform:"rotate(-90deg)"}}>
                    {/* Background ring */}
                    <circle cx={110} cy={110} r={R} fill="none" stroke="rgba(255,255,255,0.06)" strokeWidth={8}/>
                    {/* Progress ring */}
                    <circle cx={110} cy={110} r={R} fill="none" stroke={ringColor} strokeWidth={8} strokeLinecap="round" strokeDasharray={C} strokeDashoffset={offset} style={{transition:"stroke-dashoffset 1s linear, stroke 0.3s"}}/>
                  </svg>
                  {/* Time in center */}
                  <div style={{position:"absolute",inset:0,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center"}}>
                    <div style={{fontSize:56,fontWeight:800,color:urgent?T.red:T.t,fontVariantNumeric:"tabular-nums",lineHeight:1,fontFamily:T.mono,transition:"color .3s"}}>{fmtTime(restSec)}</div>
                  </div>
                </div>
                {(()=>{
                  const isLastSetOfEx=wkSetIdx+1>=(ex.s||3);
                  const nextExName=isLastSetOfEx&&wkExIdx+1<curProg.ex.length?curProg.ex[wkExIdx+1].n:null;
                  const nextMuscle=isLastSetOfEx&&wkExIdx+1<curProg.ex.length?curProg.ex[wkExIdx+1].m:null;
                  return nextExName?
                    <div style={{marginTop:20,display:"flex",flexDirection:"column",alignItems:"center",gap:4}}>
                      <div style={{fontSize:10,color:T.mut,textTransform:"uppercase",letterSpacing:2}}>N√§sta √∂vning</div>
                      <div style={{fontSize:14,fontWeight:700,color:MC[nextMuscle]||T.dim}}>{nextExName}</div>
                    </div>
                    :<div style={{fontSize:12,color:T.mut,marginTop:20}}>N√§sta: Set {wkSetIdx+2} av {ex.s||3}</div>;
                })()}
              </>;
            })()}
          </div>
          
          {/* Bottom button */}
          <div style={{padding:"16px",flexShrink:0}}>
            {wkStep==="perform"&&<button onClick={()=>{
              // Default from previous set in same exercise, or previous week
              const dex=curDay?.exercises[wkExIdx];
              let defKg=0,defReps=parseInt(String(ex.r).split("-").pop())||10;
              // Check previous set in current exercise
              if(wkSetIdx>0&&dex?.sets[wkSetIdx-1]?.reps>0){
                defKg=dex.sets[wkSetIdx-1].kg;
                defReps=dex.sets[wkSetIdx-1].reps||defReps;
              } else if(wkSetIdx===0){
                // First set ‚Äî check if any logged set exists in this exercise (from earlier)
                const lastLogged=dex?.sets?.filter(s=>s.reps>0).pop();
                if(lastLogged){defKg=lastLogged.kg;defReps=lastLogged.reps||defReps;}
              }
              // Snap kg to nearest WHEEL_KG value, set decimal
              const wholeKg=Math.floor(defKg);
              const decPart=defKg-wholeKg;
              const snapKg=WHEEL_KG.reduce((prev,curr)=>Math.abs(curr-wholeKg)<Math.abs(prev-wholeKg)?curr:prev,0);
              const snapDec=decPart>0.1?WHEEL_DECIMALS.reduce((prev,curr)=>Math.abs(curr-decPart)<Math.abs(prev-decPart)?curr:prev,0.5):0;
              setWkKg(snapKg);setWkDec(snapDec);setShowDec(snapDec>0);setWkReps(defReps);setWkStep("log");
            }} style={{width:"100%",padding:"16px",background:T.acc,border:"none",borderRadius:14,color:"#1a1a1a",fontSize:15,fontWeight:800,cursor:"pointer",letterSpacing:0.5,textTransform:"uppercase"}}>‚úì Klar ‚Äì logga</button>}
            {wkStep==="log"&&<button onClick={()=>{if(wkReps>0)logCurrentSet()}} style={{width:"100%",padding:"16px",background:wkReps>0?accent:"rgba(255,255,255,0.06)",border:"none",borderRadius:14,color:wkReps>0?"#fff":T.mut,fontSize:15,fontWeight:800,cursor:"pointer"}}>Spara & vila</button>}
            {wkStep==="rest"&&<button onClick={()=>{clearInterval(restRef.current);setRestSec(0)}} style={{width:"100%",padding:"16px",background:"rgba(255,255,255,0.04)",border:"1px solid "+T.brd,borderRadius:14,color:T.mut,fontSize:15,fontWeight:600,cursor:"pointer"}}>Hoppa √∂ver ‚Üí</button>}
          </div>
          
          {/* Info modal */}
          {infoModal&&<div onClick={()=>setInfoModal(null)} style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.85)",zIndex:90,display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
            <div onClick={e=>e.stopPropagation()} style={{background:"#1a1a1a",border:"1px solid "+T.brd,borderRadius:16,padding:24,maxWidth:350,width:"100%"}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:16}}>
                <div style={{fontSize:15,fontWeight:700,color:accent}}>{infoModal==="perform"?"Att t√§nka p√•!":"Vilotider"}</div>
                <button onClick={()=>setInfoModal(null)} style={{background:"none",border:"none",color:T.mut,fontSize:20,cursor:"pointer",lineHeight:1}}>√ó</button>
              </div>
              {infoModal==="perform"&&<div style={{display:"flex",flexDirection:"column",gap:14}}>
                <p style={{fontSize:13,color:T.t,lineHeight:1.5,margin:0}}>V√§lj en vikt som √§r tillr√§ckligt tung f√∂r att klara angivet antal repetitioner, men ungef√§r 1‚Äì2 repetitioner ifr√•n failure.</p>
                <p style={{fontSize:13,color:T.t,lineHeight:1.5,margin:0}}>G√∂r n√•gra uppv√§rmningsset om du tr√§nar tungt. Dessa beh√∂ver inte loggas.</p>
                <p style={{fontSize:12,color:T.mut,lineHeight:1.4,margin:0,fontStyle:"italic"}}>V√§rm upp ordentligt innan du b√∂rjar tr√§na.</p>
              </div>}
              {infoModal==="rest"&&<div style={{display:"flex",flexDirection:"column",gap:12}}>
                <p style={{fontSize:13,color:T.t,lineHeight:1.5,margin:0}}>Vilotiden baseras p√• antalet reps i √∂vningen:</p>
                <div style={{display:"flex",flexDirection:"column",gap:6}}>
                  {[["1‚Äì4 reps","5:00"],["5‚Äì6 reps","3:00"],["7‚Äì8 reps","2:30"],["9‚Äì10 reps","1:30"],["11‚Äì12 reps","1:00"],["13+ reps","0:45"]].map(([r,t])=><div key={r} style={{display:"flex",justifyContent:"space-between",padding:"6px 10px",background:"rgba(255,255,255,0.02)",borderRadius:6,fontSize:12}}>
                    <span style={{color:T.dim}}>{r}</span>
                    <span style={{fontWeight:700,fontFamily:T.mono,color:accent}}>{t}</span>
                  </div>)}
                </div>
                <p style={{fontSize:11,color:T.mut,margin:0,fontStyle:"italic"}}>Det h√§r √§r bara riktlinjer ‚Äî lyssna alltid p√• kroppen i f√∂rsta hand!</p>
              </div>}
              <button onClick={()=>setInfoModal(null)} style={{width:"100%",marginTop:20,padding:"12px",background:T.acc,border:"none",borderRadius:10,color:"#1a1a1a",fontSize:13,fontWeight:700,cursor:"pointer",letterSpacing:0.3}}>F√∂rst√•tt</button>
            </div>
          </div>}
        </div>;
      })()}
      
      {/* === KOST === (warm light palette throughout) */}
      {tab==="food"&&isLocked("food")&&<LockedTab type="food"/>}
      {tab==="food"&&isSolo&&(!c.mealPlan||c.mealPlan.length===0)&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",minHeight:"50vh",textAlign:"center",padding:"0 24px"}}>
        <div style={{fontSize:52,marginBottom:20}}>üçΩÔ∏è</div>
        <div style={{fontSize:22,fontWeight:800,color:"#2c2418",marginBottom:8}}>Kostschema</div>
        <div style={{fontSize:13,color:"#7a6652",lineHeight:1.6,maxWidth:280,marginBottom:28}}>Fyll i lite mer om dig s√• genererar vi ett personligt kostschema med recept och ink√∂pslista.</div>
        <button onClick={()=>{/* TODO: continue onboarding */}} style={{padding:"16px 32px",background:"#2c2418",border:"none",borderRadius:14,color:"#f5efe4",fontSize:15,fontWeight:800,cursor:"pointer",fontFamily:T.f,letterSpacing:0.3}}>L√•s upp kost ‚Üí</button>
        <div style={{fontSize:10,color:"#9a8b78",marginTop:12}}>Tar 30 sekunder</div>
      </div>}
      {tab==="food"&&!isLocked("food")&&!(isSolo&&(!c.mealPlan||c.mealPlan.length===0))&&(()=>{
        const F={
          warm:"#b8860b",cream:"#2c2418",olive:"#5a6e3a",terra:"#a0522d",
          bark:"#7a6652",sage:"#6b8054",sky:"#4a7a9b",
          lineBrd:"rgba(120,90,50,0.2)",
          font:"Georgia, 'Times New Roman', serif",
          pCol:"#4a7a9b",kCol:"#b8860b",fCol:"#a0522d",
          mutCol:"#9a8b78",dimCol:"#5c4f3d"
        };
        const SLOT_STYLE={
          "Frukost":{icon:"‚òÄÔ∏è",col:"#9a7209",brd:"rgba(184,134,11,0.2)"},
          "Lunch":{icon:"üçÉ",col:"#5a6e3a",brd:"rgba(90,110,58,0.2)"},
          "Middag":{icon:"üç∑",col:"#a0522d",brd:"rgba(160,82,45,0.2)"},
          "Mellanm√•l":{icon:"ü•ú",col:"#8a7355",brd:"rgba(138,115,85,0.2)"}
        };
        const dayMeals=c.mealPlan?.[macroDay];
        const dayChecks=mealChecked[macroDay]||[];
        const dayTotal=dayMeals?.meals?.length||0;
        const dayDone=(dayChecks||[]).filter(Boolean).length;
        const progressPct=dayTotal>0?Math.round((dayDone/dayTotal)*100):0;
        
        // shopChecked sync handled by useEffect
        
        
        const toggleMealCheck=(mealIdx)=>{
          const meal=dayMeals?.meals[mealIdx];
          if(!meal)return;
          const wasChecked=(mealChecked[macroDay]||[])[mealIdx];
          if(!wasChecked){
            // Animate first, then move
            setAnimMeal(mealIdx);
            setTimeout(()=>{
              setAnimMeal(null);
              const sign=1;
              setMacroLog(p=>p.map((d,i)=>i===macroDay?{...d,
                p:Math.max(0,(d.p||0)+sign*(meal.p||0)),
                c:Math.max(0,(d.c||0)+sign*(meal.c||0)),
                f:Math.max(0,(d.f||0)+sign*(meal.f||0))
              }:d));
              const newChecked=(mealChecked[macroDay]||[]).length?
                mealChecked[macroDay].map((v,mi)=>mi===mealIdx?true:v):
                (dayMeals?.meals||[]).map((_,mi)=>mi===mealIdx);
              setMealChecked(p=>p.map((dc,di)=>di===macroDay?newChecked:dc));
              // Check if all meals now done ‚Üí celebrate
              const allNowDone=newChecked.length===dayTotal&&newChecked.every(Boolean);
              if(allNowDone&&dayTotal>0){
                const dayKcal=dayMeals.meals.reduce((s,m)=>s+(m.kcal||0),0);
                const tips=[
                  "Regelbundna m√•ltider ger stabilare energi hela dagen.",
                  "Protein i varje m√•ltid hj√§lper muskel√•terh√§mtning.",
                  "Vatten till maten underl√§ttar matsm√§ltningen.",
                  "Bra jobbat! Konsekvent kost ger konsekvent resultat.",
                  "Planerade m√•ltider minskar impulssug markant.",
                  "√Ñt lugnt ‚Äî det tar 20 min innan m√§ttnad kickar in.",
                  "S√∂ndagsmeal prep sparar stress hela veckan."
                ];
                setTimeout(()=>setFoodCelebration({day:DN[macroDay],kcal:dayKcal,tip:tips[macroDay]||tips[0],meals:dayTotal}),300);
              }
            },600);
          } else {
            // Uncheck instantly
            setMacroLog(p=>p.map((d,i)=>i===macroDay?{...d,
              p:Math.max(0,(d.p||0)-1*(meal.p||0)),
              c:Math.max(0,(d.c||0)-1*(meal.c||0)),
              f:Math.max(0,(d.f||0)-1*(meal.f||0))
            }:d));
            setMealChecked(p=>p.map((dc,di)=>di===macroDay?
              dc.length?dc.map((v,mi)=>mi===mealIdx?!v:v):
              (dayMeals?.meals||[]).map((_,mi)=>mi===mealIdx)
            :dc));
          }
        };
        
        const toggleShopCheck=(idx)=>{
          if(!shopChecked[idx]){
            setAnimShop(idx);
            setTimeout(()=>{
              setAnimShop(null);
              setShopChecked(p=>p.map((v,j)=>j===idx?true:v));
            },600);
          } else {
            setShopChecked(p=>p.map((v,j)=>j===idx?false:v));
          }
        };
        
        return <div style={{display:"flex",flexDirection:"column",minHeight:"calc(100vh - 200px)"}}>
        {/* Pyramid header */}
        <SectionHeader 
          title="Ditt kostschema" 
          accent="#b8860b"
          dimColor="#9a8b78"
          brdColor="rgba(180,150,100,0.25)"
        />
        
        {/* DAY TABS ‚Äî unified component */}
        <DayTabs 
          days={DN} 
          active={macroDay} 
          onSelect={(i)=>{setMacroDay(i);setExpandedMeal(null)}}
          checkFn={(i)=>{
            const hasPlan=!!c.mealPlan?.[i];
            return hasPlan&&(mealChecked[i]||[]).length>0&&(mealChecked[i]||[]).every(Boolean)&&mealChecked[i].length===(c.mealPlan[i]?.meals?.length||0);
          }}
          theme={{
            active:F.warm,activeBg:"rgba(184,134,11,0.12)",activeBrd:"rgba(184,134,11,0.5)",
            doneBrd:"rgba(90,110,58,0.35)",doneBg:"rgba(90,110,58,0.1)",doneCol:F.olive,
            defBrd:F.lineBrd,defCol:F.bark,font:F.font,shadow:"none"
          }}
        />
        
        {/* MODE TOGGLE */}
        <div style={{display:"flex",gap:0,marginBottom:14,background:"rgba(255,255,255,0.6)",borderRadius:8,border:"1px solid "+F.lineBrd,overflow:"hidden",alignSelf:"center"}}>
          {[["meals","M√•ltider"],["shop","Handla"],["macro","Makrolog"]].map(([id,label])=>
            <button key={id} onClick={()=>{setFoodMode(id);setExpandedMeal(null)}} style={{padding:"6px 14px",border:"none",borderLeft:id!=="meals"?"1px solid "+F.lineBrd:"none",background:foodMode===id?"rgba(184,134,11,0.15)":"transparent",color:foodMode===id?F.warm:F.mutCol,fontSize:10,fontWeight:700,cursor:"pointer",fontFamily:F.font}}>{label}</button>
          )}
        </div>
        
        {/* ====== M√ÖLTIDER ====== */}
        {foodMode==="meals"&&<div style={{width:"100%"}}>
          {/* Progress bar */}
          <div style={{marginBottom:16}}>
            <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}>
              <span style={{fontSize:10,color:F.mutCol,fontFamily:F.font}}>Dagens m√•ltider</span>
              <span style={{fontSize:11,fontWeight:700,color:progressPct===100?F.olive:F.warm,fontFamily:F.font}}>{dayDone}/{dayTotal}{progressPct===100?" ‚úì":""}</span>
            </div>
            <div style={{height:6,borderRadius:3,background:"rgba(180,150,100,0.18)"}}>
              <div style={{width:progressPct+"%",height:"100%",borderRadius:3,background:"linear-gradient(90deg, #b8860b, #d4a017)",transition:"width .4s ease"}}/>
            </div>
          </div>
          
          {!dayMeals?<div style={{textAlign:"center",color:F.mutCol,fontSize:13,padding:30,fontStyle:"italic",fontFamily:F.font}}>Ingen m√•ltidsplan f√∂r {DN[macroDay]}</div>:<>
          {/* Active meals */}
          {(()=>{
            const active=dayMeals.meals.map((m,i)=>({m,i})).filter(x=>!dayChecks[x.i]);
            const done=dayMeals.meals.map((m,i)=>({m,i})).filter(x=>dayChecks[x.i]);
            
            const MealCard=({m,i,dim})=>{
              const sl=SLOT_STYLE[m.slot]||SLOT_STYLE["Mellanm√•l"];
              const isExpanded=expandedMeal?.day===macroDay&&expandedMeal?.idx===i;
              const isAnim=animMeal===i;
              const imgBg={"Frukost":"linear-gradient(135deg,#f0d68a,#e8c060)","Lunch":"linear-gradient(135deg,#b5c99a,#87a668)","Middag":"linear-gradient(135deg,#d4a07a,#b87a52)","Mellanm√•l":"linear-gradient(135deg,#d4c0a0,#b8a480)"}[m.slot]||"linear-gradient(135deg,#d4c0a0,#b8a480)";
              const imgIcon={"Frukost":"ü•£","Lunch":"ü•ó","Middag":"üç≤","Mellanm√•l":"ü•ú"}[m.slot]||"üçΩÔ∏è";
              return <div key={i} style={{marginBottom:8}}>
                <div className={isAnim?"meal-checking":""} style={{padding:"14px 16px",borderRadius:14,background:dim?"rgba(255,255,255,0.35)":"rgba(255,255,255,0.7)",border:"1px solid "+(isAnim?"rgba(90,110,58,0.4)":sl.brd),boxShadow:dim?"none":"0 1px 4px rgba(120,90,50,0.08)",opacity:dim?0.6:1,transition:"all .3s",cursor:"pointer"}} onClick={()=>!isAnim&&setExpandedMeal(isExpanded?null:{day:macroDay,idx:i})}>
                  <div style={{display:"flex",gap:12,alignItems:"center"}}>
                    <div style={{width:56,height:56,borderRadius:12,background:imgBg,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,boxShadow:"0 1px 3px rgba(0,0,0,0.1)"}}>
                      <span style={{fontSize:26,filter:dim?"grayscale(1)":"none"}}>{imgIcon}</span>
                    </div>
                    <div style={{flex:1,minWidth:0}}>
                      <div style={{fontSize:9,fontWeight:700,color:sl.col,textTransform:"uppercase",letterSpacing:1.5,fontFamily:F.font,marginBottom:2}}>{m.slot}</div>
                      <div style={{fontSize:14,fontWeight:600,fontFamily:F.font,color:dim?"#8a7b6a":F.cream,lineHeight:1.3,textDecoration:dim?"line-through":"none"}}>{m.r}</div>
                      {!dim&&<div style={{display:"flex",gap:10,fontSize:9,fontFamily:F.font,marginTop:4}}>
                        <span style={{color:F.pCol,fontWeight:600}}>P {m.p}g</span>
                        <span style={{color:F.kCol,fontWeight:600}}>K {m.c}g</span>
                        <span style={{color:F.fCol,fontWeight:600}}>F {m.f}g</span>
                        <span style={{color:F.mutCol,fontWeight:600}}>{m.kcal}</span>
                      </div>}
                    </div>
                    <div className={isAnim?"check-box":""} onClick={e=>{e.stopPropagation();if(!isAnim)toggleMealCheck(i)}} style={{width:28,height:28,borderRadius:8,border:"2px solid "+((isAnim||dayChecks[i])?F.olive:"rgba(120,90,50,0.25)"),background:(isAnim||dayChecks[i])?"rgba(90,110,58,0.15)":"rgba(255,255,255,0.5)",display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",transition:"all .2s",flexShrink:0}}>
                      {(isAnim||dayChecks[i])&&<span style={{color:F.olive,fontSize:14,fontWeight:700}}>‚úì</span>}
                    </div>
                  </div>
                </div>
                {/* Expanded recipe */}
                {isExpanded&&!dim&&<div style={{margin:"0 4px",padding:"0",background:"rgba(255,255,255,0.85)",borderRadius:"0 0 14px 14px",borderTop:"none",border:"1px solid "+sl.brd,borderTopColor:"transparent",boxShadow:"0 2px 8px rgba(120,90,50,0.06)",overflow:"hidden"}}>
                  {/* Recipe hero image placeholder */}
                  <div style={{width:"100%",height:140,background:imgBg,display:"flex",alignItems:"center",justifyContent:"center"}}>
                    <span style={{fontSize:48,opacity:0.7}}>{imgIcon}</span>
                  </div>
                  <div style={{padding:"16px 18px"}}>
                  {m.ingredients&&<>
                    <div style={{fontSize:10,fontWeight:700,color:F.warm,textTransform:"uppercase",letterSpacing:2,marginBottom:8,fontFamily:F.font}}>Ingredienser</div>
                    <div style={{display:"flex",flexDirection:"column",gap:4,marginBottom:16}}>
                      {m.ingredients.map((ing,ii)=><div key={ii} style={{fontSize:13,color:F.cream,fontFamily:F.font,paddingLeft:12,position:"relative"}}>
                        <span style={{position:"absolute",left:0,color:F.mutCol}}>¬∑</span>{ing}
                      </div>)}
                    </div>
                  </>}
                  {m.steps&&<>
                    <div style={{fontSize:10,fontWeight:700,color:F.warm,textTransform:"uppercase",letterSpacing:2,marginBottom:8,fontFamily:F.font}}>Tillagning</div>
                    <div style={{display:"flex",flexDirection:"column",gap:8}}>
                      {m.steps.map((step,si)=><div key={si} style={{display:"flex",gap:10,fontSize:13,color:F.cream,fontFamily:F.font,lineHeight:1.5}}>
                        <span style={{color:F.warm,fontWeight:700,fontSize:12,minWidth:18}}>{si+1}.</span>
                        <span>{step}</span>
                      </div>)}
                    </div>
                  </>}
                  </div>
                </div>}
              </div>;
            };
            
            return <>
              {active.map(x=><MealCard key={x.i} m={x.m} i={x.i}/>)}
              {done.length>0&&<>
                <div onClick={()=>setShowDoneMeals(p=>!p)} style={{display:"flex",alignItems:"center",gap:8,padding:"10px 0",margin:"4px 0",cursor:"pointer"}}>
                  <span style={{fontSize:10,color:F.mutCol,fontFamily:F.font}}>{showDoneMeals?"‚ñæ":"‚ñ∏"}</span>
                  <span style={{fontSize:11,color:F.olive,fontWeight:700,fontFamily:F.font}}>‚úì Avklarade</span>
                  <span style={{fontSize:10,color:F.mutCol,fontFamily:F.font}}>{done.length} m√•ltider</span>
                  <div style={{flex:1,height:1,background:"rgba(120,90,50,0.15)"}}/>
                </div>
                {showDoneMeals&&done.map(x=><MealCard key={x.i} m={x.m} i={x.i} dim/>)}
              </>}
            </>;
          })()}
          </>}
        </div>}
        
        {/* ====== HANDLA ====== */}
        {foodMode==="shop"&&(()=>{
          const ingIcon=(s)=>{const l=s.toLowerCase();const M=[
            [/kyckling/,"üçó"],[/lax|fisk/,"üêü"],[/k√∂ttf√§rs|f√§rs|k√∂tt/,"ü•©"],[/√§gg/,"ü•ö"],
            [/halloumi|ost/,"üßÄ"],[/mj√∂lk|kvarg|gr√§dde/,"ü•õ"],[/sm√∂r/,"üßà"],
            [/ris|pasta|nudl|br√∂d|str√∂m/,"üåæ"],[/havre|granola|chiafr/,"ü•£"],
            [/potatis/,"ü•î"],[/tomat|krossade/,"üçÖ"],[/l√∂k|vitl√∂k/,"üßÖ"],
            [/paprika/,"ü´ë"],[/broccoli|sparris|spenat|sallad|gr√∂nsak|haricots|socker/,"ü•¶"],
            [/avokado/,"ü•ë"],[/banan/,"üçå"],[/bl√•b√§r|hallon|b√§r/,"ü´ê"],
            [/citron/,"üçã"],[/kokos/,"ü••"],[/honung/,"üçØ"],
            [/oliv|sesam|olja/,"ü´í"],[/soja|sweet chili|lingon/,"ü´ô"],
            [/salt|peppar/,"üßÇ"]
          ];for(const[r,e]of M)if(r.test(l))return e;return "üõí";};
          return <div style={{width:"100%"}}>
          {shopItems.length===0?<div style={{textAlign:"center",color:F.mutCol,fontSize:13,padding:30,fontStyle:"italic",fontFamily:F.font}}>Ingen m√•ltidsplan med ingredienser</div>:(()=>{
            const doneCount=shopChecked.filter(Boolean).length;
            const pct=Math.round((doneCount/shopItems.length)*100);
            const active=shopItems.map((item,i)=>({item,i})).filter(x=>!shopChecked[x.i]);
            const done=shopItems.map((item,i)=>({item,i})).filter(x=>shopChecked[x.i]);
            
            const ShopRow=({item,i,dim})=>{
              const isAnim=animShop===i;
              return <div key={i} className={isAnim?"shop-checking":""} onClick={()=>!isAnim&&toggleShopCheck(i)} style={{display:"flex",alignItems:"center",gap:12,padding:"10px 14px",borderRadius:10,background:dim?"rgba(90,110,58,0.06)":"rgba(255,255,255,0.6)",border:"1px solid "+(dim?"rgba(90,110,58,0.15)":F.lineBrd),cursor:"pointer",transition:"all .3s",opacity:dim?0.55:1}}>
              <div style={{width:34,height:34,borderRadius:8,background:dim?"rgba(90,110,58,0.06)":"rgba(255,248,230,0.8)",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,fontSize:18,filter:dim?"grayscale(0.8)":"none",transition:"all .15s"}}>
                {ingIcon(item)}
              </div>
              <span style={{flex:1,fontSize:14,fontFamily:F.font,color:dim?F.mutCol:F.cream,textDecoration:dim?"line-through":"none",transition:"all .15s"}}>{item}</span>
              <div className={isAnim?"check-box":""} style={{width:22,height:22,borderRadius:6,border:"2px solid "+((isAnim||dim)?F.olive:"rgba(120,90,50,0.25)"),background:(isAnim||dim)?"rgba(90,110,58,0.15)":"#fff",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"all .2s"}}>
                {(isAnim||dim)&&<span style={{color:F.olive,fontSize:12,fontWeight:700}}>‚úì</span>}
              </div>
            </div>};
            
            return <>
              {/* Progress bar */}
              <div style={{marginBottom:14}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:4}}>
                  <span style={{fontSize:10,color:F.mutCol,fontFamily:F.font}}>Ink√∂pslista</span>
                  <span style={{fontSize:11,fontWeight:700,color:pct===100?F.olive:F.warm,fontFamily:F.font}}>{doneCount}/{shopItems.length}{pct===100?" ‚úì":""}</span>
                </div>
                <div style={{height:6,borderRadius:3,background:"rgba(180,150,100,0.18)"}}>
                  <div style={{width:pct+"%",height:"100%",borderRadius:3,background:pct===100?"#5a6e3a":"linear-gradient(90deg, #b8860b, #d4a017)",transition:"width .4s ease"}}/>
                </div>
              </div>
              
              {/* Active items */}
              <div style={{display:"flex",flexDirection:"column",gap:4}}>
                {active.map(x=><ShopRow key={x.i} item={x.item} i={x.i}/>)}
              </div>
              
              {/* Done items */}
              {done.length>0&&<>
                <div style={{display:"flex",alignItems:"center",gap:8,padding:"10px 0",margin:"4px 0",cursor:"pointer"}}>
                  <span style={{fontSize:11,color:F.olive,fontWeight:700,fontFamily:F.font}}>‚úì I varukorgen</span>
                  <span style={{fontSize:10,color:F.mutCol,fontFamily:F.font}}>{done.length}</span>
                  <div style={{flex:1,height:1,background:"rgba(120,90,50,0.15)"}}/>
                </div>
                <div style={{display:"flex",flexDirection:"column",gap:4}}>
                  {done.map(x=><ShopRow key={x.i} item={x.item} i={x.i} dim/>)}
                </div>
              </>}
            </>;
          })()}
        </div>;
        })()}
        
        {/* ====== MAKROLOG ====== */}
        {foodMode==="macro"&&<div style={{display:"flex",flexDirection:"column",alignItems:"center",width:"100%"}}>
          <div style={{display:"flex",alignItems:"center",gap:6,marginBottom:4}}>
            <div style={{fontSize:9,color:F.mutCol,textTransform:"uppercase",letterSpacing:3,fontFamily:F.font}}>Dagens m√•l</div>
            <div onClick={()=>setMacroTip(true)} style={{width:18,height:18,borderRadius:"50%",border:"1px solid "+F.lineBrd,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer",fontSize:10,color:F.mutCol,fontFamily:F.font}}>?</div>
          </div>
          
          {/* Macro info modal */}
          {macroTip&&<div onClick={()=>setMacroTip(false)} style={{position:"fixed",inset:0,zIndex:80,background:"rgba(0,0,0,0.4)",backdropFilter:"blur(6px)",display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
            <div onClick={e=>e.stopPropagation()} style={{background:"#faf6ee",border:"1px solid rgba(180,150,100,0.25)",borderRadius:16,padding:24,maxWidth:360,width:"100%",boxShadow:"0 8px 32px rgba(80,60,20,0.15)"}}>
              <div style={{fontSize:15,fontWeight:700,color:F.warm,fontFamily:F.font,marginBottom:12}}>Makrologgning</div>
              <div style={{display:"flex",flexDirection:"column",gap:12,fontSize:13,color:F.cream,fontFamily:F.font,lineHeight:1.6}}>
                <p style={{margin:0}}>Det spelar ingen roll <em>vad</em> du √§ter eller <em>n√§r</em> du √§ter det ‚Äî s√• l√§nge du f√•r i dig r√§tt m√§ngd <strong style={{color:F.pCol}}>protein</strong>, <strong style={{color:F.kCol}}>kolhydrater</strong> och <strong style={{color:F.fCol}}>fett</strong> totalt under dagen.</p>
                <p style={{margin:0}}>Perfekt om du vill ha frihet att v√§lja egen mat men √§nd√• n√• dina m√•l. Kr√§ver lite mer koll ‚Äî du beh√∂ver uppskatta eller v√§ga det du √§ter.</p>
                <div style={{padding:"10px 12px",background:"rgba(184,134,11,0.08)",borderRadius:8,border:"1px solid rgba(184,134,11,0.15)",fontSize:12}}>
                  F√∂ljer du m√•ltidsplanen? D√• beh√∂ver du inte logga h√§r ‚Äî makros r√§knas automatiskt n√§r du checkar av m√•ltider.
                </div>
              </div>
              <button onClick={()=>setMacroTip(false)} style={{width:"100%",marginTop:16,padding:"12px",background:F.warm,border:"none",borderRadius:10,color:"#fff",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:F.font}}>F√∂rst√•tt</button>
            </div>
          </div>}
          <div style={{fontSize:32,fontWeight:700,fontFamily:F.font,color:F.warm,lineHeight:1}}>{kcal(c.macros.p,c.macros.c,c.macros.f)}<span style={{fontSize:12,fontWeight:500,color:F.bark}}> kcal</span></div>
          <div style={{display:"flex",gap:16,marginTop:8,marginBottom:16}}>
            {[["Protein",c.macros.p,F.pCol],["Kolhydrater",c.macros.c,F.kCol],["Fett",c.macros.f,F.fCol]].map(([l,v,col])=>
              <div key={l} style={{textAlign:"center"}}>
                <div style={{fontSize:16,fontWeight:700,fontFamily:F.font,color:col}}>{v}<span style={{fontSize:9,fontWeight:500}}>g</span></div>
                <div style={{fontSize:8,color:F.mutCol,fontFamily:F.font}}>{l}</div>
              </div>
            )}
          </div>
          <div style={{width:"100%",maxWidth:360}}>
            {[["Protein","p",F.pCol,c.macros.p],["Kolhydrater","c",F.kCol,c.macros.c],["Fett","f",F.fCol,c.macros.f]].map(([label,key,col,goal])=>{
              const val=macroLog[macroDay]?.[key]||0;
              const pct=Math.min(100,Math.round((val/Math.round(goal*2.5))*100));
              return <div key={key} style={{marginBottom:10}}>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:3}}>
                  <span style={{fontSize:11,fontWeight:700,color:col,fontFamily:F.font}}>{label}</span>
                  <div style={{display:"flex",alignItems:"baseline",gap:4}}>
                    <span style={{fontSize:16,fontWeight:700,fontFamily:F.font,color:col}}>{val}</span>
                    <span style={{fontSize:9,color:F.mutCol,fontFamily:F.font}}>/ {goal}g</span>
                  </div>
                </div>
                <div style={{position:"relative",height:24,display:"flex",alignItems:"center"}}>
                  <div style={{position:"absolute",left:0,right:0,height:6,borderRadius:3,background:"rgba(180,150,100,0.18)"}}>
                    <div style={{width:pct+"%",height:"100%",borderRadius:3,background:col,transition:"width .05s"}}/>
                  </div>
                  <input type="range" min={0} max={Math.round(goal*2.5)} step={1} value={val} onChange={e=>setMacroLog(p=>p.map((d,i)=>i===macroDay?{...d,[key]:Number(e.target.value),_saved:false}:d))} style={{width:"100%",height:24,position:"relative",zIndex:2,opacity:0,cursor:"pointer"}}/>
                  <div style={{position:"absolute",left:`calc(${pct}% - 10px)`,top:"50%",transform:"translateY(-50%)",width:20,height:20,borderRadius:"50%",background:col,border:"3px solid #fff",boxShadow:"0 1px 4px rgba(0,0,0,0.2)",pointerEvents:"none",zIndex:3,transition:"left .05s"}}/>
                </div>
              </div>;
            })}
          </div>
          <div style={{padding:"8px 16px",background:"rgba(255,255,255,0.5)",borderRadius:8,border:"1px solid "+F.lineBrd,display:"flex",alignItems:"center",gap:8}}>
            <span style={{fontSize:20,fontWeight:700,fontFamily:F.font,color:F.warm}}>{kcal(macroLog[macroDay]?.p||0,macroLog[macroDay]?.c||0,macroLog[macroDay]?.f||0)}</span>
            <span style={{fontSize:10,color:F.mutCol,fontFamily:F.font}}>/ {kcal(c.macros.p,c.macros.c,c.macros.f)} kcal</span>
          </div>
        </div>}
        
        {/* Food day celebration */}
        {foodCelebration&&<div style={{position:"fixed",inset:0,bottom:56,zIndex:80,background:"#faf6ee",display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:24,animation:"fadeUp .3s ease"}}>
          {/* Plate icon */}
          <div style={{width:90,height:90,borderRadius:"50%",background:"rgba(90,110,58,0.12)",display:"flex",alignItems:"center",justifyContent:"center",border:"2px solid rgba(90,110,58,0.3)",marginBottom:20}}>
            <span style={{fontSize:44,animation:"flashPop .5s ease"}}>üçΩÔ∏è</span>
          </div>
          
          {/* Status */}
          <div style={{fontSize:11,color:F.olive,textTransform:"uppercase",letterSpacing:3,fontWeight:700,marginBottom:6,animation:"fadeUp .3s ease .1s both"}}>Dagens m√•ltider</div>
          <div style={{fontSize:24,fontWeight:800,color:F.cream,letterSpacing:-0.5,fontFamily:F.font,animation:"fadeUp .3s ease .15s both"}}>Klart! ‚úì</div>
          
          {/* Stats */}
          <div style={{display:"flex",gap:24,marginTop:16,animation:"fadeUp .3s ease .2s both"}}>
            <div style={{textAlign:"center"}}>
              <div style={{fontSize:28,fontWeight:800,color:F.warm,fontFamily:F.font}}>{foodCelebration.meals}</div>
              <div style={{fontSize:9,color:F.mutCol,textTransform:"uppercase",letterSpacing:1}}>m√•ltider</div>
            </div>
            <div style={{width:1,background:F.lineBrd,alignSelf:"stretch"}}/>
            <div style={{textAlign:"center"}}>
              <div style={{fontSize:28,fontWeight:800,color:F.warm,fontFamily:F.font}}>{foodCelebration.kcal}</div>
              <div style={{fontSize:9,color:F.mutCol,textTransform:"uppercase",letterSpacing:1}}>kcal</div>
            </div>
          </div>
          
          {/* Tip card */}
          <div style={{marginTop:24,padding:"16px 20px",background:"rgba(184,134,11,0.06)",border:"1px solid rgba(184,134,11,0.15)",borderRadius:14,maxWidth:300,width:"100%",animation:"fadeUp .3s ease .3s both"}}>
            <div style={{fontSize:9,color:F.olive,textTransform:"uppercase",letterSpacing:2,fontWeight:700,marginBottom:6}}>üåø Kosttips</div>
            <div style={{fontSize:13,color:F.cream,lineHeight:1.5,fontFamily:F.font}}>{foodCelebration.tip}</div>
          </div>
          
          {/* Dismiss */}
          <button onClick={()=>{
            setFoodCelebration(null);
            if(macroDay<6)setMacroDay(p=>p+1);
            setExpandedMeal(null);
          }} style={{marginTop:28,padding:"14px 40px",background:F.warm,border:"none",borderRadius:14,color:"#fff",fontSize:15,fontWeight:800,cursor:"pointer",letterSpacing:0.3,textTransform:"uppercase",fontFamily:F.font,animation:"fadeUp .3s ease .4s both",boxShadow:"0 2px 12px rgba(184,134,11,0.3)"}}>
            {macroDay<6?"N√§sta dag ‚Üí":"Klart!"}
          </button>
          
          <style>{`
            @keyframes flashPop{0%{transform:scale(0.5);opacity:0}60%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}
            @keyframes fadeUp{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
          `}</style>
        </div>}
        
      </div>;
      })()}
      
      {/* === VIKT === */}
      {tab==="weight"&&isLocked("weight")&&<LockedTab type="food"/>}
      {tab==="weight"&&!isLocked("weight")&&(()=>{
        const baseKg=Math.round(c.curW);
        const WKGS=[];for(let v=baseKg-10;v<=baseKg+10;v++)if(v>=30)WKGS.push(v);
        const WDECS=[0,1,2,3,4,5,6,7,8,9];
        const WDEC_LABELS=[",0",",1",",2",",3",",4",",5",",6",",7",",8",",9"];
        const curVal=weightLog[weightDay]||c.curW;
        const curWhole=Math.floor(curVal);
        const curDec=Math.round((curVal-curWhole)*10);
        const savedCount=weightSaved.filter(Boolean).length;
        return <div style={{display:"flex",flexDirection:"column",minHeight:"calc(100vh - 200px)"}}>
          
          {/* Pyramid header */}
          <SectionHeader 
            title="Din vikt" 
            accent={W.acc}
            dimColor={W.mut}
            brdColor={W.brd}
          />
          
          {/* DAY TABS ‚Äî unified component */}
          <DayTabs 
            days={DN} 
            active={weightDay} 
            onSelect={setWeightDay}
            checkFn={(i)=>weightSaved[i]}
            theme={{
              active:W.acc,activeBg:W.cardHi,activeBrd:W.acc+"60",
              doneBrd:W.acc+"25",doneBg:"rgba(61,122,156,0.06)",doneCol:W.acc,
              defBrd:W.brd,defCol:W.mut,font:W.font,shadow:"0 2px 8px rgba(61,122,156,0.12)"
            }}
          />
          
          {/* Centered wheel area */}
          <div style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",width:"100%"}}>
            
            {/* Current value display + tips icon */}
            <div style={{position:"relative",marginBottom:20}}>
              <div style={{textAlign:"center",padding:"16px 32px",background:W.cardHi,borderRadius:20,border:"1px solid "+(weightPulse?W.acc:W.brd),boxShadow:weightPulse?"0 0 20px rgba(61,122,156,0.25)":"0 4px 20px rgba(61,122,156,0.08)",transition:"all .3s ease"}}>
                <div style={{display:"flex",alignItems:"baseline",justifyContent:"center",gap:6}}>
                  <span style={{fontSize:44,fontWeight:800,color:W.text,letterSpacing:-1,transition:"transform .3s ease",transform:weightPulse?"scale(1.1)":"scale(1)"}}>{curVal.toFixed(1)}</span>
                  <span style={{fontSize:16,color:W.mut,fontWeight:600}}>kg</span>
                </div>
                <div style={{fontSize:10,color:W.mut,marginTop:4}}>{DN[weightDay]}</div>
              </div>
              <div onClick={()=>setWeighTip(true)} style={{position:"absolute",right:-40,top:"50%",transform:"translateY(-50%)",width:28,height:28,borderRadius:"50%",background:W.card,border:"1px solid "+W.brd,display:"flex",alignItems:"center",justifyContent:"center",cursor:"pointer"}}>
                <span style={{fontSize:12}}>üí°</span>
              </div>
            </div>
            
            {/* Wheels */}
            <div style={{display:"flex",justifyContent:"center",alignItems:"flex-start",gap:6}}>
              <div style={{textAlign:"center"}}>
                <div style={{fontSize:9,color:W.acc,textTransform:"uppercase",letterSpacing:1.5,marginBottom:6,fontWeight:700}}>kg</div>
                <FitLogWheel items={WKGS} value={curWhole} visCount={3} itemH={60} onChange={v=>{const nv=v+curDec/10;setWeightLog(p=>p.map((w,i)=>i===weightDay?Math.round(nv*10)/10:w));setWeightSaved(p=>p.map((s,i)=>i===weightDay?false:s))}} color={W.acc} textColor={W.text} dimColor={W.mut} bgColor={W.card} width={100}/>
              </div>
              <div style={{textAlign:"center"}}>
                <div style={{fontSize:9,color:W.acc,textTransform:"uppercase",letterSpacing:1.5,marginBottom:6,fontWeight:700}}>,</div>
                <FitLogWheel items={WDECS} labels={WDEC_LABELS} value={curDec} visCount={3} itemH={60} onChange={v=>{const nv=curWhole+v/10;setWeightLog(p=>p.map((w,i)=>i===weightDay?Math.round(nv*10)/10:w));setWeightSaved(p=>p.map((s,i)=>i===weightDay?false:s))}} color={W.acc} textColor={W.text} dimColor={W.mut} bgColor={W.card} width={80}/>
              </div>
            </div>
          </div>
          
          {/* Weight save celebration */}
          {weightCelebration&&<div style={{position:"fixed",inset:0,bottom:56,zIndex:80,background:W.bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:24,animation:"fadeUp .3s ease"}}>
            {/* Checkmark ring */}
            <div style={{position:"relative",width:100,height:100,marginBottom:20}}>
              <svg width={100} height={100} style={{transform:"rotate(-90deg)"}}>
                <circle cx={50} cy={50} r={42} fill="none" stroke={W.brd} strokeWidth={3}/>
                <circle cx={50} cy={50} r={42} fill="none" stroke={W.acc} strokeWidth={3} strokeLinecap="round"
                  strokeDasharray={264} strokeDashoffset={264*(1-weightCelebration.count/7)}
                  style={{transition:"stroke-dashoffset .6s ease"}}/>
              </svg>
              <div style={{position:"absolute",inset:0,display:"flex",alignItems:"center",justifyContent:"center"}}>
                <span style={{fontSize:40,animation:"flashPop .5s ease"}}>‚úì</span>
              </div>
            </div>
            
            {/* Value */}
            <div style={{fontSize:36,fontWeight:800,color:W.text,letterSpacing:-1,animation:"fadeUp .3s ease .1s both"}}>{weightCelebration.value.toFixed(1)} kg</div>
            <div style={{fontSize:12,color:W.mut,marginTop:4,animation:"fadeUp .3s ease .15s both"}}>{weightCelebration.day} ‚Äî sparad</div>
            
            {/* Progress */}
            <div style={{marginTop:20,fontSize:13,color:W.acc,fontWeight:700,animation:"fadeUp .3s ease .2s both"}}>
              {weightCelebration.allDone?"üéâ Alla 7 dagar loggade!":`${weightCelebration.count} av 7 dagar`}
            </div>
            
            {/* Tip card */}
            <div style={{marginTop:24,padding:"16px 20px",background:W.cardHi,border:"1px solid "+W.brd,borderRadius:14,maxWidth:300,width:"100%",animation:"fadeUp .3s ease .3s both"}}>
              <div style={{fontSize:9,color:W.acc,textTransform:"uppercase",letterSpacing:2,fontWeight:700,marginBottom:6}}>üí° Visste du?</div>
              <div style={{fontSize:13,color:W.dim,lineHeight:1.5,fontFamily:W.font}}>{weightCelebration.tip}</div>
            </div>
            
            {/* Dismiss */}
            <button onClick={()=>{
              setWeightCelebration(null);
              if(weightDay<6)setWeightDay(p=>p+1);
            }} style={{marginTop:28,padding:"14px 40px",background:W.acc,border:"none",borderRadius:14,color:"#fff",fontSize:15,fontWeight:800,cursor:"pointer",letterSpacing:0.3,textTransform:"uppercase",animation:"fadeUp .3s ease .4s both",boxShadow:"0 2px 12px rgba(61,122,156,0.3)"}}>
              {weightCelebration.allDone?"Klart!":weightDay<6?"N√§sta dag ‚Üí":"St√§ng"}
            </button>
            
            <style>{`
              @keyframes flashPop{0%{transform:scale(0.5);opacity:0}60%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}
              @keyframes fadeUp{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
            `}</style>
          </div>}
          
          {/* Weigh tip popup ‚Äî bathroom themed */}
          {weighTip&&<div onClick={()=>setWeighTip(false)} style={{position:"fixed",inset:0,zIndex:80,background:"rgba(26,46,62,0.7)",backdropFilter:"blur(12px)",display:"flex",alignItems:"center",justifyContent:"center",padding:16}}>
            <div onClick={e=>e.stopPropagation()} style={{background:W.bg,border:"1px solid "+W.brd,borderRadius:20,padding:28,maxWidth:340,width:"100%",boxShadow:"0 8px 40px rgba(0,0,0,0.15)"}}>
              <div style={{fontSize:16,fontWeight:800,marginBottom:20,textAlign:"center",color:W.text}}>‚öñÔ∏è S√• v√§ger du dig r√§tt</div>
              <div style={{display:"flex",flexDirection:"column",gap:14}}>
                {[["üåÖ","P√• morgonen","V√§g dig direkt efter att du vaknat, samma tid varje dag."],
                  ["üöΩ","Efter toalettbes√∂k","T√∂m bl√•san innan du st√§ller dig p√• v√•gen."],
                  ["üëô","Utan kl√§der","V√§g dig utan kl√§der f√∂r att undvika variationer."],
                  ["üö´","P√• fastande mage","√Ñt eller drick inget innan du v√§ger dig."],
                  ["üìç","Samma v√•g & plats","Anv√§nd alltid samma v√•g p√• ett h√•rt, plant underlag."]
                ].map(([icon,title,desc],i)=><div key={i} style={{display:"flex",gap:12,alignItems:"flex-start"}}>
                  <div style={{width:40,height:40,borderRadius:10,background:W.cardHi,display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,fontSize:18,border:"1px solid "+W.brd}}>{icon}</div>
                  <div>
                    <div style={{fontSize:13,fontWeight:700,marginBottom:2,color:W.text}}>{title}</div>
                    <div style={{fontSize:11,color:W.dim,lineHeight:1.5}}>{desc}</div>
                  </div>
                </div>)}
              </div>
              <button onClick={()=>setWeighTip(false)} style={{width:"100%",marginTop:24,padding:14,background:W.acc,border:"none",borderRadius:12,color:"#fff",fontSize:14,fontWeight:700,cursor:"pointer",letterSpacing:0.3,boxShadow:"0 2px 12px rgba(61,122,156,0.3)"}}>F√∂rst√•tt</button>
            </div>
          </div>}
        </div>;
      })()}
      
      {/* === CHECK-IN === */}
      {tab==="checkin"&&(()=>{
        const passCount=trainLog.filter(d=>d.exercises.every(e=>e.sets.every(s=>s.reps>0))).length;
        const kostCount=macroLog.filter(d=>d._saved).length||mealChecked.filter(dc=>dc.length>0&&dc.every(Boolean)).length;
        const weightCount=weightSaved.filter(Boolean).length;
        
        return <div>
          <SectionHeader title="Veckorapport" accent={CI.acc} dimColor={CI.mut} brdColor={CI.brd}/>
          
          <WeekProgress
            weekCurrent={c.wkC}
            weekTotal={c.wkT}
            activeWeek={null}
            accent={CI.acc}
            dimColor={CI.mut}
            brdColor={CI.brd}
          />
        
          {/* Self-assessment */}
          <div style={{marginBottom:24}}>
            {[
              {label:"Sv√•righetsgrad",key:"difficulty",opts:["F√∂r l√§tt","Perfekt utmanande","F√∂r sv√•rt"],display:["F√∂r l√§tt","Perfekt","F√∂r sv√•rt"]},
              {label:"Energiniv√•",key:"energy",opts:["Tr√∂tt","Neutral","Pigg"],display:["Tr√∂tt","Neutral","Pigg"]},
              {label:"M√•ende",key:"mood",opts:["D√•ligt","Okej","Bra","Toppen"],display:["D√•ligt","Okej","Bra","Toppen"]}
            ].map(({label,key,opts,display})=>
              <div key={key} style={{marginBottom:16}}>
                <div style={{fontSize:10,color:CI.mut,textTransform:"uppercase",letterSpacing:1.5,marginBottom:8}}>{label}</div>
                <div style={{display:"flex",gap:0,background:CI.card,borderRadius:10,border:"1px solid "+CI.brd,overflow:"hidden"}}>
                  {opts.map((v,i)=>{
                    const active=selfAssess[key]===v;
                    return <button key={v} onClick={()=>setSelfAssess(p=>({...p,[key]:v}))} style={{flex:1,padding:"11px 4px",background:active?"rgba(255,204,0,0.2)":"transparent",border:"none",borderRight:i<opts.length-1?"1px solid "+CI.brd:"none",color:active?CI.acc:CI.dim,fontSize:11,fontWeight:active?700:500,cursor:"pointer",transition:"all .15s",fontFamily:T.f}}>
                      {display[i]}
                    </button>;
                  })}
                </div>
              </div>
            )}
          </div>
          
          {/* Message */}
          <div style={{marginBottom:24}}>
            <div style={{fontSize:10,color:CI.mut,textTransform:"uppercase",letterSpacing:1.5,marginBottom:8}}>Meddelande till PT</div>
            <textarea value={msg} onChange={e=>setMsg(e.target.value)} placeholder="Hur gick veckan? N√•got speciellt att n√§mna..." style={{width:"100%",minHeight:100,padding:14,borderRadius:12,border:"1px solid "+CI.brd,background:CI.card,color:"#fff",fontSize:13,fontFamily:T.f,outline:"none",resize:"vertical",boxSizing:"border-box",lineHeight:1.6,transition:"border-color .2s"}} onFocus={e=>e.target.style.borderColor=CI.acc+"60"} onBlur={e=>e.target.style.borderColor=CI.brd}/>
          </div>
        
          {/* Progress photos */}
          <div style={{marginBottom:24}}>
            <div style={{fontSize:10,color:CI.mut,textTransform:"uppercase",letterSpacing:1.5,marginBottom:8}}>Loggbilder</div>
            <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
              {progressPhotos.map((ph,i)=><div key={i} style={{position:"relative",width:72,height:90,borderRadius:10,overflow:"hidden",border:"1px solid "+CI.brd}}>
                <img src={ph} style={{width:"100%",height:"100%",objectFit:"cover"}}/>
                <button onClick={()=>setProgressPhotos(p=>p.filter((_,j)=>j!==i))} style={{position:"absolute",top:4,right:4,width:18,height:18,borderRadius:"50%",background:"rgba(0,0,0,0.6)",border:"none",color:"#fff",fontSize:9,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}}>‚úï</button>
              </div>)}
              <label style={{width:72,height:90,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",gap:3,border:"1px dashed "+CI.brd,borderRadius:10,cursor:"pointer",transition:"border-color .15s"}} onMouseEnter={e=>e.currentTarget.style.borderColor=CI.dim} onMouseLeave={e=>e.currentTarget.style.borderColor=CI.brd}>
                <span style={{fontSize:16,color:CI.dim}}>+</span>
                <span style={{fontSize:8,color:CI.mut}}>L√§gg till</span>
                <input type="file" accept="image/*" multiple hidden onChange={e=>{
                  [...e.target.files].forEach(f=>{const reader=new FileReader();reader.onload=ev=>setProgressPhotos(p=>[...p,ev.target.result]);reader.readAsDataURL(f)});
                  e.target.value="";
                }}/>
              </label>
            </div>
          </div>
          
          {/* Summary */}
          <div style={{marginBottom:24,padding:"14px 0",borderTop:"1px solid "+CI.brd,borderBottom:"1px solid "+CI.brd}}>
            {[
              ["Pass loggade",passCount+"/"+trainLog.length],
              ["Kostdagar",kostCount+"/7"],
              ["Inv√§gningar",weightCount+"/7"],
              ["Loggbilder",String(progressPhotos.length)]
            ].map(([label,val])=>
              <div key={label} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"5px 0"}}>
                <span style={{fontSize:12,color:CI.dim}}>{label}</span>
                <span style={{fontSize:12,fontWeight:700,color:"#fff",fontFamily:T.mono}}>{val}</span>
              </div>
            )}
          </div>
          
          {/* Send button */}
          {!sent&&!sending&&<button onClick={()=>{
            setSending(true);setSendDots(0);
            let d=0;const di=setInterval(()=>{d=(d+1)%4;setSendDots(d)},400);
            setTimeout(()=>{clearInterval(di);setSending(false);setSent(true);if(onSendWeek)onSendWeek({trainLog,macroLog,weightLog,msg,selfAssess,progressPhotos})},2000);
          }} style={{width:"100%",padding:"16px",background:CI.acc,border:"none",borderRadius:14,color:"#111",fontSize:15,fontWeight:800,cursor:"pointer",letterSpacing:0.5,textTransform:"uppercase"}}>
            Skicka vecka {c.wkC}
          </button>}
          
          {/* Sending overlay */}
          {sending&&<div style={{position:"fixed",inset:0,bottom:56,zIndex:80,background:CI.bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:24}}>
            <div style={{width:80,height:80,borderRadius:"50%",border:"2px solid "+CI.brd,display:"flex",alignItems:"center",justifyContent:"center",marginBottom:24}}>
              <div style={{width:56,height:56,borderRadius:"50%",border:"2px solid transparent",borderTopColor:CI.acc,animation:"sendSpin .8s linear infinite"}}/>
            </div>
            <div style={{fontSize:16,fontWeight:700,color:"#fff"}}>Skickar{".".repeat(sendDots)}</div>
            <div style={{fontSize:11,color:CI.dim,marginTop:4}}>Vecka {c.wkC}</div>
            <style>{`@keyframes sendSpin{to{transform:rotate(360deg)}}`}</style>
          </div>}
          
          {/* Sent celebration */}
          {sent&&(()=>{
            const scienceTips=[
              {title:"Progressiv √∂verbelastning",tip:"√ñka volym (set √ó reps √ó kg) med 2‚Äì5% per vecka. Kroppen anpassar sig bara om stimulit √∂kar."},
              {title:"S√∂mnens superkraft",tip:"7‚Äì9 timmar s√∂mn √∂kar proteinsyntesen med upp till 20%. Musklerna byggs under vila ‚Äî inte under tr√§ning."},
              {title:"Proteinets sweet spot",tip:"1.6‚Äì2.2g protein per kg kroppsvikt per dag maximerar muskelproteinsyntesen √∂ver 3‚Äì5 m√•ltider."},
              {title:"Vila mellan set",tip:"2‚Äì3 min vila f√∂r styrka, 60‚Äì90 sek f√∂r hypertrofi. L√§ngre vila ger fler reps i n√§sta set."},
              {title:"Deload-veckor",tip:"Var 4‚Äì6:e vecka, s√§nk volym med 40‚Äì50%. F√∂rebygger √∂vertr√§ning och ger starkare comeback."},
              {title:"Mind-muscle connection",tip:"Mentalt fokus p√• m√•lmuskeln √∂kar muskelaktiveringen med upp till 20% enligt EMG-studier."},
              {title:"Konsistens sl√•r perfektion",tip:"80% f√∂ljsamhet ger 90% av resultaten. Missa inte hela veckan f√∂r att en dag inte blev perfekt."},
              {title:"Kreatins effekt",tip:"3‚Äì5g kreatin dagligen √∂kar styrka med 5‚Äì10% och muskelmassa med 1‚Äì2kg p√• 12 veckor."}
            ];
            const tip=scienceTips[c.wkC%scienceTips.length];
            
            return <div style={{position:"fixed",inset:0,bottom:56,zIndex:80,background:CI.bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",padding:24,overflow:"hidden"}}>
              {[...Array(12)].map((_,i)=><div key={i} style={{position:"absolute",width:6,height:6,borderRadius:"50%",background:[CI.acc,"#fff",CI.dim,CI.acc+"80"][i%4],top:`${10+Math.random()*80}%`,left:`${5+Math.random()*90}%`,animation:`confettiFall ${1+Math.random()*1.5}s ease ${i*0.1}s both`,opacity:0}}/>)}
              
              <div style={{fontSize:56,color:CI.acc,animation:"flashPop .5s ease"}}>‚úì</div>
              <div style={{fontSize:24,fontWeight:800,color:"#fff",letterSpacing:-0.5,marginTop:8,animation:"fadeUp .4s ease .2s both"}}>Inskickad</div>
              <div style={{fontSize:13,color:CI.dim,animation:"fadeUp .4s ease .3s both"}}>Vecka {c.wkC} ‚Äî din PT ser det direkt</div>
              
              <div style={{display:"flex",gap:32,marginTop:20,animation:"fadeUp .4s ease .4s both"}}>
                <div style={{textAlign:"center"}}>
                  <div style={{fontSize:32,fontWeight:800,color:CI.acc}}>{passCount}</div>
                  <div style={{fontSize:10,color:CI.mut,textTransform:"uppercase",letterSpacing:1}}>pass</div>
                </div>
                <div style={{width:1,background:CI.brd,alignSelf:"stretch"}}/>
                <div style={{textAlign:"center"}}>
                  <div style={{fontSize:32,fontWeight:800,color:CI.acc}}>{weightCount}/7</div>
                  <div style={{fontSize:10,color:CI.mut,textTransform:"uppercase",letterSpacing:1}}>v√§gningar</div>
                </div>
              </div>
              
              <div style={{marginTop:28,padding:"16px 20px",background:CI.card,border:"1px solid "+CI.brd,borderRadius:14,maxWidth:300,width:"100%",animation:"fadeUp .4s ease .55s both"}}>
                <div style={{fontSize:9,color:CI.acc,textTransform:"uppercase",letterSpacing:2,fontWeight:700,marginBottom:8}}>Veckans kunskap</div>
                <div style={{fontSize:13,fontWeight:700,color:"#fff",marginBottom:4}}>{tip.title}</div>
                <div style={{fontSize:11,color:CI.dim,lineHeight:1.6}}>{tip.tip}</div>
              </div>
              
              <button onClick={()=>setSent(false)} style={{marginTop:24,padding:"14px 40px",background:CI.acc,border:"none",borderRadius:14,color:"#111",fontSize:15,fontWeight:800,cursor:"pointer",letterSpacing:0.5,textTransform:"uppercase",animation:"fadeUp .4s ease .7s both"}}>St√§ng</button>
              
              <style>{`
                @keyframes flashPop{0%{transform:scale(0.5);opacity:0}60%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}
                @keyframes fadeUp{0%{opacity:0;transform:translateY(20px)}100%{opacity:1;transform:translateY(0)}}
                @keyframes confettiFall{0%{opacity:0;transform:translateY(-30px) scale(0)}20%{opacity:1;transform:translateY(0) scale(1.3)}80%{opacity:.6}100%{opacity:0;transform:translateY(50px) scale(0)}}
              `}</style>
            </div>;
          })()}
        </div>;
      })()}
    </div>
    
    {/* Action bar ‚Äî fixed above nav, z:59 so workout overlay (z:80) covers it */}
    {hasAction&&<div style={{position:"fixed",bottom:56,left:0,right:0,zIndex:59,padding:"8px 16px",background:locked?LK.abg:isCheckin?CI.hdr:isFood?"rgba(245,239,228,0.96)":isWeight?"rgba(232,240,246,0.96)":"rgba(26,26,26,0.95)",backdropFilter:"blur(12px)"}}>
      <div style={{maxWidth:420,margin:"0 auto"}}>
        {tab==="train"&&!isLocked("train")&&trainView==="exercises"&&curDay&&(curDay.exercises.some(e=>e.sets.some(s=>!s.reps))?
          <button onClick={startWorkout} style={{width:"100%",padding:"16px",background:T.acc,border:"none",borderRadius:14,color:"#1a1a1a",fontSize:15,fontWeight:800,cursor:"pointer",letterSpacing:0.5,textTransform:"uppercase"}}>‚ñ∂ Starta pass</button>
        :<div style={{width:"100%",padding:"16px",background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:14,color:T.dim,fontSize:15,fontWeight:800,textAlign:"center",letterSpacing:0.3,textTransform:"uppercase"}}>‚úì Alla √∂vningar klara</div>)}
        {tab==="food"&&!isLocked("food")&&foodMode==="macro"&&<button onClick={()=>{
          setMacroLog(p=>p.map((d,i)=>i===macroDay?{...d,_saved:true}:d));
          if(macroDay<6)setTimeout(()=>setMacroDay(p=>p+1),300);
        }} style={{width:"100%",padding:"16px",background:macroLog[macroDay]?._saved?"rgba(90,110,58,0.15)":"#b8860b",border:macroLog[macroDay]?._saved?"1px solid rgba(90,110,58,0.3)":"none",borderRadius:14,color:macroLog[macroDay]?._saved?"#5a6e3a":"#fff",fontSize:15,fontWeight:800,cursor:"pointer",transition:"all .2s",boxShadow:macroLog[macroDay]?._saved?"none":"0 2px 8px rgba(184,134,11,0.3)",fontFamily:"Georgia, 'Times New Roman', serif",letterSpacing:0.3}}>
          {macroLog[macroDay]?._saved?"‚úì Sparad":"Spara "+DN[macroDay]}
        </button>}
        {tab==="weight"&&!isLocked("weight")&&<button onClick={()=>{
          if(weightSaved[weightDay])return;
          const val=weightLog[weightDay]||c.curW;
          setWeightLog(p=>p.map((w,i)=>i===weightDay?(w||c.curW):w));
          setWeightSaved(p=>p.map((s,i)=>i===weightDay?true:s));
          setWeightPulse(true);setTimeout(()=>setWeightPulse(false),500);
          const newCount=weightSaved.filter(Boolean).length+1;
          const allDone=newCount>=7;
          const tips=[
            "V√§g dig samma tid varje dag f√∂r mest p√•litliga resultat.",
            "Vikten kan sv√§nga ¬±1kg dag till dag ‚Äî helt normalt!",
            "Titta p√• trender √∂ver veckor, inte dagliga siffror.",
            "Har du √§tit salt? V√§tskebindning kan ge +0.5‚Äì1kg.",
            "Bra sovmorgon? Morgonvikt √§r mest stabil.",
            "Daglig inv√§gning ger b√§st data till din PT.",
            "Stress och s√∂mn p√•verkar v√§tskebalans och vikt."
          ];
          const tip=tips[weightDay]||tips[0];
          setWeightCelebration({value:val,day:DN[weightDay],tip,allDone,count:newCount});
        }} style={{width:"100%",padding:"16px",background:weightSaved[weightDay]?W.card:W.acc,border:weightSaved[weightDay]?"1px solid "+W.brd:"none",borderRadius:14,color:weightSaved[weightDay]?W.dim:"#fff",fontSize:15,fontWeight:800,cursor:weightSaved[weightDay]?"default":"pointer",transition:"all .2s",letterSpacing:0.3,textTransform:"uppercase",boxShadow:weightSaved[weightDay]?"none":"0 2px 12px rgba(61,122,156,0.3)",opacity:weightSaved[weightDay]?0.6:1}}>
          {weightSaved[weightDay]?"‚úì Sparad":"Spara "+DN[weightDay]}
        </button>}
        {isLocked(tab)&&<button style={{width:"100%",padding:"16px",background:"#ffcc00",border:"none",borderRadius:14,color:"#111",fontSize:15,fontWeight:800,cursor:"pointer",letterSpacing:0.5,textTransform:"uppercase",boxShadow:"0 4px 16px rgba(0,0,0,0.2)"}}>
          Uppgradera paket
        </button>}
      </div>
    </div>}

    {/* Exercise info popup ‚Äî bottom sheet */}
    {exPopup&&(()=>{
      const exD=EX_DATA[exPopup];
      const exDb=EX_DB.find(e=>e.name===exPopup);
      const mCol=exDb?MC[exDb.muscle]:T.dim;
      const mName=exDb?.muscle||"";
      const exIcon={"Brost":"üèãÔ∏è","Rygg":"üßó","Axlar":"üèãÔ∏è","Ben":"ü¶µ","Biceps":"üí™","Triceps":"üí™","Mage":"üî•"}[mName]||"üèãÔ∏è";
      const popImg=EX_IMG[exPopup];
      const popCrop=EX_CROP[exPopup]||"center";
      return <div onClick={()=>setExPopup(null)} style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.88)",zIndex:200,display:"flex",alignItems:"flex-end",justifyContent:"center",animation:"exPopFadeIn .15s ease"}}>
        <div onClick={e=>e.stopPropagation()} style={{background:T.bg,borderRadius:"20px 20px 0 0",width:"100%",maxWidth:430,maxHeight:"85vh",overflowY:"auto",animation:"exPopSlideUp .25s ease",paddingBottom:"env(safe-area-inset-bottom,20px)"}}>
          {/* Handle */}
          <div style={{width:36,height:4,borderRadius:2,background:"rgba(255,255,255,0.15)",margin:"10px auto 0"}}/>
          {/* Image */}
          <div style={{margin:16,height:300,borderRadius:16,overflow:"hidden",border:"1px solid rgba(255,255,255,0.06)",background:popImg?"#222":`linear-gradient(135deg,${mCol}20,${mCol}08)`,display:"flex",alignItems:"center",justifyContent:"center"}}>
            {popImg?<img src={popImg} alt={exPopup} style={{width:"100%",height:"100%",objectFit:"cover",objectPosition:popCrop}} onError={e=>{e.target.style.display="none";const s=document.createElement("span");s.textContent=exIcon;s.style.fontSize="64px";s.style.opacity="0.5";e.target.parentNode.appendChild(s)}}/>
            :<span style={{fontSize:64,opacity:0.5}}>{exIcon}</span>}
          </div>
          {/* Content */}
          <div style={{padding:"0 20px 24px"}}>
            <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:10}}>
              <span style={{fontSize:18,fontWeight:800}}>{exPopup}</span>
              <span style={{fontSize:9,padding:"3px 8px",borderRadius:6,fontWeight:700,background:mCol+"18",color:mCol}}>{mName}</span>
            </div>
            {exD&&<>
              <div style={{fontSize:13,color:"rgba(255,255,255,0.55)",lineHeight:1.65,marginBottom:12}}>{exD.desc}</div>
              <div style={{padding:"10px 14px",background:"rgba(57,255,20,0.03)",border:"1px solid rgba(57,255,20,0.07)",borderRadius:12}}>
                <div style={{fontSize:11,color:T.acc,lineHeight:1.5}}>üí° {exD.tip}</div>
              </div>
            </>}
          </div>
        </div>
        <style>{`
          @keyframes exPopFadeIn{from{opacity:0}to{opacity:1}}
          @keyframes exPopSlideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
        `}</style>
      </div>;
    })()}

    {/* NAV ‚Äî z:90, ALWAYS visible, nothing can cover it */}
    <div style={{position:"fixed",bottom:0,left:0,right:0,zIndex:95,background:locked?LK.abg:isCheckin?CI.hdr:isFood?"rgba(245,239,228,0.96)":isWeight?"rgba(232,240,246,0.96)":"rgba(26,26,26,0.95)",backdropFilter:"blur(20px)",borderTop:"1px solid "+(locked||isCheckin?"rgba(255,255,255,0.12)":isFood?"rgba(180,150,100,0.2)":isWeight?W.brd:T.brd)}}>
      <div style={{display:"flex",maxWidth:420,width:"100%",margin:"0 auto"}}>
        {TABS.map(([id,label,icon])=>{const isFoodTab=id==="food";const isWTab=id==="weight";const isCITab=id==="checkin";const active=tab===id;const locked=isLocked(id);return <button key={id} onClick={()=>{if(id!==tab){setTabFade(true);setTimeout(()=>{setTab(id);setTabFade(false)},120)}}} style={{flex:1,padding:"10px 4px",background:"none",border:"none",cursor:"pointer",display:"flex",flexDirection:"column",alignItems:"center",gap:2,opacity:locked?0.5:1}}>
          <span style={{fontSize:18,position:"relative"}}>{icon}{locked&&<span style={{position:"absolute",top:-4,right:-8,fontSize:9}}>üîí</span>}</span>
          <span style={{fontSize:9,fontWeight:700,color:active?(isFoodTab?"#b8860b":isWTab?W.acc:isCITab?"#ffcc00":T.acc):(isFood?"#9a8b78":isWeight?W.mut:isCheckin?CI.mut:T.mut)}}>{label}</span>
        </button>})}
      </div>
    </div>
  </div>;
}

// ===================== SOLO GENERATORS =====================
function generateSoloProgram(form){
  const{split,level,goal,gender}=form;
  const isNew=level==="Nyb√∂rjare";
  const isAdv=level==="Avancerad";
  const isF=gender==="Kvinna";
  const s=isNew?2:isAdv?4:3;
  const rH=isNew?"12-15":goal==="build"?"6-8":"10-12";
  const rM=isNew?"12-15":goal==="build"?"8-10":"12";
  const rL=isNew?"15":goal==="build"?"10-12":"15";
  
  // NYB√ñRJARE
  if(isNew){
    const tpls=isF?{
      "2D":[
        {name:"Helkropp A",ex:[{n:"Hip Thrust",s:2,r:"12-15",m:"Ben"},{n:"Benpress",s:2,r:"12-15",m:"Ben"},{n:"Latsdrag",s:2,r:"12-15",m:"Rygg"},{n:"Cable Crunch",s:2,r:"15",m:"Mage"}]},
        {name:"Helkropp B",ex:[{n:"Bencurl",s:2,r:"12-15",m:"Ben"},{n:"Benextension",s:2,r:"12-15",m:"Ben"},{n:"Maskin Brostpress",s:2,r:"12-15",m:"Brost"},{n:"Sidolyft",s:2,r:"15",m:"Axlar"}]}
      ],
      "3D":[
        {name:"Underkropp",ex:[{n:"Hip Thrust",s:2,r:"12-15",m:"Ben"},{n:"Benpress",s:2,r:"12-15",m:"Ben"},{n:"Bencurl",s:2,r:"12-15",m:"Ben"},{n:"Vadpress",s:2,r:"15-20",m:"Ben"}]},
        {name:"√ñverkropp",ex:[{n:"Latsdrag",s:2,r:"12-15",m:"Rygg"},{n:"Maskin Brostpress",s:2,r:"12-15",m:"Brost"},{n:"Sidolyft",s:2,r:"15",m:"Axlar"},{n:"Tricep Pushdown",s:2,r:"15",m:"Triceps"}]},
        {name:"Glutes & Mage",ex:[{n:"Hip Thrust",s:2,r:"12-15",m:"Ben"},{n:"Utfall",s:2,r:"12/ben",m:"Ben"},{n:"Cable Crunch",s:2,r:"15",m:"Mage"},{n:"Hanging Leg Raise",s:2,r:"12-15",m:"Mage"}]}
      ],
      "4D":[
        {name:"Underkropp A",ex:[{n:"Hip Thrust",s:2,r:"12-15",m:"Ben"},{n:"Benpress",s:2,r:"12-15",m:"Ben"},{n:"Bencurl",s:2,r:"12-15",m:"Ben"}]},
        {name:"√ñverkropp A",ex:[{n:"Latsdrag",s:2,r:"12-15",m:"Rygg"},{n:"Maskin Brostpress",s:2,r:"12-15",m:"Brost"},{n:"Sidolyft",s:2,r:"15",m:"Axlar"}]},
        {name:"Underkropp B",ex:[{n:"Utfall",s:2,r:"12/ben",m:"Ben"},{n:"Benextension",s:2,r:"12-15",m:"Ben"},{n:"Vadpress",s:2,r:"15-20",m:"Ben"}]},
        {name:"√ñverkropp B",ex:[{n:"Sittande kabelrodd",s:2,r:"12-15",m:"Rygg"},{n:"Cable Fly",s:2,r:"15",m:"Brost"},{n:"Kabelcurl",s:2,r:"15",m:"Biceps"},{n:"Cable Crunch",s:2,r:"15",m:"Mage"}]}
      ],
      "5D":[
        {name:"Glutes",ex:[{n:"Hip Thrust",s:2,r:"12-15",m:"Ben"},{n:"Utfall",s:2,r:"12/ben",m:"Ben"},{n:"Cable Crunch",s:2,r:"15",m:"Mage"}]},
        {name:"√ñverkropp A",ex:[{n:"Latsdrag",s:2,r:"12-15",m:"Rygg"},{n:"Maskin Brostpress",s:2,r:"12-15",m:"Brost"},{n:"Sidolyft",s:2,r:"15",m:"Axlar"}]},
        {name:"Ben",ex:[{n:"Benpress",s:2,r:"12-15",m:"Ben"},{n:"Bencurl",s:2,r:"12-15",m:"Ben"},{n:"Benextension",s:2,r:"12-15",m:"Ben"}]},
        {name:"√ñverkropp B",ex:[{n:"Sittande kabelrodd",s:2,r:"12-15",m:"Rygg"},{n:"Cable Fly",s:2,r:"15",m:"Brost"},{n:"Tricep Pushdown",s:2,r:"15",m:"Triceps"}]},
        {name:"Glutes & Mage",ex:[{n:"Hip Thrust",s:2,r:"12-15",m:"Ben"},{n:"Vadpress",s:2,r:"15-20",m:"Ben"},{n:"Hanging Leg Raise",s:2,r:"12-15",m:"Mage"}]}
      ]
    }:{
      "2D":[
        {name:"Helkropp A",ex:[{n:"Benpress",s:2,r:"12-15",m:"Ben"},{n:"Maskin Brostpress",s:2,r:"12-15",m:"Brost"},{n:"Latsdrag",s:2,r:"12-15",m:"Rygg"}]},
        {name:"Helkropp B",ex:[{n:"Bencurl",s:2,r:"12-15",m:"Ben"},{n:"Sittande kabelrodd",s:2,r:"12-15",m:"Rygg"},{n:"Sidolyft",s:2,r:"15",m:"Axlar"},{n:"Kabelcurl",s:2,r:"15",m:"Biceps"}]}
      ],
      "3D":[
        {name:"Push",ex:[{n:"Maskin Brostpress",s:2,r:"12-15",m:"Brost"},{n:"Sidolyft",s:2,r:"15",m:"Axlar"},{n:"Tricep Pushdown",s:2,r:"15",m:"Triceps"}]},
        {name:"Pull",ex:[{n:"Latsdrag",s:2,r:"12-15",m:"Rygg"},{n:"Sittande kabelrodd",s:2,r:"12-15",m:"Rygg"},{n:"Kabelcurl",s:2,r:"15",m:"Biceps"}]},
        {name:"Ben",ex:[{n:"Benpress",s:2,r:"12-15",m:"Ben"},{n:"Bencurl",s:2,r:"12-15",m:"Ben"},{n:"Benextension",s:2,r:"12-15",m:"Ben"},{n:"Vadpress",s:2,r:"15-20",m:"Ben"}]}
      ],
      "4D":[
        {name:"√ñverkropp A",ex:[{n:"Maskin Brostpress",s:2,r:"12-15",m:"Brost"},{n:"Latsdrag",s:2,r:"12-15",m:"Rygg"},{n:"Sidolyft",s:2,r:"15",m:"Axlar"}]},
        {name:"Underkropp A",ex:[{n:"Benpress",s:2,r:"12-15",m:"Ben"},{n:"Bencurl",s:2,r:"12-15",m:"Ben"},{n:"Benextension",s:2,r:"12-15",m:"Ben"}]},
        {name:"√ñverkropp B",ex:[{n:"Sittande kabelrodd",s:2,r:"12-15",m:"Rygg"},{n:"Cable Fly",s:2,r:"15",m:"Brost"},{n:"Tricep Pushdown",s:2,r:"15",m:"Triceps"},{n:"Kabelcurl",s:2,r:"15",m:"Biceps"}]},
        {name:"Underkropp B",ex:[{n:"Hip Thrust",s:2,r:"12-15",m:"Ben"},{n:"Utfall",s:2,r:"12/ben",m:"Ben"},{n:"Vadpress",s:2,r:"15-20",m:"Ben"}]}
      ],
      "5D":[
        {name:"Br√∂st & Triceps",ex:[{n:"Maskin Brostpress",s:2,r:"12-15",m:"Brost"},{n:"Cable Fly",s:2,r:"15",m:"Brost"},{n:"Tricep Pushdown",s:2,r:"15",m:"Triceps"}]},
        {name:"Rygg & Biceps",ex:[{n:"Latsdrag",s:2,r:"12-15",m:"Rygg"},{n:"Sittande kabelrodd",s:2,r:"12-15",m:"Rygg"},{n:"Kabelcurl",s:2,r:"15",m:"Biceps"}]},
        {name:"Axlar & Mage",ex:[{n:"Sidolyft",s:2,r:"15",m:"Axlar"},{n:"Rear Delt Fly",s:2,r:"15",m:"Axlar"},{n:"Cable Crunch",s:2,r:"15",m:"Mage"}]},
        {name:"Ben A",ex:[{n:"Benpress",s:2,r:"12-15",m:"Ben"},{n:"Bencurl",s:2,r:"12-15",m:"Ben"},{n:"Benextension",s:2,r:"12-15",m:"Ben"}]},
        {name:"Ben B & Mage",ex:[{n:"Hip Thrust",s:2,r:"12-15",m:"Ben"},{n:"Utfall",s:2,r:"12/ben",m:"Ben"},{n:"Hanging Leg Raise",s:2,r:"12-15",m:"Mage"}]}
      ]
    };
    return tpls[split]||tpls["3D"];
  }
  
  // MEDEL / AVANCERAD
  const tpls=isF?{
    "2D":[
      {name:"Helkropp A",ex:[{n:"Hip Thrust",s,r:rH,m:"Ben"},{n:"Knaboej",s,r:rH,m:"Ben"},{n:"Latsdrag",s,r:rM,m:"Rygg"},{n:"Sidolyft",s:3,r:rL,m:"Axlar"},{n:"Cable Crunch",s:3,r:rL,m:"Mage"}]},
      {name:"Helkropp B",ex:[{n:"Rumansk marklyft",s,r:rH,m:"Ben"},{n:"Maskin Brostpress",s,r:rM,m:"Brost"},{n:"Sittande kabelrodd",s,r:rM,m:"Rygg"},{n:"Face Pull",s:3,r:rL,m:"Axlar"}]}
    ],
    "3D":[
      {name:"Underkropp",ex:[{n:"Hip Thrust",s,r:rH,m:"Ben"},{n:"Knaboej",s,r:rH,m:"Ben"},{n:"Rumansk marklyft",s,r:rM,m:"Ben"},{n:"Bencurl",s:3,r:rM,m:"Ben"},{n:"Vadpress",s:3,r:rL,m:"Ben"}]},
      {name:"√ñverkropp",ex:[{n:"Latsdrag",s,r:rM,m:"Rygg"},{n:"Sittande kabelrodd",s,r:rM,m:"Rygg"},{n:"Maskin Brostpress",s,r:rM,m:"Brost"},{n:"Sidolyft",s:3,r:rL,m:"Axlar"},{n:"Tricep Pushdown",s:3,r:rM,m:"Triceps"}]},
      {name:"Glutes & Mage",ex:[{n:"Hip Thrust",s,r:rM,m:"Ben"},{n:"Utfall",s:3,r:"12/ben",m:"Ben"},{n:"Benextension",s:3,r:rM,m:"Ben"},{n:"Cable Crunch",s:3,r:rL,m:"Mage"},{n:"Hanging Leg Raise",s:3,r:rL,m:"Mage"}]}
    ],
    "4D":[
      {name:"Underkropp A",ex:[{n:"Hip Thrust",s,r:rH,m:"Ben"},{n:"Knaboej",s,r:rH,m:"Ben"},{n:"Bencurl",s:3,r:rM,m:"Ben"},{n:"Vadpress",s:3,r:rL,m:"Ben"}]},
      {name:"√ñverkropp A",ex:[{n:"Latsdrag",s,r:rM,m:"Rygg"},{n:"Maskin Brostpress",s,r:rM,m:"Brost"},{n:"Militarpress",s,r:rM,m:"Axlar"},{n:"Cable Crunch",s:3,r:rL,m:"Mage"}]},
      {name:"Underkropp B",ex:[{n:"Rumansk marklyft",s,r:rH,m:"Ben"},{n:"Utfall",s:3,r:"12/ben",m:"Ben"},{n:"Benextension",s:3,r:rM,m:"Ben"},{n:"Hip Thrust",s:3,r:rM,m:"Ben"}]},
      {name:"√ñverkropp B",ex:[{n:"Sittande kabelrodd",s,r:rM,m:"Rygg"},{n:"Cable Fly",s:3,r:rM,m:"Brost"},{n:"Sidolyft",s:3,r:rL,m:"Axlar"},{n:"Skivstangscurl",s:3,r:rM,m:"Biceps"}]}
    ],
    "5D":[
      {name:"Glutes",ex:[{n:"Hip Thrust",s,r:rH,m:"Ben"},{n:"Utfall",s,r:"12/ben",m:"Ben"},{n:"Cable Crunch",s:3,r:rL,m:"Mage"},{n:"Russian Twist",s:3,r:rL,m:"Mage"}]},
      {name:"√ñverkropp Push",ex:[{n:"Maskin Brostpress",s,r:rM,m:"Brost"},{n:"Militarpress",s,r:rM,m:"Axlar"},{n:"Sidolyft",s:3,r:rL,m:"Axlar"},{n:"Tricep Pushdown",s:3,r:rM,m:"Triceps"}]},
      {name:"Ben",ex:[{n:"Knaboej",s,r:rH,m:"Ben"},{n:"Rumansk marklyft",s,r:rM,m:"Ben"},{n:"Benpress",s:3,r:rM,m:"Ben"},{n:"Bencurl",s:3,r:rM,m:"Ben"},{n:"Vadpress",s:3,r:rL,m:"Ben"}]},
      {name:"√ñverkropp Pull",ex:[{n:"Latsdrag",s,r:rM,m:"Rygg"},{n:"Sittande kabelrodd",s,r:rM,m:"Rygg"},{n:"Face Pull",s:3,r:rL,m:"Axlar"},{n:"Skivstangscurl",s:3,r:rM,m:"Biceps"}]},
      {name:"Glutes & Mage",ex:[{n:"Hip Thrust",s,r:rM,m:"Ben"},{n:"Utfall",s:3,r:"12/ben",m:"Ben"},{n:"Hanging Leg Raise",s:3,r:rL,m:"Mage"},{n:"Woodchop",s:3,r:rL,m:"Mage"}]}
    ]
  }:{
    "2D":[
      {name:"Helkropp A",ex:[{n:"Knaboej",s,r:rH,m:"Ben"},{n:"Bankpress",s,r:rH,m:"Brost"},{n:"Latsdrag",s,r:rM,m:"Rygg"},{n:"Sidolyft",s:3,r:rL,m:"Axlar"}]},
      {name:"Helkropp B",ex:[{n:"Rumansk marklyft",s,r:rH,m:"Ben"},{n:"Hantelpress lutande",s,r:rM,m:"Brost"},{n:"Sittande kabelrodd",s,r:rM,m:"Rygg"},{n:"Face Pull",s:3,r:rL,m:"Axlar"}]}
    ],
    "3D":[
      {name:"Push",ex:[{n:"Bankpress",s,r:rH,m:"Brost"},{n:"Hantelpress lutande",s:3,r:rM,m:"Brost"},{n:"Militarpress",s,r:rM,m:"Axlar"},{n:"Sidolyft",s:3,r:rL,m:"Axlar"},{n:"Tricep Pushdown",s:3,r:rM,m:"Triceps"}]},
      {name:"Pull",ex:[{n:"Latsdrag",s,r:rH,m:"Rygg"},{n:"Sittande kabelrodd",s,r:rM,m:"Rygg"},{n:"Face Pull",s:3,r:rL,m:"Axlar"},{n:"Skivstangscurl",s:3,r:rM,m:"Biceps"},{n:"Hammarcurl",s:2,r:rM,m:"Biceps"}]},
      {name:"Ben",ex:[{n:"Knaboej",s,r:rH,m:"Ben"},{n:"Rumansk marklyft",s,r:rM,m:"Ben"},{n:"Benpress",s:3,r:rM,m:"Ben"},{n:"Bencurl",s:3,r:rM,m:"Ben"},{n:"Vadpress",s:3,r:rL,m:"Ben"}]}
    ],
    "4D":[
      {name:"√ñverkropp A",ex:[{n:"Bankpress",s,r:rH,m:"Brost"},{n:"Skivstangsrodd",s,r:rH,m:"Rygg"},{n:"Militarpress",s,r:rM,m:"Axlar"},{n:"Tricep Pushdown",s:3,r:rM,m:"Triceps"}]},
      {name:"Underkropp A",ex:[{n:"Knaboej",s,r:rH,m:"Ben"},{n:"Rumansk marklyft",s,r:rM,m:"Ben"},{n:"Benpress",s:3,r:rM,m:"Ben"},{n:"Bencurl",s:3,r:rM,m:"Ben"}]},
      {name:"√ñverkropp B",ex:[{n:"Hantelpress lutande",s,r:rM,m:"Brost"},{n:"Latsdrag",s,r:rM,m:"Rygg"},{n:"Sidolyft",s:3,r:rL,m:"Axlar"},{n:"Skivstangscurl",s:3,r:rM,m:"Biceps"}]},
      {name:"Underkropp B",ex:[{n:"Hip Thrust",s,r:rM,m:"Ben"},{n:"Utfall",s:3,r:"12/ben",m:"Ben"},{n:"Benextension",s:3,r:rM,m:"Ben"},{n:"Vadpress",s:3,r:rL,m:"Ben"}]}
    ],
    "5D":[
      {name:"Br√∂st",ex:[{n:"Bankpress",s,r:rH,m:"Brost"},{n:"Hantelpress lutande",s,r:rM,m:"Brost"},{n:"Cable Fly",s:3,r:rM,m:"Brost"},{n:"Dips",s:3,r:rL,m:"Brost"}]},
      {name:"Rygg",ex:[{n:"Marklyft",s,r:"5-6",m:"Rygg"},{n:"Latsdrag",s,r:rM,m:"Rygg"},{n:"Sittande kabelrodd",s,r:rM,m:"Rygg"},{n:"Face Pull",s:3,r:rL,m:"Axlar"}]},
      {name:"Axlar",ex:[{n:"Militarpress",s,r:rH,m:"Axlar"},{n:"Sidolyft",s:3,r:rL,m:"Axlar"},{n:"Rear Delt Fly",s:3,r:rL,m:"Axlar"},{n:"Tricep Pushdown",s:3,r:rM,m:"Triceps"}]},
      {name:"Ben",ex:[{n:"Knaboej",s,r:rH,m:"Ben"},{n:"Rumansk marklyft",s,r:rM,m:"Ben"},{n:"Benpress",s:3,r:rM,m:"Ben"},{n:"Bencurl",s:3,r:rM,m:"Ben"},{n:"Vadpress",s:3,r:rL,m:"Ben"}]},
      {name:"Bi/Tri & Mage",ex:[{n:"Skivstangscurl",s,r:rM,m:"Biceps"},{n:"Hammarcurl",s:3,r:rM,m:"Biceps"},{n:"Tricep Pushdown",s:3,r:rM,m:"Triceps"},{n:"Skullcrusher",s:3,r:rM,m:"Triceps"},{n:"Cable Crunch",s:3,r:rL,m:"Mage"}]}
    ]
  };
  return tpls[split]||tpls["3D"];
}

function generateSoloMeals(form){
  const{goal,curW,height,age,gender,activity}=form;
  // Calculate BMR (Mifflin-St Jeor)
  const bmr=gender==="Man"?(10*curW+6.25*height-5*age+5):(10*curW+6.25*height-5*age-161);
  const tdee=Math.round(bmr*(parseFloat(activity)||1.55));
  const kcal=goal==="lose"?tdee-400:goal==="build"?tdee+300:tdee;
  // Macro split: 30/40/30 lose, 25/45/30 build, 30/40/30 maintain
  const pPct=goal==="build"?0.25:0.30;
  const cPct=goal==="build"?0.45:0.40;
  const fPct=0.30;
  const macros={p:Math.round((kcal*pPct)/4),c:Math.round((kcal*cPct)/4),f:Math.round((kcal*fPct)/9)};
  // Meal distribution: frukost 25%, lunch 35%, middag 40%
  const frK=Math.round(kcal*0.25),luK=Math.round(kcal*0.35),miK=Math.round(kcal*0.40);
  const DB=[
    // FRUKOST pool
    {slot:"Frukost",r:"Havregrynsgr√∂t med b√§r",kcal:frK,p:Math.round(macros.p*0.2),c:Math.round(macros.c*0.3),f:Math.round(macros.f*0.15),
      ingredients:["80g havregryn","2dl mj√∂lk","1 msk honung","100g frysta bl√•b√§r"],
      steps:["Koka havregryn med mj√∂lk i 3 min.","Toppa med bl√•b√§r och honung."]},
    {slot:"Frukost",r:"Kvarg med granola",kcal:frK,p:Math.round(macros.p*0.25),c:Math.round(macros.c*0.25),f:Math.round(macros.f*0.1),
      ingredients:["250g kvarg","50g granola","1 banan"],
      steps:["H√§ll kvarg i sk√•l.","Toppa med granola och skivad banan."]},
    {slot:"Frukost",r:"√Ñggr√∂ra med br√∂d",kcal:frK,p:Math.round(macros.p*0.22),c:Math.round(macros.c*0.2),f:Math.round(macros.f*0.25),
      ingredients:["3 √§gg","2 skivor fullkornsbr√∂d","1 msk sm√∂r"],
      steps:["Sm√§lt sm√∂r, vispa √§gg och stek mjukt.","Rosta br√∂d. Servera."]},
    {slot:"Frukost",r:"Smoothie med proteinpulver",kcal:frK,p:Math.round(macros.p*0.25),c:Math.round(macros.c*0.3),f:Math.round(macros.f*0.1),
      ingredients:["1 banan","150g frysta hallon","1dl mj√∂lk","1 scoop proteinpulver"],
      steps:["Mixa allt i blender. Servera direkt."]},
    {slot:"Frukost",r:"Yoghurt med n√∂tter och honung",kcal:frK,p:Math.round(macros.p*0.2),c:Math.round(macros.c*0.25),f:Math.round(macros.f*0.2),
      ingredients:["200g turkisk yoghurt","30g valn√∂tter","1 msk honung"],
      steps:["H√§ll yoghurt i sk√•l. Toppa med n√∂tter och honung."]},
    // LUNCH pool
    {slot:"Lunch",r:"Kyckling med ris och gr√∂nsaker",kcal:luK,p:Math.round(macros.p*0.35),c:Math.round(macros.c*0.35),f:Math.round(macros.f*0.25),
      ingredients:["200g kycklingfil√©","150g ris","100g broccoli","1 msk olivolja"],
      steps:["Koka ris.","Stek kyckling i olja 5 min per sida.","√Öng broccoli 3 min."]},
    {slot:"Lunch",r:"Lax med potatis och sparris",kcal:luK,p:Math.round(macros.p*0.30),c:Math.round(macros.c*0.30),f:Math.round(macros.f*0.30),
      ingredients:["200g laxfil√©","300g potatis","100g sparris","1 msk olivolja"],
      steps:["Ugn 200¬∞C. L√§gg lax och potatis p√• pl√•t.","Ringla olja. Baka 20 min.","Tills√§tt sparris sista 8 min."]},
    {slot:"Lunch",r:"Pasta med k√∂ttf√§rss√•s",kcal:luK,p:Math.round(macros.p*0.30),c:Math.round(macros.c*0.40),f:Math.round(macros.f*0.25),
      ingredients:["120g pasta","200g k√∂ttf√§rs","1 burk krossade tomater","1 l√∂k"],
      steps:["Koka pasta.","Fr√§s l√∂k, bryn f√§rs, tills√§tt tomater.","Sjud 15 min."]},
    {slot:"Lunch",r:"Halloumi-sallad med avokado",kcal:luK,p:Math.round(macros.p*0.25),c:Math.round(macros.c*0.25),f:Math.round(macros.f*0.35),
      ingredients:["200g halloumi","150g sallad","1 avokado","10 k√∂rsb√§rstomater"],
      steps:["Stek halloumi gyllene.","Blanda sallad, tomat, avokado.","Toppa med halloumi."]},
    {slot:"Lunch",r:"K√∂ttbullar med mos",kcal:luK,p:Math.round(macros.p*0.30),c:Math.round(macros.c*0.35),f:Math.round(macros.f*0.30),
      ingredients:["300g k√∂ttf√§rs","1 √§gg","3 msk str√∂br√∂d","400g potatis","1dl mj√∂lk"],
      steps:["Blanda f√§rs, √§gg, str√∂br√∂d. Rulla bullar.","Stek 8 min.","Koka och mosa potatis med mj√∂lk."]},
    // MIDDAG pool
    {slot:"Middag",r:"Kycklingwok med nudlar",kcal:miK,p:Math.round(macros.p*0.35),c:Math.round(macros.c*0.35),f:Math.round(macros.f*0.25),
      ingredients:["250g kycklingfil√©","150g √§ggnudlar","100g broccoli","2 msk sojas√•s"],
      steps:["Koka nudlar.","Stek kyckling i bitar 4 min.","Tills√§tt broccoli och soja. Stek 3 min."]},
    {slot:"Middag",r:"Omelett med gr√∂nsaker och ost",kcal:miK,p:Math.round(macros.p*0.25),c:Math.round(macros.c*0.15),f:Math.round(macros.f*0.40),
      ingredients:["4 √§gg","50g ost","50g spenat","1 tomat","1 msk sm√∂r"],
      steps:["Vispa √§ggen.","Sm√§lt sm√∂r, h√§ll i √§gg.","L√§gg p√• spenat, tomat, ost. Vik ihop."]},
    {slot:"Middag",r:"Stekt lax med ris",kcal:miK,p:Math.round(macros.p*0.35),c:Math.round(macros.c*0.30),f:Math.round(macros.f*0.30),
      ingredients:["200g laxfil√©","150g jasminris","100g socker√§rtor","2 msk sojas√•s"],
      steps:["Koka ris.","Stek lax 3 min per sida.","Fr√§s socker√§rtor med soja."]},
    {slot:"Middag",r:"Tacos med kycklingf√§rs",kcal:miK,p:Math.round(macros.p*0.30),c:Math.round(macros.c*0.30),f:Math.round(macros.f*0.30),
      ingredients:["250g kycklingf√§rs","4 tortillas","100g sallad","1 tomat","50g ost"],
      steps:["Bryn kycklingf√§rs med tacokrydda.","V√§rm tortillas.","Fyll med f√§rs, sallad, tomat, ost."]},
    {slot:"Middag",r:"Pannbiff med stekt potatis",kcal:miK,p:Math.round(macros.p*0.30),c:Math.round(macros.c*0.35),f:Math.round(macros.f*0.30),
      ingredients:["300g k√∂ttf√§rs","1 √§gg","300g potatis","1 l√∂k","1 msk sm√∂r"],
      steps:["Blanda f√§rs och √§gg, forma biffar.","Stek 4 min per sida.","Sk√§r och stek potatis gyllene."]}
  ];
  const bySlot={Frukost:DB.filter(m=>m.slot==="Frukost"),Lunch:DB.filter(m=>m.slot==="Lunch"),Middag:DB.filter(m=>m.slot==="Middag")};
  const DN=["M√•n","Tis","Ons","Tor","Fre","L√∂r","S√∂n"];
  // Pick varied meals across week (no back-to-back repeats)
  function pick(pool,count){
    const r=[];let last=-1;
    for(let i=0;i<count;i++){
      let idx=(i*2)%pool.length;
      if(idx===last)idx=(idx+1)%pool.length;
      r.push({...pool[idx]});last=idx;
    }
    return r;
  }
  const fruks=pick(bySlot.Frukost,7);
  const lunchs=pick(bySlot.Lunch,7);
  const middags=pick(bySlot.Middag,7);
  return {
    macros,kcal,
    plan:DN.map((d,i)=>({name:d,meals:[fruks[i],lunchs[i],middags[i]]}))
  };
}

// ===================== SOLO ONBOARDING =====================
function SoloOnboarding({onDone}){
  const [step,setStep]=useState(0);
  const [form,setForm]=useState({name:"",gender:"",goal:"build",level:"Medel",split:"3D"});
  const [generating,setGenerating]=useState(false);
  const [genStep,setGenStep]=useState(0);
  const upd=(k,v)=>setForm(p=>({...p,[k]:v}));
  
  const canNext=step===0?form.name.length>=2&&form.gender:true;
  const next=()=>{if(step===0&&canNext)setStep(1);else if(step===1)doGenerate()};
  
  function doGenerate(){
    setGenerating(true);setGenStep(0);
    let i=0;
    const iv=setInterval(()=>{i++;setGenStep(i);if(i>=3){clearInterval(iv);
      setTimeout(()=>{
        const prog=generateSoloProgram(form);
        const client={
          id:"solo",name:form.name,gender:form.gender,age:25,height:175,
          startW:75,curW:75,goal:form.goal,level:form.level,split:form.split,
          status:"active",diet:"Inga",notes:"Solo",activity:"1.55",
          wkT:2,wkC:1,form:true,macros:{p:0,c:0,f:0},wIns:[],prs:[],logs:[],mLogs:[],cardio:[],
          hoursLeft:0,nextReviewIn:0,plan:"full",
          program:prog,mealPlan:[],weeklyLogs:[],weeklyMacros:[],
          _soloForm:form
        };
        onDone(client);
      },300);
    }},600);
  }
  
  const Seg=({options,value,onChange,columns=options.length})=>(
    <div style={{display:"grid",gridTemplateColumns:`repeat(${columns},1fr)`,gap:8}}>
      {options.map(o=>{
        const v=typeof o==="string"?o:o.value;
        const label=typeof o==="string"?o:o.label;
        const desc=typeof o==="object"?o.desc:null;
        const active=value===v;
        return <button key={v} onClick={()=>onChange(v)} style={{padding:desc?"14px 12px":"12px",background:active?T.acc+"18":"rgba(255,255,255,0.03)",border:"2px solid "+(active?T.acc:"rgba(255,255,255,0.06)"),borderRadius:14,color:active?T.acc:T.dim,fontSize:14,fontWeight:700,cursor:"pointer",fontFamily:T.f,transition:"all .15s",display:"flex",flexDirection:"column",alignItems:"center",gap:4}}>
          <span>{label}</span>
          {desc&&<span style={{fontSize:10,color:active?T.acc+"99":T.mut,fontWeight:500}}>{desc}</span>}
        </button>;
      })}
    </div>
  );
  
  const genLabels=["Analyserar m√•l...","V√§ljer √∂vningar...","Bygger ditt schema..."];
  
  if(generating) return <div style={{minHeight:"100vh",background:T.bg,display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",fontFamily:T.f,color:T.t,padding:24}}>
    <div style={{fontSize:48,marginBottom:24,animation:"flashPop .5s ease"}}>‚ö°</div>
    <div style={{fontSize:22,fontWeight:800,marginBottom:4}}>{form.name}, vi bygger ditt pass</div>
    <div style={{fontSize:13,color:T.dim,marginBottom:32}}>{genLabels[Math.min(genStep,genLabels.length-1)]}</div>
    <div style={{width:200,height:4,borderRadius:2,background:T.brd,overflow:"hidden"}}>
      <div style={{height:"100%",borderRadius:2,background:T.acc,width:((genStep+1)/genLabels.length)*100+"%",transition:"width .5s ease"}}/>
    </div>
    <style>{`@keyframes flashPop{0%{transform:scale(0.5);opacity:0}60%{transform:scale(1.15)}100%{transform:scale(1);opacity:1}}`}</style>
  </div>;
  
  return <div style={{minHeight:"100vh",background:T.bg,color:T.t,fontFamily:T.f,display:"flex",flexDirection:"column"}}>
    {/* Header */}
    <div style={{padding:"12px 16px",display:"flex",justifyContent:"space-between",alignItems:"center",borderBottom:"1px solid "+T.brd}}>
      <div style={{fontSize:17,fontWeight:800,letterSpacing:-1}}><span style={{color:T.acc}}>FIT</span><span style={{color:T.dim}}>BY</span><span>YOU</span></div>
      <span style={{fontSize:9,color:T.mut,padding:"2px 6px",borderRadius:4,background:"rgba(255,255,255,0.04)"}}>SOLO</span>
    </div>
    
    {/* Progress */}
    <div style={{display:"flex",justifyContent:"center",gap:8,padding:"16px 0 0"}}>
      {[0,1].map(i=><div key={i} style={{width:i===step?24:8,height:4,borderRadius:2,background:i<=step?T.acc:T.brd,transition:"all .3s"}}/>)}
    </div>
    
    {step===0?
    /* STEP 0: NAME + GENDER */
    <div key="name" style={{flex:1,display:"flex",flexDirection:"column",justifyContent:"center",padding:"32px 24px",animation:"fadeUp .25s ease"}}>
      <div style={{fontSize:32,fontWeight:800,lineHeight:1.15,marginBottom:6}}>V√§lkommen!</div>
      <div style={{fontSize:14,color:T.dim,marginBottom:32}}>Vi bygger ett tr√§ningsprogram √•t dig p√• under en minut.</div>
      <div style={{fontSize:12,color:T.mut,textTransform:"uppercase",letterSpacing:2,marginBottom:8}}>Vad heter du?</div>
      <input value={form.name} onChange={e=>upd("name",e.target.value)} placeholder="Ditt f√∂rnamn"
        onKeyDown={e=>{if(e.key==="Enter"&&canNext)next()}}
        autoFocus
        style={{width:"100%",padding:"16px",background:"rgba(255,255,255,0.04)",border:"2px solid "+(form.name.length>=2?T.acc:"rgba(255,255,255,0.08)"),borderRadius:14,color:T.t,fontSize:20,fontWeight:700,fontFamily:T.f,outline:"none",boxSizing:"border-box",transition:"border .2s"}}/>
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginTop:20}}>
        {[["Man","üôã‚Äç‚ôÇÔ∏è"],["Kvinna","üôã‚Äç‚ôÄÔ∏è"]].map(([v,icon])=><button key={v} onClick={()=>upd("gender",v)} style={{padding:"14px",background:form.gender===v?T.acc+"18":"rgba(255,255,255,0.03)",border:"2px solid "+(form.gender===v?T.acc:"rgba(255,255,255,0.06)"),borderRadius:14,color:form.gender===v?T.acc:T.dim,fontSize:15,fontWeight:700,cursor:"pointer",fontFamily:T.f,transition:"all .15s"}}>{icon} {v}</button>)}
      </div>
    </div>
    :
    /* STEP 1: FORM ‚Äî all on one scrollable page */
    <div key="form" style={{flex:1,padding:"24px 24px 0",overflowY:"auto",animation:"fadeUp .25s ease"}}>
      <div style={{fontSize:24,fontWeight:800,marginBottom:4}}>Bygga ditt pass, {form.name}</div>
      <div style={{fontSize:12,color:T.dim,marginBottom:28}}>Tre val ‚Äî sen k√∂r vi.</div>
      
      {/* Goal */}
      <div style={{fontSize:11,color:T.mut,textTransform:"uppercase",letterSpacing:2,marginBottom:10}}>M√•l</div>
      <Seg options={[
        {value:"lose",label:"üî• G√• ner",desc:"Tappa fett"},
        {value:"build",label:"üí™ Bygga",desc:"Mer muskler"},
        {value:"maintain",label:"‚öñÔ∏è H√•lla",desc:"Beh√•ll form"}
      ]} value={form.goal} onChange={v=>upd("goal",v)}/>
      
      {/* Level */}
      <div style={{fontSize:11,color:T.mut,textTransform:"uppercase",letterSpacing:2,marginTop:24,marginBottom:10}}>Erfarenhet</div>
      <Seg options={[
        {value:"Nyb√∂rjare",label:"üå± Ny"},
        {value:"Medel",label:"‚ö° Medel"},
        {value:"Avancerad",label:"üî• Van"}
      ]} value={form.level} onChange={v=>upd("level",v)}/>
      
      {/* Split */}
      <div style={{fontSize:11,color:T.mut,textTransform:"uppercase",letterSpacing:2,marginTop:24,marginBottom:10}}>Dagar per vecka</div>
      <Seg options={[
        {value:"2D",label:"2",desc:"Helkropp"},
        {value:"3D",label:"3",desc:"Push/Pull/Ben"},
        {value:"4D",label:"4",desc:"√ñver/Under"},
        {value:"5D",label:"5",desc:"Per muskel"}
      ]} value={form.split} onChange={v=>upd("split",v)}/>
      <div style={{height:24}}/>
    </div>
    }
    
    {/* Bottom CTA */}
    <div style={{padding:"16px 24px 32px",display:"flex",gap:12}}>
      {step>0&&<button onClick={()=>setStep(0)} style={{padding:"16px 24px",background:"rgba(255,255,255,0.04)",border:"1px solid "+T.brd,borderRadius:14,color:T.dim,fontSize:15,fontWeight:700,cursor:"pointer",fontFamily:T.f}}>‚Üê</button>}
      <button onClick={next} disabled={!canNext} style={{flex:1,padding:"16px",background:canNext?T.acc:"rgba(255,255,255,0.06)",border:"none",borderRadius:14,color:canNext?"#1a1a1a":T.mut,fontSize:15,fontWeight:800,cursor:canNext?"pointer":"default",fontFamily:T.f,letterSpacing:0.3,transition:"all .2s"}}>
        {step===0?"N√§sta ‚Üí":"‚ö° Generera mitt veckoschema"}
      </button>
    </div>
    
    <style>{`@keyframes fadeUp{0%{opacity:0;transform:translateY(12px)}100%{opacity:1;transform:translateY(0)}}`}</style>
  </div>;
}

// ===================== APP =====================
function App() {
  const [mode,setMode]=useState("pt"); // "pt" | "client" | "solo"
  const [clients,setClients]=useState(INIT_CL);
  const [view,setView]=useState("dashboard");
  const [selected,setSelected]=useState(null);
  const [panelOpen,setPanelOpen]=useState(true);
  const [templates,setTemplates]=useState(INIT_TPLS);
  const [tplGroups]=useState(["Favoriter","Standardmallar","Calisthenics","Kropstraning"]);
  const [overlay,setOverlay]=useState(null);
  const [loading,setLoading]=useState(null);
  const [demoPlan,setDemoPlan]=useState("train_only");
  const [soloClient,setSoloClient]=useState(null); // generated client data

  // Inject check animation keyframes
  useEffect(()=>{
    if(document.querySelector("[data-fby-check]"))return;
    const s=document.createElement("style");
    s.setAttribute("data-fby-check","1");
    s.textContent=`
@keyframes checkPop{0%{transform:scale(1)}20%{transform:scale(1.5)}40%{transform:scale(0.9)}60%{transform:scale(1.15)}80%{transform:scale(0.98)}100%{transform:scale(1)}}
@keyframes cardCheck{0%{background:rgba(255,255,255,0.7)}30%{background:rgba(90,110,58,0.18)}70%{background:rgba(90,110,58,0.18)}100%{background:rgba(90,110,58,0.06)}}
.meal-checking{animation:cardCheck .6s ease forwards}
.meal-checking .check-box{animation:checkPop .5s cubic-bezier(.34,1.56,.64,1) forwards}
.shop-checking{animation:cardCheck .6s ease forwards}
.shop-checking .check-box{animation:checkPop .5s cubic-bezier(.34,1.56,.64,1) forwards}`;
    document.head.appendChild(s);
  },[]);

  const handleClientSend=(data)=>{
    setClients(p=>p.map(c=>c.id==="c2"?{...c,message:data.msg,selfAssess:data.selfAssess,hoursLeft:18,status:"pending_review"}:c));
  };
  const clientUser=clients.find(c=>c.id==="c2");

  // Mode toggle component
  const ModeToggle=()=><div style={{position:"fixed",top:8,right:12,zIndex:99,display:"flex",gap:6,alignItems:"center"}}>
    {mode==="client"&&<div style={{display:"flex",borderRadius:8,overflow:"hidden",border:"1px solid "+T.brd,background:"rgba(26,26,26,0.9)",backdropFilter:"blur(12px)"}}>
      {[["full","Fullt"],["train_only","Tr√§ning"],["food_only","Kost"]].map(([v,label])=>
        <button key={v} onClick={()=>setDemoPlan(v)} style={{padding:"6px 10px",background:demoPlan===v?T.accD:"transparent",border:"none",color:demoPlan===v?T.acc:T.mut,fontSize:9,fontWeight:700,cursor:"pointer",fontFamily:T.f,transition:"all .15s"}}>{label}</button>
      )}
    </div>}
    <div style={{display:"flex",borderRadius:8,overflow:"hidden",border:"1px solid "+T.brd,background:"rgba(26,26,26,0.9)",backdropFilter:"blur(12px)"}}>
      <button onClick={()=>setMode("pt")} style={{padding:"6px 14px",background:mode==="pt"?T.accD:"transparent",border:"none",color:mode==="pt"?T.acc:T.mut,fontSize:10,fontWeight:700,cursor:"pointer",fontFamily:T.f,transition:"all .15s"}}>PT</button>
      <button onClick={()=>setMode("client")} style={{padding:"6px 14px",background:mode==="client"?T.accD:"transparent",border:"none",color:mode==="client"?T.acc:T.mut,fontSize:10,fontWeight:700,cursor:"pointer",fontFamily:T.f,transition:"all .15s"}}>Klient</button>
      <button onClick={()=>setMode("solo")} style={{padding:"6px 14px",background:mode==="solo"?T.accD:"transparent",border:"none",color:mode==="solo"?T.acc:T.mut,fontSize:10,fontWeight:700,cursor:"pointer",fontFamily:T.f,transition:"all .15s"}}>Solo</button>
    </div>
  </div>;

  if(mode==="solo"){
    if(!soloClient) return <div><ModeToggle/><SoloOnboarding onDone={c=>setSoloClient(c)}/></div>;
    return <div><ModeToggle/><ClientApp client={soloClient} demoPlan="full" isSolo onShuffle={()=>{
      const f=soloClient._soloForm||{goal:"build",level:"Medel",split:"3D"};
      const newProg=generateSoloProgram(f);
      setSoloClient(p=>({...p,program:newProg}));
    }}/></div>;
  }

  if(mode==="client") return <div>
    <ModeToggle/>
    <ClientApp client={clientUser} onSendWeek={handleClientSend} demoPlan={demoPlan}/>
  </div>;

  function openClient(c,type){setLoading({name:c.name,cb:()=>{setSelected(c);setView(type);setPanelOpen(true);setLoading(null);}});}
  function back(){setView("dashboard");setSelected(null);setPanelOpen(true);}

  function ptContent() {
    if(view==="dashboard") return <Dashboard clients={clients} onOpen={openClient}/>;
    if(view==="onboard"&&selected) return <OnboardingFlow client={selected} templates={templates} tplGroups={tplGroups} onDone={data=>{
      if(data.saveName){const nt={id:"u"+Date.now(),name:data.saveName,split:selected.split,cat:"Favoriter",used:1,days:data.days.map(d=>({name:d.name,ex:d.exercises.map(e=>({n:e.n,s:e.s,r:e.r,m:e.m}))}))};setTemplates(p=>[nt,...p]);}
      setClients(p=>p.map(c=>c.id===selected.id?{...c,status:"active",wkC:1,macros:{p:data.macros.p,c:data.macros.c,f:data.macros.f},nextReviewIn:168}:c));
      setOverlay(selected.name);
    }}/>;
    if(view==="review"&&selected) return <WeeklyReview client={selected} onSend={action=>{setClients(p=>p.map(c=>c.id===selected.id?{...c,status:"active",hoursLeft:0,nextReviewIn:168}:c));setOverlay(selected.name);}}/>;
    return null;
  }

  return <div style={{minHeight:"100vh",background:T.bg,color:T.t,fontFamily:T.f}}>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet"/>
    <ModeToggle/>
    {loading&&<LoadingOverlay name={loading.name} onDone={loading.cb}/>}
    {overlay&&<SendOverlay name={overlay} onDone={()=>{setOverlay(null);back()}}/>}
    <div style={{position:"sticky",top:0,zIndex:60,background:"rgba(26,26,26,0.92)",backdropFilter:"blur(20px)",borderBottom:"1px solid "+T.brd,padding:"9px 16px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
      <div style={{display:"flex",alignItems:"center",gap:10}}>
        {view!=="dashboard"&&<button onClick={back} style={{background:"none",border:"none",color:T.dim,cursor:"pointer",fontSize:18,padding:0,lineHeight:1}}>&larr;</button>}
        <div style={{fontSize:17,fontWeight:800,letterSpacing:-1}}><span style={{color:T.acc}}>FIT</span><span style={{color:T.dim}}>BY</span><span>YOU</span></div>
      </div>
      <span style={{fontSize:9,color:T.mut,padding:"2px 6px",borderRadius:4,background:"rgba(255,255,255,0.04)"}}>PT</span>
    </div>
    {view!=="dashboard"&&view!=="review"&&selected&&<ClientPanel client={selected} open={panelOpen} onToggle={()=>setPanelOpen(!panelOpen)}/>}
    {view==="review"?<div key={view+(selected?selected.id:"")} style={{animation:"fadeZoomIn .8s ease both"}}>
      <style>{`@keyframes fadeZoomIn { from { opacity:0; transform:scale(0.96); } to { opacity:1; transform:scale(1); } }
*::-webkit-scrollbar{width:4px;height:4px}
*::-webkit-scrollbar-track{background:transparent}
*::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:4px}
*::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.15)}
*{scrollbar-width:thin;scrollbar-color:rgba(255,255,255,0.08) transparent}`}</style>
      {ptContent()}
    </div>:<div key={view+(selected?selected.id:"")} style={{maxWidth:640,margin:"0 auto",padding:"40px 24px 80px",animation:view!=="dashboard"?"fadeZoomIn .8s ease both":"none"}}>
      <style>{`@keyframes fadeZoomIn { from { opacity:0; transform:scale(0.96); } to { opacity:1; transform:scale(1); } }
*::-webkit-scrollbar{width:4px;height:4px}
*::-webkit-scrollbar-track{background:transparent}
*::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.08);border-radius:4px}
*::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.15)}
*{scrollbar-width:thin;scrollbar-color:rgba(255,255,255,0.08) transparent}`}</style>
      {ptContent()}
    </div>}
  </div>;
}

const root = ReactDOM.createRoot(document.getElementById("root"));
root.render(React.createElement(App));

  </script>
</body>
</html>